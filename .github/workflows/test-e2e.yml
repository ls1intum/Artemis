name: E2E Tests

on:
  workflow_run:
    # Must match the name of build.yml workflow.
    workflows: ["Build"]
    types: [completed]

concurrency:
  group: |
    ${{
      github.event.workflow_run.head_branch && format('e2e-{0}', github.event.workflow_run.head_branch)
      || format('e2e-{0}', github.event.workflow_run.head_sha)
    }}
  cancel-in-progress: true

env:
  # This is the context of the status. It will be displayed in the GitHub Actions UI.
  STATUS_CONTEXT: "End-to-End (E2E) Tests"
  # This is the URL to make a request to the GitHub API to update the status of the workflow run.
  STATUSES_REQUEST_URL: "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.event.workflow_run.head_sha }}"
  # This is the URL to the workflow run in the GitHub Actions UI.
  TARGET_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

jobs:
  run-e2e:
    name: Run E2E Tests
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: [self-hosted, e2e-test]
    environment: playwright-e2e-tests
    timeout-minutes: 90
    env:
      ARTEMIS_ADMIN_PASSWORD: ${{ secrets.ARTEMIS_ADMIN_PASSWORD }}
      ARTEMIS_ADMIN_USERNAME: ${{ secrets.ARTEMIS_ADMIN_USERNAME }}
      PLAYWRIGHT_CREATE_USERS: ${{ vars.PLAYWRIGHT_CREATE_USERS }}
      PLAYWRIGHT_PASSWORD_TEMPLATE: ${{ vars.PLAYWRIGHT_PASSWORD_TEMPLATE }}
      PLAYWRIGHT_USERNAME_TEMPLATE: ${{ vars.PLAYWRIGHT_USERNAME_TEMPLATE }}
      SLOW_TEST_TIMEOUT_SECONDS: ${{ vars.SLOW_TEST_TIMEOUT_SECONDS }}
      TEST_RETRIES: ${{ vars.TEST_RETRIES }}
      TEST_TIMEOUT_SECONDS: ${{ vars.TEST_TIMEOUT_SECONDS }}
      TEST_WORKER_PROCESSES: ${{ vars.TEST_WORKER_PROCESSES }}
    steps:
      # Since this workflow is triggered by a workflow_run event, we are not able to see the workflow status in check-runs.
      # So we need to set the status to pending manually by calling the GitHub API.
      - name: Create pending status
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ env.STATUSES_REQUEST_URL }}" \
            -d '{"state":"pending","context":"${{ env.STATUS_CONTEXT }}","description":"E2E tests are running...","target_url":"${{ env.TARGET_URL }}"}'

      # Save the triggering workflow information as an artifact for later reference
      - name: Save triggering workflow info
        run: |
          echo "TRIGGERING_WORKFLOW_RUN_ID=${{ github.event.workflow_run.id }}" > workflow-context.txt
          echo "TRIGGERING_WORKFLOW_HEAD_BRANCH=${{ github.event.workflow_run.head_branch }}" >> workflow-context.txt
          echo "TRIGGERING_WORKFLOW_HEAD_SHA=${{ github.event.workflow_run.head_sha }}" >> workflow-context.txt
          cat workflow-context.txt

      - name: Upload workflow context
        uses: actions/upload-artifact@v4
        with:
          name: workflow-context
          path: workflow-context.txt

      # Add a notice in this workflow run's timeline showing which Build workflow triggered it
      # This helps developers navigate between related workflow runs
      - name: Add link to triggering workflow
        run: |
          echo "::notice title=Triggered by workflow run::This E2E test was triggered by workflow run #${{ github.event.workflow_run.id }} - View it at https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

      - name: Git Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      - name: Download Artemis.war
        uses: actions/download-artifact@v4
        with:
          name: Artemis.war
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Make scripts executable
        run: |
          chmod +x .ci/E2E-tests/cleanup.sh
          chmod +x .ci/E2E-tests/execute.sh

      - name: Run cleanup script (before E2E)
        run: .ci/E2E-tests/cleanup.sh

      # If the workflow is triggered by a pull request, we need to run the tests on single node Artemis instance.
      - name: Run E2E Playwright tests (MySQL, Local)
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        run: .ci/E2E-tests/execute.sh mysql-localci playwright
        env:
          FAST_TEST_TIMEOUT_SECONDS: 60

      # If the workflow is triggered other events (by a push to a branch e.g. develop, main, or release), we need to run the tests on multi-node Artemis instance.
      - name: Run E2E Playwright tests (MySQL, Local, Multi-Node)
        if: ${{ github.event.workflow_run.event != 'pull_request' }}
        run: .ci/E2E-tests/execute.sh multi-node playwright
        env:
          FAST_TEST_TIMEOUT_SECONDS: 75

      - name: Upload JUnit Test Results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: JUnit Test Results
          if-no-files-found: error
          path: src/test/playwright/test-reports/*.xml

      - name: Run cleanup script (after E2E)
        run: .ci/E2E-tests/cleanup.sh

      # Once the tests are finished, we need to parse the test results to get
      # the total number of tests, the number of tests that passed, failed or were skipped.
      # We need this info to display it to the Developers in the Workflow section below each pull request
      # The next step in this workflow uses this info to update the status.
      - name: Parse test results
        if: always()
        id: parse-results
        continue-on-error: true
        run: |
          TOTAL=0
          PASSED=0
          FAILED=0
          SKIPPED=0

          # Check if test results file exists
          XML_FILE="src/test/playwright/test-reports/results.xml"
          if [ -f "$XML_FILE" ]; then
            echo "Final results.xml file found, started parsing..."

            # Sum the totals for all testsuites
            TESTS_COUNT=$(grep -o 'tests="[0-9]*"' "$XML_FILE" | grep -o '[0-9]*' | awk '{sum+=$1} END {print sum}')
            FAILURES_COUNT=$(grep -o 'failures="[0-9]*"' "$XML_FILE" | grep -o '[0-9]*' | awk '{sum+=$1} END {print sum}')
            SKIPPED_COUNT=$(grep -o 'skipped="[0-9]*"' "$XML_FILE" | grep -o '[0-9]*' | awk '{sum+=$1} END {print sum}')
            set -e

            # Use values if counts were found
            if [ -n "$TESTS_COUNT" ]; then TOTAL=$TESTS_COUNT; fi
            if [ -n "$FAILURES_COUNT" ]; then FAILED=$FAILURES_COUNT; fi
            if [ -n "$SKIPPED_COUNT" ]; then SKIPPED=$SKIPPED_COUNT; fi

            # Calculate passed tests
            PASSED=$((TOTAL - FAILED - SKIPPED))
          fi

          echo "XML Parsing Results:"
          echo "Total: $TOTAL"
          echo "Failed: $FAILED"
          echo "Skipped: $SKIPPED"
          echo "Passed: $PASSED"

          # Save to outputs
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

      # Update the status of the workflow run with the results parsed in the previous step.
      - name: Update status with results
        if: always()
        continue-on-error: true
        run: |
          # Determine workflow status
          WORKFLOW_STATUS="${{ job.status }}"

          # Get test results
          TOTAL="${{ steps.parse-results.outputs.total || 0 }}"
          PASSED="${{ steps.parse-results.outputs.passed || 0 }}"
          FAILED="${{ steps.parse-results.outputs.failed || 0 }}"
          SKIPPED="${{ steps.parse-results.outputs.skipped || 0 }}"

          # Determine GitHub status state based on workflow status
          if [ "$WORKFLOW_STATUS" = "success" ]; then
            STATE="success"
            DESCRIPTION="✅ E2E tests finished: $PASSED passed, $FAILED failed, $SKIPPED skipped"
          elif [ "$WORKFLOW_STATUS" = "failure" ]; then
            STATE="failure"
            DESCRIPTION="❌ E2E tests failed: $PASSED passed, $FAILED failed, $SKIPPED skipped"
          else
            STATE="error"
            DESCRIPTION="⚠️ E2E tests encountered an error"
          fi

          DESCRIPTION_ESCAPED=$(echo "$DESCRIPTION" | sed 's/"/\\"/g')
          JSON_PAYLOAD='{"state":"'$STATE'","context":"${{ env.STATUS_CONTEXT }}","description":"'$DESCRIPTION_ESCAPED'","target_url":"${{ env.TARGET_URL }}"}'
          echo "JSON payload: $JSON_PAYLOAD"

          # Update status
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ env.STATUSES_REQUEST_URL }}" \
            -d "$JSON_PAYLOAD"

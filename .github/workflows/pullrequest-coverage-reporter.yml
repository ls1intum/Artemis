name: PR Coverage Reporter

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

concurrency:
  group: coverage-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

env:
  CI: true
  node: 24

jobs:
  update-coverage:
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion != 'cancelled'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      pull-requests: write
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '${{ env.node }}'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Find PR
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const head = context.payload.workflow_run.head_repository.owner.login + ':' + context.payload.workflow_run.head_branch;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head,
              state: 'open'
            });
            if (prs.length === 0 || prs[0].draft) {
              core.setOutput('found', 'false');
              return;
            }
            core.setOutput('found', 'true');
            core.setOutput('number', prs[0].number);
            core.setOutput('base', prs[0].base.ref);

      - name: Download Jest coverage
        if: steps.pr.outputs.found == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Jest Coverage Summary
          path: build/test-results/jest
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Download Vitest coverage
        if: steps.pr.outputs.found == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Vitest Coverage Report
          path: build/test-results/vitest/coverage
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Download Server coverage
        if: steps.pr.outputs.found == 'true'
        uses: actions/download-artifact@v4
        with:
          name: Server Coverage XML
          path: build/reports/jacoco
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Generate coverage table
        if: steps.pr.outputs.found == 'true'
        id: coverage
        run: |
          BASE_BRANCH="origin/${{ steps.pr.outputs.base }}"
          git fetch origin "${{ steps.pr.outputs.base }}"

          # Run coverage script with --skip-tests to use downloaded artifacts
          COVERAGE_OUTPUT=$(npm run coverage:pr -- --skip-tests --base-branch "$BASE_BRANCH" --print 2>&1) || true

          # Extract the coverage table (between the separator lines)
          COVERAGE_TABLE=$(echo "$COVERAGE_OUTPUT" | sed -n '/^─/,/^─/p' | sed '1d;$d')

          # Check if we got any coverage data
          if [ -z "$COVERAGE_TABLE" ]; then
            echo "has_coverage=false" >> $GITHUB_OUTPUT
          else
            echo "has_coverage=true" >> $GITHUB_OUTPUT
            {
              echo 'table<<EOF'
              echo "$COVERAGE_TABLE"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Update PR description
        if: steps.pr.outputs.found == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          TEST_RESULT: ${{ github.event.workflow_run.conclusion }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          HAS_COVERAGE: ${{ steps.coverage.outputs.has_coverage }}
          COVERAGE_TABLE: ${{ steps.coverage.outputs.table }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);
            const testResult = process.env.TEST_RESULT;
            const runUrl = process.env.RUN_URL;
            const hasCoverage = process.env.HAS_COVERAGE === 'true';
            const coverageTable = process.env.COVERAGE_TABLE || '';

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            let body = pr.body || '';
            const sectionHeader = '### Test Coverage';
            const sectionIndex = body.indexOf(sectionHeader);

            if (sectionIndex === -1) {
              console.log('Test Coverage section not found');
              return;
            }

            const afterSection = body.substring(sectionIndex + sectionHeader.length);
            const nextSection = afterSection.search(/\n### /);
            const endIndex = nextSection === -1 ? body.length : sectionIndex + sectionHeader.length + nextSection;

            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            const lines = [
              sectionHeader,
              '<!-- Run `npm run coverage:pr` locally for detailed coverage. -->',
              ''
            ];

            if (hasCoverage && coverageTable.trim()) {
              if (testResult === 'failure') {
                lines.push('> [!WARNING]');
                lines.push('> Some tests failed. Coverage below is **best-effort** from passing tests.');
                lines.push(`> [View test logs](${runUrl})`, '');
              }
              lines.push(coverageTable, '');
            } else if (testResult === 'failure') {
              lines.push('> [!CAUTION]');
              lines.push('> Tests failed and no coverage data available.');
              lines.push(`> [View test logs](${runUrl})`, '');
              lines.push('*Run `npm run coverage:pr` locally to generate coverage.*', '');
            } else {
              lines.push('*Coverage data unavailable. Run `npm run coverage:pr` locally.*', '');
            }

            lines.push(`_Last updated: ${timestamp}_`, '');

            const newBody = body.substring(0, sectionIndex) + lines.join('\n') + body.substring(endIndex);

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: newBody
            });

name: Validate PR Description

on:
    pull_request_target:
        types: [opened, edited, ready_for_review, synchronize, reopened]

jobs:
    validate-pr-description:
        # Only run on non-draft PRs targeting develop from non-forked repos
        # Security: prevents stacked PR attacks and blocks forked PRs from accessing secrets
        if: |
            github.event.pull_request.draft == false &&
            github.event.pull_request.base.ref == 'develop' &&
            github.event.pull_request.head.repo.fork == false
        runs-on: ubuntu-latest
        timeout-minutes: 2
        permissions:
            pull-requests: write
            issues: write
            contents: read

        steps:
            - name: Validate PR description
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;
                      const author = context.payload.pull_request.user.login;

                      console.log(`Validating PR #${prNumber} description`);

                      // Use body from event payload (available in pull_request_target events)
                      const body = context.payload.pull_request.body || '';

                      // Fetch changed files (needed for visual changes detection)
                      let files = [];
                      try {
                          const response = await github.rest.pulls.listFiles({
                              owner,
                              repo,
                              pull_number: prNumber,
                              per_page: 100
                          });
                          files = response.data;
                      } catch (error) {
                          console.log('Could not fetch changed files:', error.message);
                          // Continue without file analysis - AI checks for visual changes will be skipped
                      }

                      const changedFiles = files.map(f => f.filename);
                      const hasClientChanges = changedFiles.some(f => f.startsWith('src/main/webapp/'));
                      console.log(`Change types - Client: ${hasClientChanges}`);

                      // Extract sections from PR body (supports ## and ### headings)
                      // Stops at next same-level or higher heading, but includes #### subsections
                      const extractSection = (header) => {
                          const regex = new RegExp(`###+\\s*${header}[\\s\\S]*?(?=\\n#{2,3}[^#]|$)`, 'i');
                          const match = body.match(regex);
                          if (!match) return '';
                          // Remove the header line and HTML comments
                          return match[0]
                              .replace(/##+\s*[^\n]+\n?/, '')
                              .replace(/<!--[\s\S]*?-->/g, '')
                              .trim();
                      };

                      const motivationSection = extractSection('Motivation and Context');
                      const descriptionSection = extractSection('Description');
                      const testingSection = extractSection('Steps for Testing');
                      const screenshotsSection = extractSection('Screenshots');

                      // Quick pre-checks - fail fast if sections are obviously empty
                      const issues = [];

                      // Store suggestions for the comment
                      const aiSuggestions = [];

                      if (!motivationSection || motivationSection.length < 10) {
                          issues.push('**Motivation and Context** section is empty or too brief');
                          aiSuggestions.push('Explain why this change is needed and what problem it solves');
                      }

                      if (!descriptionSection || descriptionSection.length < 10) {
                          issues.push('**Description** section is empty or too brief');
                          aiSuggestions.push('Describe what was changed and how it works');
                      }

                      if (!testingSection || testingSection.length < 20) {
                          issues.push('**Steps for Testing** section is empty or lacks specific steps');
                          aiSuggestions.push('Add specific steps like "1. Log in as instructor, 2. Navigate to X, 3. Click Y"');
                      }

                      // Check if all checkboxes are unchecked (at least some should be checked)
                      // Supports both - [ ] and * [ ] checkbox styles
                      const checkedBoxes = (body.match(/[-*] \[x\]/gi) || []).length;
                      const uncheckedBoxes = (body.match(/[-*] \[ \]/g) || []).length;
                      if (uncheckedBoxes > 0 && checkedBoxes === 0) {
                          issues.push('No checkboxes are checked in the PR description');
                          aiSuggestions.push('Check the boxes that apply to your changes in the Checklist section');
                      }

                      // AI validation setup
                      const azureEndpoint = '${{ secrets.PR_DESCRIPTION_VALIDATOR_OPENAI_ENDPOINT }}';
                      const azureApiKey = '${{ secrets.PR_DESCRIPTION_VALIDATOR_OPENAI_API_KEY }}';
                      const deploymentName = '${{ secrets.PR_DESCRIPTION_VALIDATOR_OPENAI_DEPLOYMENT }}';
                      const hasAiCredentials = azureEndpoint && azureApiKey && deploymentName &&
                          azureEndpoint !== '' && azureApiKey !== '';

                      // Helper function to call Azure OpenAI
                      async function callAI(prompt, userContent) {
                          const response = await fetch(
                              `${azureEndpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=2024-02-15-preview`,
                              {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json',
                                      'api-key': azureApiKey
                                  },
                                  body: JSON.stringify({
                                      messages: [
                                          { role: 'user', content: prompt + '\n\nContent to check:\n' + userContent }
                                      ],
                                      reasoning_effort: 'high'
                                  })
                              }
                          );

                          if (!response.ok) {
                              if (response.status === 429 || response.status === 503) {
                                  console.log(`AI service temporarily unavailable (${response.status})`);
                              } else {
                                  console.log(`AI request failed with status ${response.status}`);
                              }
                              return null;
                          }

                          const data = await response.json();
                          return data.choices?.[0]?.message?.content?.trim() || null;
                      }

                      // Sanitize AI output to prevent injection attacks via suggestions
                      function sanitizeAiOutput(text) {
                          if (!text) return '';
                          return text
                              // Remove @mentions (potential pings)
                              .replace(/@[a-zA-Z0-9_-]+/g, '')
                              // Remove URLs and links
                              .replace(/https?:\/\/[^\s)>\]]+/gi, '')
                              // Remove markdown links but keep text
                              .replace(/\[([^\]]*)\]\([^)]+\)/g, '$1')
                              // Remove potential API keys/secrets (long alphanumeric strings 32+ chars)
                              .replace(/\b[a-zA-Z0-9_-]{32,}\b/g, '[redacted]')
                              // Remove common secret patterns
                              .replace(/\b(sk|pk|api|key|token|secret|password|auth)[_-]?[a-zA-Z0-9]{16,}\b/gi, '[redacted]')
                              // Remove backtick code blocks that might contain secrets
                              .replace(/`[^`]{40,}`/g, '[redacted]')
                              // Collapse multiple spaces
                              .replace(/\s+/g, ' ')
                              .trim();
                      }

                      // ============================================================
                      // AI CHECK 1: Motivation Quality
                      // ============================================================
                      if (hasAiCredentials && motivationSection) {
                          try {
                              const prompt = 'Check if this Motivation text is meaningful. ' +
                                  'FAIL for gibberish, random characters, placeholder text like TODO or TBD or fill in, or unrelated content. ' +
                                  'PASS for any real explanation of why a change is needed (brief is OK, imperfect grammar is OK). ' +
                                  'Reply with PASS if acceptable. Reply with FAIL and one short suggestion if not acceptable.';

                              console.log('Running motivation quality check...');
                              const result = await callAI(prompt, motivationSection.substring(0, 500));
                              console.log(`Motivation check result: ${result}`);

                              if (result === null) {
                                  core.warning('Motivation quality check skipped: AI service unavailable');
                              } else if (result.toUpperCase().startsWith('FAIL')) {
                                  issues.push('**Motivation and Context** section needs improvement');
                                  const rawSuggestion = result.substring(result.indexOf(':') + 1).trim();
                                  const suggestion = sanitizeAiOutput(rawSuggestion);
                                  if (suggestion) aiSuggestions.push(suggestion);
                              }
                          } catch (error) {
                              console.log('Motivation check error:', error.message);
                              core.warning('Motivation quality check skipped: AI service error');
                          }
                      }

                      // ============================================================
                      // AI CHECK 2: Description Quality
                      // ============================================================
                      if (hasAiCredentials && descriptionSection) {
                          try {
                              const prompt = 'Check if this Description text is meaningful. ' +
                                  'FAIL for gibberish, random characters, placeholder text like TODO or TBD or fill in, or no actual change described. ' +
                                  'PASS for any real description of what was changed (brief is OK, imperfect grammar is OK). ' +
                                  'Reply with PASS if acceptable. Reply with FAIL and one short suggestion if not acceptable.';

                              console.log('Running description quality check...');
                              const result = await callAI(prompt, descriptionSection.substring(0, 500));
                              console.log(`Description check result: ${result}`);

                              if (result === null) {
                                  core.warning('Description quality check skipped: AI service unavailable');
                              } else if (result.toUpperCase().startsWith('FAIL')) {
                                  issues.push('**Description** section needs improvement');
                                  const rawSuggestion = result.substring(result.indexOf(':') + 1).trim();
                                  const suggestion = sanitizeAiOutput(rawSuggestion);
                                  if (suggestion) aiSuggestions.push(suggestion);
                              }
                          } catch (error) {
                              console.log('Description check error:', error.message);
                              core.warning('Description quality check skipped: AI service error');
                          }
                      }

                      // ============================================================
                      // AI CHECK 3: Testing Steps Quality
                      // ============================================================
                      if (hasAiCredentials && testingSection) {
                          try {
                              const prompt = 'Check if these Testing Steps are actionable. ' +
                                  'FAIL for vague instructions like test it or check everything, placeholder text, or no actual steps. ' +
                                  'PASS for specific actions a tester can follow (does not need to be perfect). ' +
                                  'Reply with PASS if acceptable. Reply with FAIL and one short suggestion if not acceptable.';

                              console.log('Running testing steps quality check...');
                              const result = await callAI(prompt, testingSection.substring(0, 500));
                              console.log(`Testing steps check result: ${result}`);

                              if (result === null) {
                                  core.warning('Testing steps quality check skipped: AI service unavailable');
                              } else if (result.toUpperCase().startsWith('FAIL')) {
                                  issues.push('**Steps for Testing** section needs more specific instructions');
                                  const rawSuggestion = result.substring(result.indexOf(':') + 1).trim();
                                  const suggestion = sanitizeAiOutput(rawSuggestion);
                                  if (suggestion) aiSuggestions.push(suggestion);
                              }
                          } catch (error) {
                              console.log('Testing steps check error:', error.message);
                              core.warning('Testing steps quality check skipped: AI service error');
                          }
                      }

                      // ============================================================
                      // AI CHECK 4: Visual Changes Detection (only for client changes)
                      // ============================================================
                      if (hasClientChanges && hasAiCredentials) {
                          try {
                              const clientFiles = files.filter(f =>
                                  f.filename.startsWith('src/main/webapp/') && !f.filename.includes('.spec.')
                              );
                              const patchSummary = clientFiles.map(f =>
                                  `${f.filename}:\n${(f.patch || '').substring(0, 1000)}`
                              ).join('\n\n');

                              const prompt = 'Do these code changes affect the UI visually? ' +
                                  'Answer YES for changes to HTML templates, CSS/SCSS styles, component layouts, or UI elements. ' +
                                  'Answer NO for TypeScript logic only, variable renames, refactoring, test files, services, or imports. ' +
                                  'Reply only YES or NO.';

                              console.log('Running visual changes check...');
                              const result = await callAI(prompt, patchSummary);
                              console.log(`Visual changes result: ${result}`);

                              if (result) {
                                  const hasVisualChanges = result.toUpperCase().startsWith('YES');
                                  if (hasVisualChanges && (!screenshotsSection || screenshotsSection.length < 10)) {
                                      issues.push('**Screenshots** section is empty but this PR contains visual/UI changes');
                                      aiSuggestions.push('Add screenshots showing the UI before and after your changes');
                                  }
                              } else {
                                  core.warning('Visual changes check skipped: AI service unavailable');
                              }
                          } catch (error) {
                              console.log('Visual changes check error:', error.message);
                              core.warning('Visual changes check skipped: AI service error');
                          }
                      } else if (hasClientChanges && !hasAiCredentials) {
                          core.warning('Visual changes check skipped: AI credentials not configured');
                      }

                      // Define the comment marker for identification
                      const commentMarker = '<!-- pr-description-validator -->';

                      // Helper function to delete previous validation comments
                      async function deletePreviousComments() {
                          try {
                              const { data: comments } = await github.rest.issues.listComments({
                                  owner,
                                  repo,
                                  issue_number: prNumber,
                                  per_page: 100
                              });

                              const botComments = comments.filter(c =>
                                  c.user.type === 'Bot' &&
                                  c.body.includes(commentMarker)
                              );

                              for (const comment of botComments) {
                                  await github.rest.issues.deleteComment({
                                      owner,
                                      repo,
                                      comment_id: comment.id
                                  });
                                  console.log(`Deleted previous validation comment ${comment.id}`);
                              }
                          } catch (error) {
                              console.log('Could not clean up old comments:', error.message);
                          }
                      }

                      // Always delete previous comments first (avoid spam)
                      await deletePreviousComments();

                      if (issues.length > 0) {
                          console.log(`Found ${issues.length} issues with PR description`);

                          // Build comment body
                          let commentBody = `${commentMarker}\n`;
                          commentBody += `@${author} Your PR description needs attention before it can be reviewed:\n\n`;
                          commentBody += `### Issues Found\n`;
                          issues.forEach((issue, index) => {
                              commentBody += `${index + 1}. ${issue}\n`;
                          });

                          // Deduplicate suggestions before adding
                          const uniqueSuggestions = [...new Set(aiSuggestions)].filter(Boolean);
                          if (uniqueSuggestions.length > 0) {
                              commentBody += `\n### How to Fix\n`;
                              uniqueSuggestions.forEach(suggestion => {
                                  commentBody += `- ${suggestion}\n`;
                              });
                          }

                          commentBody += `\n---\n`;
                          commentBody += `*This check validates that your PR description follows the [PR template](https://github.com/${owner}/${repo}/blob/develop/.github/PULL_REQUEST_TEMPLATE.md). `;
                          commentBody += `A complete description helps reviewers understand your changes and speeds up the review process.*`;

                          // Post new comment
                          try {
                              await github.rest.issues.createComment({
                                  owner,
                                  repo,
                                  issue_number: prNumber,
                                  body: commentBody
                              });
                          } catch (commentError) {
                              console.log('Could not post comment:', commentError.message);
                          }

                          core.setFailed('PR description validation failed');
                      } else {
                          console.log('PR description validation passed');
                      }

name: Validate PR Description

on:
    pull_request_target:
        types: [opened, edited, ready_for_review]

jobs:
    validate-pr-description:
        # Only run on non-draft PRs targeting develop (security: prevents stacked PR attacks)
        # TODO: Remove 'github-actions/validate-pr-description-workflow' from allowed branches before merging!
        if: >
            github.event.pull_request.draft == false &&
            (github.event.pull_request.base.ref == 'develop' ||
             github.event.pull_request.base.ref == 'github-actions/validate-pr-description-workflow')
        runs-on: ubuntu-latest
        timeout-minutes: 2
        permissions:
            pull-requests: write
            contents: read

        steps:
            - name: Validate PR description
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const prNumber = context.payload.pull_request.number;
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;
                      const author = context.payload.pull_request.user.login;

                      console.log(`Validating PR #${prNumber} description`);

                      // Fetch PR data
                      const { data: pr } = await github.rest.pulls.get({
                          owner,
                          repo,
                          pull_number: prNumber
                      });

                      const body = pr.body || '';

                      // Fetch changed files
                      const { data: files } = await github.rest.pulls.listFiles({
                          owner,
                          repo,
                          pull_number: prNumber,
                          per_page: 100
                      });

                      const changedFiles = files.map(f => f.filename);
                      const hasClientChanges = changedFiles.some(f => f.startsWith('src/main/webapp/'));
                      console.log(`Change types - Client: ${hasClientChanges}`);

                      // Extract sections from PR body
                      const extractSection = (header) => {
                          const regex = new RegExp(`###\\s*${header}[\\s\\S]*?(?=###|$)`, 'i');
                          const match = body.match(regex);
                          if (!match) return '';
                          // Remove the header line and HTML comments
                          return match[0]
                              .replace(/###\s*[^\n]+\n?/, '')
                              .replace(/<!--[\s\S]*?-->/g, '')
                              .trim();
                      };

                      const motivationSection = extractSection('Motivation and Context');
                      const descriptionSection = extractSection('Description');
                      const testingSection = extractSection('Steps for Testing');
                      const screenshotsSection = extractSection('Screenshots');

                      // Quick pre-checks - fail fast if sections are obviously empty
                      const issues = [];

                      if (!motivationSection || motivationSection.length < 10) {
                          issues.push('**Motivation and Context** section is empty or too brief');
                      }

                      if (!descriptionSection || descriptionSection.length < 10) {
                          issues.push('**Description** section is empty or too brief');
                      }

                      if (!testingSection || testingSection.length < 20) {
                          issues.push('**Steps for Testing** section is empty or lacks specific steps');
                      }

                      // Check if all checkboxes are unchecked (at least some should be checked)
                      const checkedBoxes = (body.match(/- \[x\]/gi) || []).length;
                      const uncheckedBoxes = (body.match(/- \[ \]/g) || []).length;
                      if (uncheckedBoxes > 0 && checkedBoxes === 0) {
                          issues.push('No checkboxes are checked in the PR description');
                      }

                      // AI validation setup
                      const azureEndpoint = '${{ secrets.PR_DESCRIPTION_VALIDATOR_OPENAI_ENDPOINT }}';
                      const azureApiKey = '${{ secrets.PR_DESCRIPTION_VALIDATOR_OPENAI_API_KEY }}';
                      const deploymentName = '${{ secrets.PR_DESCRIPTION_VALIDATOR_OPENAI_DEPLOYMENT }}';
                      const hasAiCredentials = azureEndpoint && azureApiKey && deploymentName &&
                          azureEndpoint !== '' && azureApiKey !== '';

                      // Helper function to call Azure OpenAI
                      async function callAI(systemPrompt, userPrompt, maxTokens = 100) {
                          const response = await fetch(
                              `${azureEndpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=2024-02-15-preview`,
                              {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/json',
                                      'api-key': azureApiKey
                                  },
                                  body: JSON.stringify({
                                      messages: [
                                          { role: 'system', content: systemPrompt },
                                          { role: 'user', content: userPrompt }
                                      ],
                                      temperature: 0,
                                      max_tokens: maxTokens
                                  })
                              }
                          );

                          if (!response.ok) {
                              if (response.status === 429 || response.status === 503) {
                                  console.log(`AI service temporarily unavailable (${response.status})`);
                              } else {
                                  console.log(`AI request failed with status ${response.status}`);
                              }
                              return null;
                          }

                          const data = await response.json();
                          return data.choices?.[0]?.message?.content?.trim() || null;
                      }

                      // Store AI suggestions for the comment
                      const aiSuggestions = [];

                      // ============================================================
                      // AI CHECK 1: Motivation Quality
                      // ============================================================
                      if (hasAiCredentials && motivationSection) {
                          try {
                              const prompt = 'Check if this Motivation text is meaningful. ' +
                                  'FAIL for gibberish, random characters, placeholder text like TODO or TBD or fill in, or unrelated content. ' +
                                  'PASS for any real explanation of why a change is needed (brief is OK, imperfect grammar is OK). ' +
                                  'Reply with PASS if acceptable. Reply with FAIL and one short suggestion if not acceptable.';

                              console.log('Running motivation quality check...');
                              const result = await callAI(prompt, motivationSection.substring(0, 500));
                              console.log(`Motivation check result: ${result}`);

                              if (result === null) {
                                  core.warning('Motivation quality check skipped: AI service unavailable');
                              } else if (result.toUpperCase().startsWith('FAIL')) {
                                  issues.push('**Motivation and Context** section needs improvement');
                                  const suggestion = result.substring(result.indexOf(':') + 1).trim();
                                  if (suggestion) aiSuggestions.push(suggestion);
                              }
                          } catch (error) {
                              console.log('Motivation check error:', error.message);
                              core.warning('Motivation quality check skipped: AI service error');
                          }
                      }

                      // ============================================================
                      // AI CHECK 2: Description Quality
                      // ============================================================
                      if (hasAiCredentials && descriptionSection) {
                          try {
                              const prompt = 'Check if this Description text is meaningful. ' +
                                  'FAIL for gibberish, random characters, placeholder text like TODO or TBD or fill in, or no actual change described. ' +
                                  'PASS for any real description of what was changed (brief is OK, imperfect grammar is OK). ' +
                                  'Reply with PASS if acceptable. Reply with FAIL and one short suggestion if not acceptable.';

                              console.log('Running description quality check...');
                              const result = await callAI(prompt, descriptionSection.substring(0, 500));
                              console.log(`Description check result: ${result}`);

                              if (result === null) {
                                  core.warning('Description quality check skipped: AI service unavailable');
                              } else if (result.toUpperCase().startsWith('FAIL')) {
                                  issues.push('**Description** section needs improvement');
                                  const suggestion = result.substring(result.indexOf(':') + 1).trim();
                                  if (suggestion) aiSuggestions.push(suggestion);
                              }
                          } catch (error) {
                              console.log('Description check error:', error.message);
                              core.warning('Description quality check skipped: AI service error');
                          }
                      }

                      // ============================================================
                      // AI CHECK 3: Testing Steps Quality
                      // ============================================================
                      if (hasAiCredentials && testingSection) {
                          try {
                              const prompt = 'Check if these Testing Steps are actionable. ' +
                                  'FAIL for vague instructions like test it or check everything, placeholder text, or no actual steps. ' +
                                  'PASS for specific actions a tester can follow (does not need to be perfect). ' +
                                  'Reply with PASS if acceptable. Reply with FAIL and one short suggestion if not acceptable.';

                              console.log('Running testing steps quality check...');
                              const result = await callAI(prompt, testingSection.substring(0, 500));
                              console.log(`Testing steps check result: ${result}`);

                              if (result === null) {
                                  core.warning('Testing steps quality check skipped: AI service unavailable');
                              } else if (result.toUpperCase().startsWith('FAIL')) {
                                  issues.push('**Steps for Testing** section needs more specific instructions');
                                  const suggestion = result.substring(result.indexOf(':') + 1).trim();
                                  if (suggestion) aiSuggestions.push(suggestion);
                              }
                          } catch (error) {
                              console.log('Testing steps check error:', error.message);
                              core.warning('Testing steps quality check skipped: AI service error');
                          }
                      }

                      // ============================================================
                      // AI CHECK 4: Visual Changes Detection (only for client changes)
                      // ============================================================
                      if (hasClientChanges && hasAiCredentials) {
                          try {
                              const clientFiles = files.filter(f =>
                                  f.filename.startsWith('src/main/webapp/') && !f.filename.includes('.spec.')
                              );
                              const patchSummary = clientFiles.map(f =>
                                  `${f.filename}:\n${(f.patch || '').substring(0, 1000)}`
                              ).join('\n\n');

                              const prompt = 'Do these code changes affect the UI visually? ' +
                                  'Answer YES for changes to HTML templates, CSS/SCSS styles, component layouts, or UI elements. ' +
                                  'Answer NO for TypeScript logic only, variable renames, refactoring, test files, services, or imports. ' +
                                  'Reply only YES or NO.';

                              console.log('Running visual changes check...');
                              const result = await callAI(prompt, patchSummary, 10);
                              console.log(`Visual changes result: ${result}`);

                              if (result) {
                                  const hasVisualChanges = result.toUpperCase().startsWith('YES');
                                  if (hasVisualChanges && (!screenshotsSection || screenshotsSection.length < 10)) {
                                      issues.push('**Screenshots** section is empty but this PR contains visual/UI changes');
                                      aiSuggestions.push('Add screenshots showing the UI before and after your changes');
                                  }
                              } else {
                                  core.warning('Visual changes check skipped: AI service unavailable');
                              }
                          } catch (error) {
                              console.log('Visual changes check error:', error.message);
                              core.warning('Visual changes check skipped: AI service error');
                          }
                      } else if (hasClientChanges && !hasAiCredentials) {
                          core.warning('Visual changes check skipped: AI credentials not configured');
                      }

                      // Define the comment marker for identification
                      const commentMarker = '<!-- pr-description-validator -->';

                      if (issues.length > 0) {
                          console.log(`Found ${issues.length} issues with PR description`);

                          // Build comment body
                          let commentBody = `${commentMarker}\n`;
                          commentBody += `@${author} Your PR description needs attention before it can be reviewed:\n\n`;
                          commentBody += `### Issues Found\n`;
                          issues.forEach((issue, index) => {
                              commentBody += `${index + 1}. ${issue}\n`;
                          });

                          if (aiSuggestions.length > 0) {
                              commentBody += `\n### How to Fix\n`;
                              aiSuggestions.forEach(suggestion => {
                                  commentBody += `- ${suggestion}\n`;
                              });
                          }

                          commentBody += `\n---\n`;
                          commentBody += `*This check validates that your PR description follows the [PR template](https://github.com/${owner}/${repo}/blob/develop/.github/PULL_REQUEST_TEMPLATE.md). `;
                          commentBody += `A complete description helps reviewers understand your changes and speeds up the review process.*`;

                          // Post comment
                          await github.rest.issues.createComment({
                              owner,
                              repo,
                              issue_number: prNumber,
                              body: commentBody
                          });

                          core.setFailed('PR description validation failed');
                      } else {
                          console.log('PR description validation passed');

                          // Clean up any previous validation failure comments
                          try {
                              const { data: comments } = await github.rest.issues.listComments({
                                  owner,
                                  repo,
                                  issue_number: prNumber,
                                  per_page: 100
                              });

                              const botComments = comments.filter(c =>
                                  c.user.type === 'Bot' &&
                                  c.body.includes(commentMarker)
                              );

                              for (const comment of botComments) {
                                  await github.rest.issues.deleteComment({
                                      owner,
                                      repo,
                                      comment_id: comment.id
                                  });
                                  console.log(`Deleted previous validation comment ${comment.id}`);
                              }
                          } catch (error) {
                              console.log('Could not clean up old comments:', error.message);
                          }
                      }

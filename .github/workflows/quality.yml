name: Java Code Quality Analysis

on:
  push:
    branches: [ develop ]
    paths:
      - src/main/java/**
  pull_request:
    paths:
      -  src/main/java/**

jobs:
  code-quality-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full history to enable git diff with base branch

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Check LOC and number of class dependencies
        run: |
          get_changed_java_files() {
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              base_branch="${{ github.event.pull_request.base.ref }}"
              echo "Checking files changed in PR against base branch: $base_branch" >&2
              changed_files=$(git diff --name-only origin/$base_branch...HEAD | grep '\.java$' || true)
              echo "Changed Java files in this PR:" >&2
              if [ -n "$changed_files" ]; then
                echo "$changed_files" | while read -r file; do
                  echo "  - $file" >&2
                done
              else
                echo "  (none)" >&2
              fi
              echo "" >&2
              echo "$changed_files"
            fi
          }

          check_violations_in_pr() {
            local violating_lines="$1"
            local changed_files="$2"

            if [ -z "$changed_files" ]; then
              echo "false"
              return
            fi

            while IFS= read -r violating_line; do
              violating_file=$(echo "$violating_line" | cut -d':' -f1)
              if echo "$changed_files" | grep -q "$violating_file"; then
                echo "true"
                return
              fi
            done <<< "$violating_lines"

            echo "false"
          }

          display_pr_violation_details() {
            local violation_type="$1"
            local violating_lines="$2"
            local changed_files="$3"

            if [ "$violation_type" = "large_classes" ]; then
              echo "Files you edited that are too large:"
            else
              echo "Files you edited that have too many constructor parameters:"
            fi

            while IFS= read -r violating_line; do
              violating_file=$(echo "$violating_line" | cut -d':' -f1)
              if echo "$changed_files" | grep -q "$violating_file"; then
                echo "  - $violating_line"
              fi
            done <<< "$violating_lines"
            echo ""
          }

          process_violation_type() {
            local violation_type="$1"
            local output="$2"
            local changed_files="$3"

            local title pattern
            if [ "$violation_type" = "large_classes" ]; then
              title="VIOLATING LARGE CLASSES"
              pattern='/Found [0-9]* classes with more than/,/Found [0-9]* Spring beans/p'
              filter='\.java: [0-9]+ lines'
              count="$large_classes"
            else
              title="VIOLATING COMPLEX BEANS"
              pattern='/Found [0-9]* Spring beans with constructors having more than/,$p'
              filter='\.java: [0-9]+ parameters'
              count="$complex_beans"
            fi

            echo "$title ($count items):"
            echo "$(printf '%.0s-' {1..48})"
            local violations=$(echo "$output" | sed -n "$pattern" | grep -E "$filter")
            echo "$violations"
            echo ""

            # Check if any violations are in PR changes and return result
            check_violations_in_pr "$violations" "$changed_files"
          }

          display_pr_context() {
            local large_violation="$1"
            local complex_violation="$2"
            local pr_large="$3"
            local pr_complex="$4"
            local violating_classes="$5"
            local violating_beans="$6"
            local changed_files="$7"

            echo "=========================================="
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              if [ "$pr_large" = false ] && [ "$pr_complex" = false ]; then
                echo "ℹ️  None of the violating files were modified in this PR."
                echo "The violations likely come from another PR that was merged recently."
                echo ""
                echo "You can bump the thresholds in .github/workflows/quality.yml:"
                [ "$large_violation" = true ] && echo "  - max_large_classes: $max_large_classes → $large_classes"
                [ "$complex_violation" = true ] && echo "  - max_complex_beans: $max_complex_beans → $complex_beans"
                echo ""
                echo "However, please make sure you have merged the latest develop version into your feature branch before bumping the threshold."
              else
                echo "⚠️  ATTENTION: Your PR modified files that are violating the quality standards!"
                echo ""
                [ "$pr_large" = true ] && display_pr_violation_details "large_classes" "$violating_classes" "$changed_files"
                [ "$pr_complex" = true ] && display_pr_violation_details "complex_beans" "$violating_beans" "$changed_files"
                echo "Please refactor these classes to meet the code quality standards!"
              fi
            else
              echo "Please refactor the classes listed above to meet the code quality standards!"
            fi
            echo "=========================================="
          }

          # Run the analysis and capture output
          output=$(python supporting_scripts/analyze_java_files.py)

          echo "$output"
          echo ""

          # Extract violation counts
          large_classes=$(echo "$output" | grep -o "Found [0-9]* classes with more than" | grep -o "[0-9]*")
          complex_beans=$(echo "$output" | grep -o "Found [0-9]* Spring beans with constructors having more than" | grep -o "[0-9]*")

          # TODO these values should become zero in the future
          max_large_classes=9
          max_complex_beans=10

          echo "=========================================="
          echo "CODE QUALITY ANALYSIS SUMMARY"
          echo "=========================================="
          echo "Large classes found: $large_classes (max allowed: $max_large_classes)"
          echo "Complex beans found: $complex_beans (max allowed: $max_complex_beans)"
          echo ""

          violations=0
          large_class_violation=false
          complex_bean_violation=false

          if [ "$large_classes" -gt "$max_large_classes" ]; then
            echo "❌ Too many large classes: $large_classes > $max_large_classes"
            large_class_violation=true
          else
            echo "✅ Large classes within threshold: $large_classes <= $max_large_classes"
          fi

          if [ "$complex_beans" -gt "$max_complex_beans" ]; then
            excess_complex_beans=$((complex_beans - max_complex_beans))
            echo "❌ Too many complex beans: $complex_beans > $max_complex_beans ($excess_complex_beans beans need to be refactored)"
            complex_bean_violation=true
          else
            echo "✅ Complex beans within threshold: $complex_beans <= $max_complex_beans"
          fi

          echo "=========================================="

          if [ $large_class_violation = "true" ] || [ $complex_bean_violation = "true" ]; then
            echo "::error::Code quality check failed"
            echo ""

            changed_java_files=$(get_changed_java_files)

            # Process violations and check if they're in PR changes
            violating_classes=""
            violating_beans=""
            pr_introduced_large_class_violations=false
            pr_introduced_complex_bean_violations=false

            if [ "$large_class_violation" = true ]; then
              violating_classes=$(process_violation_type "large_classes" "$output" "$changed_java_files")
              pr_introduced_large_class_violations=$(echo "$violating_classes" | tail -1)
              violating_classes=$(echo "$violating_classes" | head -n -1)
            fi

            if [ "$complex_bean_violation" = true ]; then
              violating_beans=$(process_violation_type "complex_beans" "$output" "$changed_java_files")
              pr_introduced_complex_bean_violations=$(echo "$violating_beans" | tail -1)
              violating_beans=$(echo "$violating_beans" | head -n -1)
            fi

            display_pr_context "$large_class_violation" "$complex_bean_violation" \
              "$pr_introduced_large_class_violations" "$pr_introduced_complex_bean_violations" \
              "$violating_classes" "$violating_beans" "$changed_java_files"

            exit 1
          else
            echo "✅ Code quality check passed"
          fi

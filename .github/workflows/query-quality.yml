name: Query Over-fetch Detection

on:
  push:
    branches: [ develop ]
    paths:
      - 'src/main/java/**'
  pull_request:

jobs:
  query-quality-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Check for query over-fetching
        run: |
          # Run the analysis and capture output
          output=$(python supporting_scripts/find_slow_queries.py)

          echo "$output"
          echo ""

          # Extract violation counts
          entitygraph_violations=$(echo "$output" | grep -c "\[EntityGraph\] Potential over-fetch" || echo "0")
          query_violations=$(echo "$output" | grep -c "\[@Query\] Potential over-fetch" || echo "0")
          total_violations=$((entitygraph_violations + query_violations))

          # TODO these values should become zero in the future
          max_entitygraph_violations=0
          max_query_violations=0
          max_total_violations=0

          echo "=========================================="
          echo "QUERY QUALITY ANALYSIS SUMMARY"
          echo "=========================================="
          echo "EntityGraph violations found: $entitygraph_violations (max allowed: $max_entitygraph_violations)"
          echo "Query violations found: $query_violations (max allowed: $max_query_violations)"
          echo "Total violations found: $total_violations (max allowed: $max_total_violations)"
          echo ""

          violation_detected=false

          if [ "$entitygraph_violations" -gt "$max_entitygraph_violations" ]; then
            echo "❌ Too many EntityGraph violations: $entitygraph_violations > $max_entitygraph_violations"
            violation_detected=true
          else
            echo "✅ EntityGraph violations within threshold: $entitygraph_violations <= $max_entitygraph_violations"
          fi

          if [ "$query_violations" -gt "$max_query_violations" ]; then
            echo "❌ Too many Query violations: $query_violations > $max_query_violations"
            query_violation=true
            violation_detected=true
          else
            echo "✅ Query violations within threshold: $query_violations <= $max_query_violations"
          fi

          if [ "$total_violations" -gt "$max_total_violations" ]; then
            echo "❌ Too many total violations: $total_violations > $max_total_violations"
            total_violation=true
            violation_detected=true
          else
            echo "✅ Total violations within threshold: $total_violations <= $max_total_violations"
          fi

          echo "=========================================="

          if [ $violation_detected = "true" ]; then
            echo "::error::Query Quality check failed"
            echo ""

            if [ "$entitygraph_violations" -gt "0" ]; then
              echo "VIOLATING ENTITY GRAPHS ($entitygraph_violations violations):"
              echo "-----------------------------------------------------------"
              echo "$output" | sed -n '/\[EntityGraph\] Potential over-fetch/,/^$/p' | grep -E '(Potential over-fetch|@EntityGraph)'
              echo ""
            fi

            if [ "$query_violations" -gt "0" ]; then
              echo "VIOLATING QUERIES ($query_violations violations):"
              echo "-------------------------------------------------"
              echo "$output" | sed -n '/\[@Query\] Potential over-fetch/,/^$/p' | grep -E '(Potential over-fetch|JOIN FETCH)'
              echo ""
            fi

            echo "RECOMMENDATIONS:"
            echo "- Consider using pagination for large result sets"
            echo "- Split complex queries into smaller, focused queries"
            echo "- Consider projection queries when full entities aren't needed"
            echo "- Review if all JOIN FETCHes are actually necessary"
            echo ""
            echo "Please refactor the queries listed above to meet performance standards!"
            exit 1
          else
            echo "✅ Query Quality check passed"
          fi

name: Run Cypress E2E Tests
on: push

env:
  CI: true
  node: 14.x
  java: 16

jobs:
  execute-tests:
    runs-on: ubuntu-latest
#    environment:
#        name: artemistest5-e2e-tests
#        url: https://artemistest5.ase.in.tum.de
#    concurrency: cypress-tests
    
    services:
      mysql:
        image: mysql:8.0.25
        env:
          MYSQL_ROOT_PASSWORD: rootPassword
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2.4.1
        with:
          node-version: '${{ env.node }}'
          cache: 'npm'
      - name: Setup Java
        uses: actions/setup-java@v2.3.1
        with:
          distribution: 'zulu'
          java-version: '${{ env.java }}'
          cache: 'gradle'
      - name: Production Build
        run: ./gradlew -Pprod -Pwar clean bootWar
        env:
          NODE_OPTIONS: --max_old_space_size=6144
      
      - name: Copy configuration files
        run: cp src/test/cypress/deployment/* build/libs/
      - name: Import sql dump
        run: mysql --host=localhost --port=3306 --protocol=TCP --user=root --password=rootPassword < build/libs/*.sql
      - name: Load Artemis SSH Key
        run: echo "${{ secrets.ARTEMIS_SSH_KEY_VALUE }}" > build/libs/artemis_key
      - name: Start Artemis
        env:
          # Bamboo config
          ARTEMIS_CONTINUOUS-INTEGRATION_URL: https://jira-prelive.ase.in.tum.de
          ARTEMIS_CONTINUOUS-INTEGRATION_USER: ${{ secrets.ARTEMIS_ATLASSIAN_USER }}
          ARTEMIS_CONTINUOUS-INTEGRATION_PASSWORD: ${{ secrets.ARTEMIS_ATLASSIAN_PASSWORD }}
          ARTEMIS_CONTINUOUS-INTEGRATION_ARTEMIS-AUTHENTICATION-TOKEN-VALUE: ${{ secrets.BAMBOO_AUTH_TOKEN }}
          # Bitbucket config
          ARTEMIS_VERSION-CONTROL_URL: https://bitbucket-prelive.ase.in.tum.de
          ARTEMIS_VERSION-CONTROL_USER: ${{ secrets.ARTEMIS_ATLASSIAN_USER }}
          ARTEMIS_VERSION-CONTROL_PASSWORD: ${{ secrets.ARTEMIS_ATLASSIAN_PASSWORD }}
          ARTEMIS_VERSION-CONTROL_SSH-PRIVATE-KEY-FOLDER-PATH: ./artemis_key
          ARTEMIS_VERSION-CONTROL_SSH-PRIVATE-KEY-PASSWORD: ${{ secrets.ARTEMIS_SSH_KEY_PASSWORD }}
          # Jira config
          ARTEMIS_USER-MANAGEMENT_EXTERNAL_URL: https://jira-prelive.ase.in.tum.de
          ARTEMIS_USER-MANAGEMENT_EXTERNAL_USER: ${{ secrets.ARTEMIS_ATLASSIAN_USER }}
          ARTEMIS_USER-MANAGEMENT_EXTERNAL_PASSWORD: ${{ secrets.ARTEMIS_ATLASSIAN_PASSWORD }}
          # Spring config
          SPRING_DATASOURCE_PASSWORD: rootPassword
          SPRING_PROFILES_ACTIVE: dev,bamboo,bitbucket,jira,artemis,scheduling,local
        run: cd build/libs; java -jar *.war &

      - name: Run Cypress Tests
        uses: cypress-io/github-action@v2
        with:
          working-directory: src/test/cypress
          browser: chrome
          wait-on: 'http://localhost:8080'
          install-command: npm ci
          config: baseUrl=http://localhost:8080
          env: username=user_USERID,password=password_USERID,adminUsername=artemis_admin,adminPassword=artemis_admin,allowGroupCustomization=true,studentGroupName=artemis-e2etest-students,tutorGroupName=artemis-e2etest-tutors,editorGroupName=artemis-e2etest-editors,instructorGroupName=artemis-e2etest-instructors

name: 'E2E Test Teardown'
description: 'Common teardown steps for E2E test jobs'

inputs:
  artifact-name-suffix:
    description: 'Suffix for artifact names (e.g., "Phase 1", "Phase 2", "")'
    required: false
    default: ''
  require-tests:
    description: 'Whether to fail if no test files found (error vs warn)'
    required: false
    default: 'warn'

runs:
  using: 'composite'
  steps:
    - name: Clean up intermediate test result files
      shell: bash
      run: |
        # Playwright generates 3 XML files: results-parallel.xml, results-sequential.xml, and results.xml (merged).
        # If all 3 are uploaded, the JUnit reporter counts tests from each file, causing double-counting
        # (e.g., ~418 tests reported instead of ~223 actual tests).
        # We remove the intermediate files to keep only the merged results.xml.
        echo "Removing intermediate XML files (results-parallel.xml, results-sequential.xml) to prevent"
        echo "double-counting in test reports. Only the merged results.xml should be uploaded."
        rm -f src/test/playwright/test-reports/results-parallel.xml || true
        rm -f src/test/playwright/test-reports/results-sequential.xml || true
        echo "Listing remaining XML files:"
        ls -la src/test/playwright/test-reports/*.xml 2>/dev/null || echo "No XML files found"

    - name: Convert JUnit XML error elements to failure elements
      shell: bash
      continue-on-error: true
      run: |
        # mikepenz/action-junit-report only counts <failure> elements, not <error> elements.
        # Playwright writes timeouts as <error>, so they show as "0 failed" in the report.
        # Convert <error> to <failure> so all failures are counted correctly.
        XML_FILE="src/test/playwright/test-reports/results.xml"
        if [ -f "$XML_FILE" ]; then
          echo "Converting <error> elements to <failure> in $XML_FILE"
          sed -i.bak -e 's/<error\b/<failure/g' -e 's|</error>|</failure>|g' "$XML_FILE"
          # Merge errors count into failures count in testsuite attributes
          perl -i -pe '
            if (/<testsuite\b/) {
              my $errors = 0; my $failures = 0;
              $errors = $1 if /errors="(\d+)"/;
              $failures = $1 if /failures="(\d+)"/;
              my $total = $errors + $failures;
              s/failures="\d+"/failures="$total"/;
              s/\s*errors="\d+"//;
            }
          ' "$XML_FILE"
          rm -f "${XML_FILE}.bak"
          echo "Conversion complete"
        else
          echo "No results.xml found, skipping conversion"
        fi

    - name: Upload JUnit Test Results
      if: success() || failure()
      uses: actions/upload-artifact@v6
      with:
        name: JUnit Test Results${{ inputs.artifact-name-suffix && format(' {0}', inputs.artifact-name-suffix) || '' }}
        if-no-files-found: ${{ inputs.require-tests }}
        path: src/test/playwright/test-reports/*.xml

    - name: Upload Client Test Coverage Report
      if: success() || failure()
      uses: actions/upload-artifact@v6
      with:
        name: E2E Client Coverage Report${{ inputs.artifact-name-suffix && format(' {0}', inputs.artifact-name-suffix) || '' }}
        path: src/test/playwright/test-reports/client-coverage

    - name: Run cleanup script (after E2E)
      shell: bash
      run: .ci/E2E-tests/cleanup.sh || true

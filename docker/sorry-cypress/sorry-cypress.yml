# ----------------------------------------------------------------------------------------------------------------------
# Sorry Cypress Setup
# ----------------------------------------------------------------------------------------------------------------------

services:
  mongo:
    image: mongo:4.4
    container_name: Mongo
    hostname: mongo
    restart: always
    volumes:
      - ${MONGO_VOLUME_MOUNT:-./files/mongo}:/data/db
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}

  director:
    image: agoldis/sorry-cypress-director:${SORRY_CYPRESS_TAG:-latest}
    container_name: Director
    hostname: director
    restart: always
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}
    environment:
      EXECUTION_DRIVER: '../execution/mongo/driver'
      SCREENSHOTS_DRIVER: '../screenshots/minio.driver'
      MINIO_PORT: '443'
      MINIO_USESSL: 'true'
      MINIO_BUCKET: 'sorry-cypress'
      PROBE_LOGGER: 'false'
    depends_on:
      - mongo

  api:
    image: agoldis/sorry-cypress-api:${SORRY_CYPRESS_TAG:-latest}
    container_name: API
    hostname: api
    restart: always
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}
    environment:
      APOLLO_PLAYGROUND: 'false'
    depends_on:
      - mongo

  dashboard:
    image: agoldis/sorry-cypress-dashboard:${SORRY_CYPRESS_TAG:-latest}
    container_name: Dashboard
    hostname: dashboard
    restart: always
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}
    environment:
      GRAPHQL_CLIENT_CREDENTIALS: 'include'
      PORT: 8080
      CI_URL: ''
    expose:
      - '8080'
    depends_on:
      - mongo
      - api

  storage:
    image: minio/minio
    container_name: Minio
    hostname: storage
    restart: always
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}
    volumes:
      - ${MINIO_VOLUME_MOUNT:-./files/minio}:/data
    command: minio server --console-address ":9090" /data

  createbuckets:
    image: minio/mc
    container_name: MinioBucketCreator
    depends_on:
      - storage
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}
    entrypoint: >
      /bin/sh -c "
      sleep 3;
      /usr/bin/mc config host add myminio http://storage:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD;
      /usr/bin/mc mb myminio/sorry-cypress;
      /usr/bin/mc anonymous set download myminio/sorry-cypress;
      exit 0;
      "

  nginx:
    image: nginx
    container_name: Nginx
    restart: always
    ports:
      - 80:80
      - 443:443
    env_file:
      - ${SORRY_CYPRESS_ENV_FILE:-./sorry-cypress.env}
    environment:
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx
    volumes:
      - type: bind
        source: ${NGINX_PROXY_CONFIG_PATH:-./files/nginx/nginx.conf}
        target: '/etc/nginx/templates/nginx.conf.template'
      - type: bind
        source: ${NGINX_PROXY_SSL_CERTIFICATE_PATH:-./files/nginx/fullchain.pem}
        target: '/etc/certificates/fullchain.pem'
      - type: bind
        source: ${NGINX_PROXY_SSL_CERTIFICATE_KEY_PATH:-./files/nginx/privkey.pem}
        target: '/etc/certificates/privkey.pem'
      - type: bind
        source: ${NGINX_PROXY_HTPASSWD:-./files/nginx/.htpasswd}
        target: '/etc/nginx/.htpasswd'

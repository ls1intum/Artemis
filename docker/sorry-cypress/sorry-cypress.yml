# ----------------------------------------------------------------------------------------------------------------------
# Sorry Cypress Setup
# ----------------------------------------------------------------------------------------------------------------------

services:
  mongo:
    image: mongo:4.4
    container_name: Mongo
    hostname: mongo
    restart: always
    volumes:
      - files/mongo:/data/db
    env_file:
      - ./sorry-cypress.env

  director:
    image: agoldis/sorry-cypress-director
    container_name: Director
    hostname: director
    restart: always
    env_file:
      - ./sorry-cypress.env
    environment:
      EXECUTION_DRIVER: '../execution/mongo/driver'
      MONGODB_URI: 'mongodb://sorry-cypress:sorry-cypress@mongo:27017'
      MONGODB_DATABASE: 'sorry-cypress'
      SCREENSHOTS_DRIVER: '../screenshots/minio.driver'
      MINIO_PORT: '443'
      MINIO_USESSL: 'true'
      MINIO_BUCKET: 'sorry-cypress'
      PROBE_LOGGER: 'false'
    depends_on:
      - mongo

  api:
    image: agoldis/sorry-cypress-api
    container_name: API
    hostname: api
    environment:
      MONGODB_URI: 'mongodb://sorry-cypress:sorry-cypress@mongo:27017'
      MONGODB_DATABASE: 'sorry-cypress'
      APOLLO_PLAYGROUND: 'false'
    depends_on:
      - mongo

  dashboard:
    image: agoldis/sorry-cypress-dashboard
    container_name: Dashboard
    hostname: dashboard
    restart: always
    env_file:
      - ./sorry-cypress.env
    environment:
      GRAPHQL_CLIENT_CREDENTIALS: 'include'
      PORT: 8080
      CI_URL: ''
    expose:
      - "8080"
    depends_on:
      - mongo
      - api

  storage:
    image: minio/minio
    container_name: Minio
    hostname: storage
    restart: always
    env_file:
      - ./sorry-cypress.env
    volumes:
      - files/minio:/data
    command: minio server --console-address ":9090" /data

  createbuckets:
    image: minio/mc
    container_name: MinioBucketCreator
    depends_on:
      - storage
    env_file:
      - ./sorry-cypress.env
    entrypoint: >
      /bin/sh -c "
      sleep 3;
      /usr/bin/mc config host add myminio http://storage:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD;
      /usr/bin/mc mb myminio/sorry-cypress;
      /usr/bin/mc anonymous set download myminio/sorry-cypress;
      exit 0;
      "

  nginx:
    image: nginx
    container_name: Nginx
    restart: always
    ports:
      - 80:80
      - 443:443
    env_file:
      - ./sorry-cypress.env
    volumes:
      - files/nginx/nginx.conf:/etc/nginx/nginx.conf
      - files/nginx/.htpasswd:/etc/nginx/.htpasswd
      - files/nginx/fullchain.pem:/etc/certificates/fullchain.pem
      - files/nginx/privkey.pem:/etc/certificates/privkey.pem

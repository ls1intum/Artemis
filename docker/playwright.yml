# ----------------------------------------------------------------------------------------------------------------------
# Playwright base service
# ----------------------------------------------------------------------------------------------------------------------

services:
    artemis-playwright:
        image: mcr.microsoft.com/playwright:v1.57.0
        pull_policy: missing
        environment:
            CI: 'true'
            BASE_URL: 'https://artemis-nginx'
            ADMIN_USERNAME: '${ARTEMIS_ADMIN_USERNAME}'
            ADMIN_PASSWORD: '${ARTEMIS_ADMIN_PASSWORD}'
            PLAYWRIGHT_USERNAME_TEMPLATE: '${PLAYWRIGHT_USERNAME_TEMPLATE}'
            PLAYWRIGHT_PASSWORD_TEMPLATE: '${PLAYWRIGHT_PASSWORD_TEMPLATE}'
            ALLOW_GROUP_CUSTOMIZATION: 'true'
            STUDENT_GROUP_NAME: 'artemis-e2etest-students'
            TUTOR_GROUP_NAME: 'artemis-e2etest-tutors'
            EDITOR_GROUP_NAME: 'artemis-e2etest-editors'
            INSTRUCTOR_GROUP_NAME: 'artemis-e2etest-instructors'
            CREATE_USERS: '${PLAYWRIGHT_CREATE_USERS}'
            TEST_TIMEOUT_SECONDS: '${TEST_TIMEOUT_SECONDS}'
            TEST_RETRIES: '${TEST_RETRIES}'
            TEST_WORKER_PROCESSES: '${TEST_WORKER_PROCESSES}'
            SLOW_TEST_TIMEOUT_SECONDS: '${SLOW_TEST_TIMEOUT_SECONDS}'
            FAST_TEST_TIMEOUT_SECONDS: '${FAST_TEST_TIMEOUT_SECONDS}'
            PLAYWRIGHT_TEST_PATHS: '${PLAYWRIGHT_TEST_PATHS:-}'
        command: >
          sh -c '
          cd /app/artemis/src/test/playwright &&
          chmod 777 /root &&
          npm ci &&
          npm run playwright:setup &&
          if [ -n "$$PLAYWRIGHT_TEST_PATHS" ]; then
            echo "Running tests in: $$PLAYWRIGHT_TEST_PATHS" &&
            cross-env NODE_OPTIONS="--max-old-space-size=8192" PLAYWRIGHT_TEST_TYPE=parallel playwright test --project=fast-tests --project=slow-tests $$PLAYWRIGHT_TEST_PATHS &&
            cross-env PLAYWRIGHT_TEST_TYPE=sequential playwright test --project=sequential-tests --workers 1 $$PLAYWRIGHT_TEST_PATHS &&
            npm run merge-junit-reports &&
            npm run merge-coverage-reports;
          else
            npm run playwright:test;
          fi &&
          rm ./test-reports/results-parallel.xml ./test-reports/results-sequential.xml
          '
        volumes:
            - ..:/app/artemis
        stdin_open: true
        tty: true
        ipc: host

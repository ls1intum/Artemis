# ----------------------------------------------------------------------------------------------------------------------
# Atlassian Setup
# ----------------------------------------------------------------------------------------------------------------------

services:
    jira:
        extends:
            file: ./jira.yml
            service: jira
    bitbucket:
        container_name: artemis-bitbucket
        hostname: bitbucket
        extra_hosts:
            - "host.docker.internal:host-gateway"
        image: ghcr.io/ls1intum/artemis-bitbucket:8.8.2
        pull_policy: always
        volumes:
            - artemis-bitbucket-data:/var/atlassian/application-data/bitbucket
        environment:
            SPRING_APPLICATION_JSON: '{"plugin":{"ssh":{"baseurl":"ssh://bitbucket:7999"}}}'
        ports:
            - "7990:7990"
            - "7999:7999"
        # expose the ports to make them reachable docker internally even if the external port mapping changes
        expose:
            - "7990"
            - "7999"
        networks:
            - artemis
    bamboo:
        container_name: artemis-bamboo
        hostname: bamboo
        extra_hosts:
            - "host.docker.internal:host-gateway"
        image: ghcr.io/ls1intum/artemis-bamboo:9.2.1
        pull_policy: always
        volumes:
            - artemis-bamboo-data:/var/atlassian/application-data/bamboo
        ports:
            - "54663:54663"
            - "8085:8085"
        # expose the ports to make them reachable docker internally even if the external port mapping changes
        expose:
            - "54663"
            - "8085"
        networks:
            - artemis

    bamboo-build-agent:
        container_name: artemis-bamboo-build-agent
        hostname: bamboo-build-agent
        extra_hosts:
            - "host.docker.internal:host-gateway"
        image: ghcr.io/ls1intum/artemis-bamboo-build-agent:9.2.1
        pull_policy: always
        volumes:
            # The following path needs to be the same absolute path on the host because of the docker socket:
            # https://confluence.atlassian.com/bamkb/bamboo-in-docker-build-fails-due-to-a-missing-working-directory-when-using-docker-runner-1027119339.html
            - /var/atlassian/application-data/bamboo-agent:/var/atlassian/application-data/bamboo-agent
            - /var/run/docker.sock:/var/run/docker.sock
        environment:
            BAMBOO_SERVER: "http://bamboo:8085"
        networks:
            - artemis

networks:
    artemis:
        driver: "bridge"
        name: artemis
volumes:
    artemis-jira-data:
        name: artemis-jira-data
    artemis-bitbucket-data:
        name: artemis-bitbucket-data
    artemis-bamboo-data:
        name: artemis-bamboo-data
    artemis-bamboo-build-agent:
        name: artemis-bamboo-build-agent

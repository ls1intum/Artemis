meta {
  name: Trigger Build - Groovy Script
  type: http
  seq: 12
}

post {
  url: {{baseUrl}}/api/v1/build
  body: json
  auth: none
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "exerciseId": {{exerciseId}},
    "participationId": {{participationId}},
    "exerciseRepository": {
      "url": "https://github.com/user/exercise-repo.git",
      "commitHash": "abc123def456",
      "cloneLocation": "/tmp/exercise",
      "accessToken": "github_pat_example"
    },
    "buildScript": "println 'Running Groovy script build...'\ndef process = ['./gradlew', 'clean', 'test'].execute()\nprocess.waitFor()\nprintln 'Groovy script build completed with exit code: ' + process.exitValue()",
    "scriptType": "groovy",
    "programmingLanguage": "JAVA",
    "additionalProperties": {
      "timeout": "300"
    }
  }
}

assert {
  res.status: in [200, 500]
}

tests {
  test("Groovy script build trigger responds appropriately", function() {
    const status = res.getStatus();
    const body = res.getBody();
    
    if (status === 200) {
      // Successful build trigger
      expect(body.buildId).to.be.a('string');
      expect(body.buildId).to.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/);
      expect(body.message).to.equal('Build triggered successfully');
      
      // Store the build ID for subsequent tests
      bru.setVar("groovyBuildId", body.buildId);
    } else if (status === 500) {
      // Expected when Jenkins is not available
      expect(body.message).to.include('Failed to trigger build');
    } else {
      throw new Error(`Unexpected status code: ${status}`);
    }
  });

  test("Response has correct structure", function() {
    const body = res.getBody();
    expect(body).to.have.property('buildId');
    expect(body).to.have.property('message');
  });
}

docs {
  # Trigger Build - Groovy Script

  This endpoint triggers a new build using a Groovy script.

  ## Request Body:
  - `exerciseId`: ID of the exercise (required)
  - `participationId`: ID of the participation (required)
  - `exerciseRepository`: Main exercise repository information
  - `buildScript`: Groovy script to execute for the build
  - `scriptType`: "groovy" to specify Groovy script execution
  - `programmingLanguage`: Programming language (JAVA, PYTHON, etc.)
  - `additionalProperties`: Additional build configuration

  ## Expected Responses:
  - `200`: Build triggered successfully, returns build UUID
  - `400`: Invalid request body
  - `500`: Internal server error (e.g., Jenkins unavailable)
}
package de.tum.cit.aet.artemis.core.service;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyBoolean;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.never;
import static org.mockito.Mockito.verify;

import java.time.Instant;
import java.util.List;
import java.util.Set;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.config.CronTask;
import org.springframework.scheduling.config.ScheduledTask;
import org.springframework.scheduling.config.ScheduledTaskHolder;
import org.springframework.test.context.bean.override.mockito.MockitoSpyBean;

import de.tum.cit.aet.artemis.core.domain.User;
import de.tum.cit.aet.artemis.core.dto.ArtemisVersionDTO;
import de.tum.cit.aet.artemis.core.dto.ComponentVulnerabilitiesDTO;
import de.tum.cit.aet.artemis.core.dto.ComponentWithVulnerabilitiesDTO;
import de.tum.cit.aet.artemis.core.dto.VulnerabilityDTO;
import de.tum.cit.aet.artemis.shared.base.AbstractSpringIntegrationIndependentTest;

@ExtendWith(MockitoExtension.class)
class VulnerabilityScanScheduleServiceTest extends AbstractSpringIntegrationIndependentTest {

    @Autowired
    private VulnerabilityScanScheduleService vulnerabilityScanScheduleService;

    @Autowired
    private ScheduledTaskHolder scheduledTaskHolder;

    @MockitoSpyBean
    private VulnerabilityService vulnerabilityService;

    @MockitoSpyBean
    private ArtemisVersionService artemisVersionService;

    @Test
    void testCronVulnerabilityScanTaskScheduledEveryMondayAt8AMByDefault() {
        final String cronExpression = "0 0 8 * * MON";
        final String cronTaskName = "de.tum.cit.aet.artemis.core.service.VulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin";
        Set<ScheduledTask> scheduledTasks = scheduledTaskHolder.getScheduledTasks();
        long scheduledCronTasksForVulnerabilityScan = scheduledTasks.stream().filter(scheduledTask -> scheduledTask.getTask() instanceof CronTask)
                .map(scheduledTask -> (CronTask) scheduledTask.getTask()).filter(cronTask -> cronExpression.equals(cronTask.getExpression()))
                .filter(cronTask -> cronTaskName.equals(cronTask.toString())).count();
        assertThat(scheduledCronTasksForVulnerabilityScan).isOne();
    }

    @Test
    void testScanSendsEmailToConfiguredAdminEmailWhenNoVulnerabilities() {
        // Setup mock data
        ComponentVulnerabilitiesDTO vulnerabilities = new ComponentVulnerabilitiesDTO(List.of(), 0, 0, 0, 0, 0, Instant.now().toString());

        ArtemisVersionDTO versionInfo = new ArtemisVersionDTO("7.8.0", "7.8.0", false, null, null, Instant.now().toString());

        doReturn(vulnerabilities).when(vulnerabilityService).refreshVulnerabilities();
        doReturn(versionInfo).when(artemisVersionService).getVersionInfo();

        // Execute the scan
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Verify email was sent with correct parameters
        ArgumentCaptor<User> userCaptor = ArgumentCaptor.forClass(User.class);
        verify(mailService).sendVulnerabilityScanResultEmail(userCaptor.capture(), eq(vulnerabilities), eq(versionInfo), eq(false));

        // Verify the recipient email is the configured admin email (info.contact)
        User recipient = userCaptor.getValue();
        assertThat(recipient.getEmail()).isEqualTo("admin@uni.de");
        assertThat(recipient.getLangKey()).isEqualTo("en");
    }

    @Test
    void testScanSendsEmailWithUpgradeRecommendationWhenHighVulnerabilitiesAndUpdateAvailable() {
        // Setup mock data with high vulnerabilities
        VulnerabilityDTO highVuln = new VulnerabilityDTO("GHSA-1234", "High severity vulnerability", "Details", "HIGH", 8.5, List.of("CVE-2024-1234"), List.of("1.2.3"),
                List.of("https://example.com"));

        ComponentWithVulnerabilitiesDTO componentWithVuln = new ComponentWithVulnerabilitiesDTO("pkg:npm/example@1.0.0", List.of(highVuln));

        ComponentVulnerabilitiesDTO vulnerabilities = new ComponentVulnerabilitiesDTO(List.of(componentWithVuln), 1, 0, 1, 0, 0, Instant.now().toString());

        ArtemisVersionDTO versionInfo = new ArtemisVersionDTO("7.8.0", "7.9.0", true, "https://github.com/ls1intum/Artemis/releases/tag/7.9.0", "New release",
                Instant.now().toString());

        doReturn(vulnerabilities).when(vulnerabilityService).refreshVulnerabilities();
        doReturn(versionInfo).when(artemisVersionService).getVersionInfo();

        // Execute the scan
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Verify email was sent with upgrade recommendation
        verify(mailService).sendVulnerabilityScanResultEmail(any(User.class), eq(vulnerabilities), eq(versionInfo), eq(true));
    }

    @Test
    void testScanSendsEmailWithUpgradeRecommendationWhenCriticalVulnerabilitiesAndUpdateAvailable() {
        // Setup mock data with critical vulnerabilities
        VulnerabilityDTO criticalVuln = new VulnerabilityDTO("GHSA-5678", "Critical severity vulnerability", "Details", "CRITICAL", 9.8, List.of("CVE-2024-5678"), List.of("2.0.0"),
                List.of("https://example.com"));

        ComponentWithVulnerabilitiesDTO componentWithVuln = new ComponentWithVulnerabilitiesDTO("pkg:maven/org.example:lib@1.0.0", List.of(criticalVuln));

        ComponentVulnerabilitiesDTO vulnerabilities = new ComponentVulnerabilitiesDTO(List.of(componentWithVuln), 1, 1, 0, 0, 0, Instant.now().toString());

        ArtemisVersionDTO versionInfo = new ArtemisVersionDTO("7.8.0", "7.9.0", true, "https://github.com/ls1intum/Artemis/releases/tag/7.9.0", "New release",
                Instant.now().toString());

        doReturn(vulnerabilities).when(vulnerabilityService).refreshVulnerabilities();
        doReturn(versionInfo).when(artemisVersionService).getVersionInfo();

        // Execute the scan
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Verify email was sent with upgrade recommendation
        verify(mailService).sendVulnerabilityScanResultEmail(any(User.class), eq(vulnerabilities), eq(versionInfo), eq(true));
    }

    @Test
    void testScanDoesNotRecommendUpgradeWhenHighVulnerabilitiesButNoUpdateAvailable() {
        // Setup mock data with high vulnerabilities but no update available
        VulnerabilityDTO highVuln = new VulnerabilityDTO("GHSA-1234", "High severity vulnerability", "Details", "HIGH", 8.5, List.of("CVE-2024-1234"), List.of("1.2.3"),
                List.of("https://example.com"));

        ComponentWithVulnerabilitiesDTO componentWithVuln = new ComponentWithVulnerabilitiesDTO("pkg:npm/example@1.0.0", List.of(highVuln));

        ComponentVulnerabilitiesDTO vulnerabilities = new ComponentVulnerabilitiesDTO(List.of(componentWithVuln), 1, 0, 1, 0, 0, Instant.now().toString());

        // No update available
        ArtemisVersionDTO versionInfo = new ArtemisVersionDTO("7.9.0", "7.9.0", false, null, null, Instant.now().toString());

        doReturn(vulnerabilities).when(vulnerabilityService).refreshVulnerabilities();
        doReturn(versionInfo).when(artemisVersionService).getVersionInfo();

        // Execute the scan
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Verify email was sent WITHOUT upgrade recommendation
        verify(mailService).sendVulnerabilityScanResultEmail(any(User.class), eq(vulnerabilities), eq(versionInfo), eq(false));
    }

    @Test
    void testScanDoesNotRecommendUpgradeWhenOnlyMediumLowVulnerabilities() {
        // Setup mock data with only medium and low vulnerabilities
        VulnerabilityDTO mediumVuln = new VulnerabilityDTO("GHSA-1111", "Medium severity vulnerability", "Details", "MEDIUM", 5.5, List.of(), List.of("1.2.3"), List.of());

        VulnerabilityDTO lowVuln = new VulnerabilityDTO("GHSA-2222", "Low severity vulnerability", "Details", "LOW", 2.5, List.of(), List.of("1.2.3"), List.of());

        ComponentWithVulnerabilitiesDTO componentWithVuln = new ComponentWithVulnerabilitiesDTO("pkg:npm/example@1.0.0", List.of(mediumVuln, lowVuln));

        ComponentVulnerabilitiesDTO vulnerabilities = new ComponentVulnerabilitiesDTO(List.of(componentWithVuln), 2, 0, 0, 1, 1, Instant.now().toString());

        // Update is available but no high/critical vulnerabilities
        ArtemisVersionDTO versionInfo = new ArtemisVersionDTO("7.8.0", "7.9.0", true, "https://github.com/ls1intum/Artemis/releases/tag/7.9.0", "New release",
                Instant.now().toString());

        doReturn(vulnerabilities).when(vulnerabilityService).refreshVulnerabilities();
        doReturn(versionInfo).when(artemisVersionService).getVersionInfo();

        // Execute the scan
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Verify email was sent WITHOUT upgrade recommendation (despite update being available)
        verify(mailService).sendVulnerabilityScanResultEmail(any(User.class), eq(vulnerabilities), eq(versionInfo), eq(false));
    }

    @Test
    void testScanHandlesExceptionGracefully() {
        doThrow(new RuntimeException("API error")).when(vulnerabilityService).refreshVulnerabilities();

        // Execute the scan - should not throw exception
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Verify that email was never sent due to exception
        verify(mailService, never()).sendVulnerabilityScanResultEmail(any(), any(), any(), anyBoolean());
    }

    @Test
    void testScanSendsEmailWithCorrectVulnerabilityCountSummary() {
        // Setup mock data with mixed vulnerabilities
        VulnerabilityDTO criticalVuln = new VulnerabilityDTO("GHSA-0001", "Critical", "Details", "CRITICAL", 9.8, List.of(), List.of(), List.of());
        VulnerabilityDTO highVuln1 = new VulnerabilityDTO("GHSA-0002", "High 1", "Details", "HIGH", 8.5, List.of(), List.of(), List.of());
        VulnerabilityDTO highVuln2 = new VulnerabilityDTO("GHSA-0003", "High 2", "Details", "HIGH", 7.5, List.of(), List.of(), List.of());
        VulnerabilityDTO mediumVuln = new VulnerabilityDTO("GHSA-0004", "Medium", "Details", "MEDIUM", 5.5, List.of(), List.of(), List.of());
        VulnerabilityDTO lowVuln = new VulnerabilityDTO("GHSA-0005", "Low", "Details", "LOW", 2.5, List.of(), List.of(), List.of());

        ComponentWithVulnerabilitiesDTO component1 = new ComponentWithVulnerabilitiesDTO("pkg:npm/lib1@1.0.0", List.of(criticalVuln, highVuln1));
        ComponentWithVulnerabilitiesDTO component2 = new ComponentWithVulnerabilitiesDTO("pkg:npm/lib2@2.0.0", List.of(highVuln2, mediumVuln, lowVuln));

        ComponentVulnerabilitiesDTO vulnerabilities = new ComponentVulnerabilitiesDTO(List.of(component1, component2), 5, 1, 2, 1, 1, Instant.now().toString());

        ArtemisVersionDTO versionInfo = new ArtemisVersionDTO("7.8.0", "7.9.0", true, "https://github.com/ls1intum/Artemis/releases/tag/7.9.0", null, Instant.now().toString());

        doReturn(vulnerabilities).when(vulnerabilityService).refreshVulnerabilities();
        doReturn(versionInfo).when(artemisVersionService).getVersionInfo();

        // Execute the scan
        vulnerabilityScanScheduleService.scanVulnerabilitiesAndNotifyAdmin();

        // Capture the vulnerability data sent to the email service
        ArgumentCaptor<ComponentVulnerabilitiesDTO> vulnCaptor = ArgumentCaptor.forClass(ComponentVulnerabilitiesDTO.class);
        verify(mailService).sendVulnerabilityScanResultEmail(any(User.class), vulnCaptor.capture(), eq(versionInfo), eq(true));

        ComponentVulnerabilitiesDTO sentVulnerabilities = vulnCaptor.getValue();
        assertThat(sentVulnerabilities.totalVulnerabilities()).isEqualTo(5);
        assertThat(sentVulnerabilities.criticalCount()).isEqualTo(1);
        assertThat(sentVulnerabilities.highCount()).isEqualTo(2);
        assertThat(sentVulnerabilities.mediumCount()).isEqualTo(1);
        assertThat(sentVulnerabilities.lowCount()).isEqualTo(1);
    }
}

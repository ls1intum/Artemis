package de.tum.cit.aet.artemis.core.service;

import static de.tum.cit.aet.artemis.core.config.Constants.PROFILE_CORE_AND_SCHEDULING;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Lazy;
import org.springframework.context.annotation.Profile;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import de.tum.cit.aet.artemis.communication.service.notifications.MailService;
import de.tum.cit.aet.artemis.core.domain.User;
import de.tum.cit.aet.artemis.core.dto.ArtemisVersionDTO;
import de.tum.cit.aet.artemis.core.dto.ComponentVulnerabilitiesDTO;

/**
 * Service responsible for scheduling weekly vulnerability scans and sending email notifications to administrators.
 * <p>
 * This service runs a cron job once per week to fetch security vulnerabilities from the OSV API
 * and sends a summary email to the configured admin email address. If critical or high severity vulnerabilities
 * are found and a new Artemis release is available, the email includes a recommendation to upgrade.
 * <p>
 * The email is only sent on production servers, not on test servers or development environments.
 */
@Lazy
@Service
@Profile(PROFILE_CORE_AND_SCHEDULING)
public class VulnerabilityScanScheduleService {

    private static final Logger log = LoggerFactory.getLogger(VulnerabilityScanScheduleService.class);

    @Value("${info.contact:}")
    private String adminEmail;

    @Value("${info.testServer:false}")
    private boolean isTestServer;

    private final VulnerabilityService vulnerabilityService;

    private final ArtemisVersionService artemisVersionService;

    private final MailService mailService;

    private final ProfileService profileService;

    /**
     * Creates a new VulnerabilityScanScheduleService with the required dependencies.
     *
     * @param vulnerabilityService  the service for fetching vulnerability data
     * @param artemisVersionService the service for checking Artemis version information
     * @param mailService           the service for sending emails
     * @param profileService        the service for checking active profiles
     */
    public VulnerabilityScanScheduleService(VulnerabilityService vulnerabilityService, ArtemisVersionService artemisVersionService, MailService mailService,
            ProfileService profileService) {
        this.vulnerabilityService = vulnerabilityService;
        this.artemisVersionService = artemisVersionService;
        this.mailService = mailService;
        this.profileService = profileService;
    }

    /**
     * Scheduled task that runs weekly to scan for vulnerabilities and send email notifications.
     * <p>
     * The job runs every Monday at 8:00 AM by default. It can be configured via the
     * {@code artemis.scheduling.vulnerability-scan-time} property.
     * <p>
     * The email notification includes:
     * <ul>
     * <li>A summary of vulnerabilities by severity (critical, high, medium, low)</li>
     * <li>The timestamp of the last vulnerability check</li>
     * <li>A recommendation to upgrade if there are high/critical vulnerabilities AND a new release is available</li>
     * </ul>
     * <p>
     * The scan is skipped on development environments and test servers.
     */
    @Scheduled(cron = "${artemis.scheduling.vulnerability-scan-time:0 0 8 * * MON}")
    public void scanVulnerabilitiesAndNotifyAdmin() {
        if (profileService.isDevActive()) {
            // Do not execute this in a development environment
            // NOTE: if you want to test this locally, please comment it out, but do not commit the changes
            return;
        }

        if (isTestServer) {
            // Do not send vulnerability emails on test servers
            log.debug("Skipping vulnerability scan email on test server");
            return;
        }

        log.info("Starting weekly vulnerability scan");

        // Check if admin email is configured
        if (!StringUtils.hasText(adminEmail)) {
            log.warn("Admin email (info.contact) is not configured. Cannot send vulnerability scan notification email.");
            return;
        }

        try {
            // Refresh vulnerability data from OSV API
            ComponentVulnerabilitiesDTO vulnerabilities = vulnerabilityService.refreshVulnerabilities();

            // Get version information to check if an update is available
            ArtemisVersionDTO versionInfo = artemisVersionService.getVersionInfo();

            // Determine if we should recommend an upgrade
            boolean hasHighOrCriticalVulnerabilities = vulnerabilities.criticalCount() > 0 || vulnerabilities.highCount() > 0;
            boolean shouldRecommendUpgrade = hasHighOrCriticalVulnerabilities && versionInfo.updateAvailable();

            // Create a recipient user object with the admin email
            User recipient = new User();
            recipient.setEmail(adminEmail);
            recipient.setLangKey("en");
            recipient.setLogin("vulnerability-scan-recipient");

            // Send the notification email
            mailService.sendVulnerabilityScanResultEmail(recipient, vulnerabilities, versionInfo, shouldRecommendUpgrade);

            log.info("Vulnerability scan completed. Found {} total vulnerabilities ({} critical, {} high, {} medium, {} low). Email sent to {}.",
                    vulnerabilities.totalVulnerabilities(), vulnerabilities.criticalCount(), vulnerabilities.highCount(), vulnerabilities.mediumCount(), vulnerabilities.lowCount(),
                    adminEmail);
        }
        catch (Exception e) {
            log.error("Failed to complete vulnerability scan or send notification email", e);
        }
    }
}

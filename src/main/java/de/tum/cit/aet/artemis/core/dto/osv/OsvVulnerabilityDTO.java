package de.tum.cit.aet.artemis.core.dto.osv;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonProperty;

/**
 * DTO representing a vulnerability from the OSV database.
 * Contains comprehensive information about a security vulnerability including
 * severity, affected packages, and remediation information.
 *
 * @param id               the unique vulnerability identifier (e.g., "CVE-2024-1234", "GHSA-xxxx-xxxx-xxxx")
 * @param summary          a brief one-line summary of the vulnerability
 * @param details          detailed description of the vulnerability and its impact
 * @param aliases          alternative identifiers for this vulnerability (e.g., CVE IDs)
 * @param severity         list of severity ratings (CVSS scores)
 * @param affected         list of affected package ranges and versions
 * @param references       list of URLs with more information about the vulnerability
 * @param databaseSpecific database-specific metadata (may contain additional severity info)
 * @see <a href="https://ossf.github.io/osv-schema/">OSV Schema Documentation</a>
 */
@JsonInclude(JsonInclude.Include.NON_EMPTY)
@JsonIgnoreProperties(ignoreUnknown = true)
public record OsvVulnerabilityDTO(String id, String summary, String details, List<String> aliases, List<OsvSeverityDTO> severity, List<OsvAffectedDTO> affected,
        List<OsvReferenceDTO> references, @JsonProperty("database_specific") OsvDatabaseSpecificDTO databaseSpecific) {

    /**
     * Represents a severity rating in CVSS format.
     *
     * @param type  the CVSS version (e.g., "CVSS_V3", "CVSS_V2")
     * @param score the CVSS vector string or numeric score
     */
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    @JsonIgnoreProperties(ignoreUnknown = true)
    public record OsvSeverityDTO(String type, String score) {
    }

    /**
     * Represents an affected package with version ranges and fix information.
     *
     * @param packageInfo      the affected package details
     * @param ranges           list of affected version ranges with fix events
     * @param databaseSpecific database-specific metadata including last known affected version range
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    public record OsvAffectedDTO(@JsonProperty("package") OsvPackageDTO packageInfo, List<OsvRangeDTO> ranges,
            @JsonProperty("database_specific") OsvAffectedDatabaseSpecificDTO databaseSpecific) {
    }

    /**
     * Represents database-specific metadata for an affected package.
     * Contains the last known affected version range which can be used for version filtering
     * when the standard range events don't include a fixed version.
     *
     * @param lastKnownAffectedVersionRange version range string like "&lt; 0.19.3" or "&lt;= 1.2.0"
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    public record OsvAffectedDatabaseSpecificDTO(@JsonProperty("last_known_affected_version_range") String lastKnownAffectedVersionRange) {
    }

    /**
     * Represents a version range with events marking vulnerability introduction and fixes.
     *
     * @param type   the range type (e.g., "ECOSYSTEM", "SEMVER", "GIT")
     * @param events list of events marking version boundaries
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    public record OsvRangeDTO(String type, List<OsvEventDTO> events) {
    }

    /**
     * Represents a version event in a range (introduction, fix, or limit).
     *
     * @param introduced the version where the vulnerability was introduced
     * @param fixed      the version where the vulnerability was fixed
     * @param limit      the upper limit of affected versions
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    public record OsvEventDTO(String introduced, String fixed, String limit) {
    }

    /**
     * Represents a reference URL with type information.
     *
     * @param type the reference type (e.g., "ADVISORY", "FIX", "REPORT", "WEB")
     * @param url  the URL to the reference
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    public record OsvReferenceDTO(String type, String url) {
    }

    /**
     * Represents database-specific metadata, which may include severity information
     * not available in the standard CVSS fields.
     *
     * @param severity a human-readable severity string (e.g., "HIGH", "CRITICAL")
     */
    @JsonIgnoreProperties(ignoreUnknown = true)
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    public record OsvDatabaseSpecificDTO(String severity) {
    }
}

<div class="editable-instruction-container">
    <!-- AI Refinement in progress banner -->
    @if (isGeneratingOrRefining()) {
        <div class="alert alert-info d-flex align-items-center mb-2 py-2">
            <fa-icon [icon]="faSpinner" animation="spin" class="me-2" />
            <span jhiTranslate="artemisApp.programmingExercise.problemStatement.aiRefining"></span>
        </div>
    }
    <!-- The position of the markdown-editor in the html should not be changed, as it is used for resizing!-->
    @if (exercise) {
        <!-- showPreview controls whether the preview tab is available in the markdown editor.
             Set to false when using an external preview component (e.g., in the code editor view). -->
        <jhi-markdown-editor-monaco
            class="overflow-hidden flex-grow-1"
            [mode]="mode()"
            [domainActions]="domainActions"
            [artemisIntelligenceActions]="artemisIntelligenceActions()"
            [initialEditorHeight]="initialEditorHeight"
            [externalHeight]="externalHeight"
            [useDefaultMarkdownEditorOptions]="false"
            [enableResize]="enableResize"
            [markdown]="exercise.problemStatement"
            [showDefaultPreview]="false"
            [showPreviewButton]="showPreview"
            [showEditButton]="showPreview"
            [readOnly]="isGeneratingOrRefining()"
            [isAiLoading]="isAiApplying()"
            [renderSideBySide]="renderSideBySide()"
            [consistencyIssues]="consistencyIssues()"
            (markdownChange)="updateProblemStatement($event)"
            (diffLineChange)="diffLineChange.emit($event)"
            (onSelectionChange)="onEditorSelectionChange($event)"
        >
            <!-- Custom preview using ProgrammingExerciseInstructionComponent for proper rendering
                 of programming-specific syntax (task markers, PlantUML, test case status, etc.).
                 Uses templateParticipation if available (code editor context), otherwise falls back to participation.
                 The div wrapper with id="previewMonaco" is projected into the markdown editor's preview slot.
                 Only renders when showPreview is true AND we have a valid participation to display results. -->
            <div id="previewMonaco" class="instructions-preview-wrapper">
                @if (showPreview && (templateParticipation ?? participation)) {
                    <jhi-programming-exercise-instructions
                        class="instructions-preview"
                        [exercise]="exercise"
                        [participation]="(templateParticipation ?? participation)!"
                        [personalParticipation]="false"
                        [generateHtmlEvents]="generateHtmlSubject.asObservable()"
                    />
                }
            </div>
        </jhi-markdown-editor-monaco>

        <!-- Floating inline refinement button - hidden during active refinement -->
        @if (inlineRefinementPosition() && hyperionEnabled && !isAiApplying() && selectionPositionInfo()) {
            <jhi-inline-refinement-button
                [top]="inlineRefinementPosition()!.top"
                [left]="inlineRefinementPosition()!.left"
                [selectedText]="selectedTextForRefinement()"
                [startLine]="selectionPositionInfo()!.startLine"
                [endLine]="selectionPositionInfo()!.endLine"
                [startColumn]="selectionPositionInfo()!.startColumn"
                [endColumn]="selectionPositionInfo()!.endColumn"
                [isLoading]="isAiApplying()"
                (refine)="onInlineRefine($event)"
                (closeRefinement)="hideInlineRefinementButton()"
            />
        }
    }
    @if (editMode) {
        <button
            id="save-instructions-button"
            [disabled]="savingInstructions || !unsavedChangesValue || mode() === 'diff'"
            (click)="saveInstructions($event)"
            class="btn editable-instruction-container__save"
            [ngClass]="{
                'btn-light': savingInstructions || !unsavedChangesValue || mode() === 'diff',
                'btn-primary': !(savingInstructions || !unsavedChangesValue || mode() === 'diff'),
                'btn-sm': externalHeight,
            }"
        >
            @if (!savingInstructions) {
                <fa-icon [icon]="faSave" class="me-2" />
            }
            @if (savingInstructions) {
                <fa-icon [icon]="faCircleNotch" animation="spin" class="me-2" />
            }
            <span jhiTranslate="entity.action.save"></span>
        </button>
    }
    @if (showStatus) {
        <div class="card-footer text-nowrap editable-instruction-container__status">
            <div class="instructions-status">
                @if (!unsavedChangesValue && !savingInstructions) {
                    <div>
                        <fa-icon [icon]="faCheckCircle" class="text-success me-1" ngbTooltip="{{ 'artemisApp.programmingExercise.editable.savedTooltip' | artemisTranslate }}" />
                        <span class="text-info" jhiTranslate="artemisApp.programmingExercise.editable.saved"></span>
                    </div>
                }
                @if (unsavedChangesValue && !savingInstructions) {
                    <div>
                        <fa-icon
                            [icon]="faExclamationTriangle"
                            class="text-warning me-1"
                            ngbTooltip="{{ 'artemisApp.programmingExercise.editable.unsavedTooltip' | artemisTranslate }}"
                        />
                        <span class="text-info" jhiTranslate="artemisApp.programmingExercise.editable.unsaved"></span>
                    </div>
                }
                @if (savingInstructions) {
                    <div>
                        <fa-icon [icon]="faCircleNotch" class="me-1" ngbTooltip="{{ 'artemisApp.programmingExercise.editable.savingTooltip' | artemisTranslate }}" />
                        <span class="text-info" jhiTranslate="artemisApp.programmingExercise.editable.saving"></span>
                    </div>
                }
            </div>
            @if (exercise?.id) {
                <jhi-programming-exercise-instruction-instructor-analysis
                    [exerciseTestCases]="exerciseTestCases"
                    [problemStatement]="exercise.problemStatement || ''"
                    [taskRegex]="taskRegex"
                    (problemStatementAnalysis)="onAnalysisUpdate($event)"
                    class="editable-instruction-container__status__testcase"
                />
            }
        </div>
    }
</div>

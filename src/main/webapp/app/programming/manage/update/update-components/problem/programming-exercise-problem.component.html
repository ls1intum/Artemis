<section>
    <h3 jhiTranslate="artemisApp.programmingExercise.wizardMode.detailedSteps.problemStepTitle" id="artemisApp.programmingExercise.wizardMode.detailedSteps.problemStepTitle"></h3>
    <p jhiTranslate="artemisApp.programmingExercise.wizardMode.detailedSteps.problemStepMessage"></p>
    <!-- Generate Draft Problem Statement Button -->
    <div class="btn-group" ngbDropdown role="group" aria-label="AI Problem Statement Generation">
        <button class="btn btn-outline-primary" type="button" (click)="openGeneratePopover($event)">
            @if (isGenerating) {
                <fa-icon [icon]="faSpinner" animation="spin" />
            } @else {
                <fa-icon [icon]="facArtemisIntelligence" />
            }
            <span class="ms-2" jhiTranslate="artemisApp.programmingExercise.problemStatement.generationAssistance">Generation Assistance</span>
        </button>
    </div>

    <!-- Problem Statement Generation Popover -->
    <p-popover #generatePopover [style]="{ width: '500px' }">
        <div class="p-4">
            <h4 class="mb-3" jhiTranslate="artemisApp.programmingExercise.problemStatement.generateDraftTitle"></h4>
            <p class="text-sm text-muted mb-3" jhiTranslate="artemisApp.programmingExercise.problemStatement.generateDraftDescription"></p>

            <!-- User Prompt Input -->
            <div class="mb-4">
                <label for="userPrompt" class="form-label" jhiTranslate="artemisApp.programmingExercise.problemStatement.yourRequirements"></label>
                <textarea
                    id="userPrompt"
                    [(ngModel)]="userPrompt"
                    class="form-control"
                    rows="4"
                    [placeholder]="isGenerating ? userPrompt : getTranslatedPlaceholder()"
                    [disabled]="isGenerating"
                >
                </textarea>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
                <button type="button" id="cancel-generation" class="btn btn-sm btn-secondary" (click)="cancelGeneration()">
                    <fa-icon [fixedWidth]="true" [icon]="faBan" class="sm" />
                    <span class="d-none d-sm-inline" jhiTranslate="entity.action.cancel"></span>
                </button>
                <jhi-button
                    id="save-entity"
                    [shouldToggle]="true"
                    [disabled]="!userPrompt?.trim() || isGenerating"
                    [isLoading]="isGenerating"
                    [icon]="faSave"
                    [title]="'entity.action.generate'"
                    (click)="generateProblemStatement()"
                    [btnSize]="ButtonSize.SMALL"
                />
            </div>
        </div>
    </p-popover>
    @if (isEditFieldDisplayedRecord()?.problemStatement) {
        <div class="form-group" id="field_problemStatement" name="problemStatement">
            <label class="form-control-label" for="field_problemStatement" jhiTranslate="artemisApp.programmingExercise.problemStatement.title"></label>
            @if (programmingExerciseCreationConfig.isImportFromExistingExercise || programmingExerciseCreationConfig.isImportFromFile) {
                <ngb-alert [dismissible]="false">
                    <span class="font-weight-bold">
                        {{ 'artemisApp.exercise.import.attention' | artemisTranslate }}
                    </span>
                    <span
                        jhiTranslate="{{
                            programmingExerciseCreationConfig.isImportFromExistingExercise
                                ? 'artemisApp.exercise.import.markdownWarning'
                                : 'artemisApp.exercise.import.embeddedFilesWarning'
                        }}"
                    ></span>
                </ngb-alert>
            }
            @if (programmingExerciseCreationConfig.isImportFromExistingExercise) {
                <jhi-programming-exercise-instructions
                    [exercise]="programmingExercise()!"
                    [participation]="programmingExercise()?.templateParticipation!"
                    [personalParticipation]="false"
                />
            }
            @if (
                programmingExerciseCreationConfig.problemStatementLoaded &&
                programmingExerciseCreationConfig.templateParticipationResultLoaded &&
                !programmingExerciseCreationConfig.isImportFromExistingExercise
            ) {
                <jhi-programming-exercise-editable-instructions
                    [participation]="programmingExercise()?.templateParticipation!"
                    [exercise]="programmingExercise()!"
                    [initialEditorHeight]="MarkdownEditorHeight.MEDIUM"
                    [showStatus]="!!programmingExercise()?.id"
                    [editMode]="!!programmingExercise()?.id"
                    (hasUnsavedChanges)="programmingExerciseCreationConfig.hasUnsavedChanges = $event"
                    (instructionChange)="problemStatementChange.emit($event)"
                    [forceRender]="programmingExerciseCreationConfig.rerenderSubject"
                    class="form__editable-instructions"
                />
            }
        </div>
    }
    @if (isEditFieldDisplayedRecord()?.linkedCompetencies && !programmingExerciseCreationConfig.isExamMode) {
        <div class="form-group">
            <jhi-competency-selection
                id="competencies"
                [labelName]="'artemisApp.competency.link.title' | artemisTranslate"
                [labelTooltip]="'artemisApp.competency.link.exercise' | artemisTranslate"
                [exerciseDescription]="programmingExercise.problemStatement || programmingExercise.title"
                [(ngModel)]="programmingExercise.competencyLinks"
                name="competencyLinks"
            />
        </div>
    }
</section>

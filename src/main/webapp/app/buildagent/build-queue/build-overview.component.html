<div [class.build-overview-course-view]="courseId">
    @if (!courseId) {
        <h5 *adminTitleBarTitle id="build-overview-heading" class="mb-0" jhiTranslate="artemisApp.buildQueue.title"></h5>
        <div *adminTitleBarActions class="d-flex align-items-center gap-2">
            <span class="text-muted small" jhiTranslate="artemisApp.buildQueue.jumpTo"></span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" (click)="scrollToSection('build-queue-running-heading')">
                    <span jhiTranslate="artemisApp.buildQueue.running"></span>
                    <span class="badge bg-primary ms-1">{{ runningBuildJobs()?.length || 0 }}</span>
                </button>
                <button class="btn btn-outline-secondary" (click)="scrollToSection('build-queue-queued-heading')">
                    <span jhiTranslate="artemisApp.buildQueue.queued"></span>
                    <span class="badge bg-primary ms-1">{{ queuedBuildJobs()?.length || 0 }}</span>
                </button>
                <button class="btn btn-outline-secondary" (click)="scrollToSection('build-queue-finished-heading')">
                    <span jhiTranslate="artemisApp.buildQueue.finished"></span>
                </button>
            </div>
            <span
                class="text-muted small"
                jhiTranslate="artemisApp.buildQueue.buildCapacityInfo"
                [translateValues]="{ running: currentBuilds(), capacity: buildCapacity(), agents: onlineAgents() }"
            ></span>
        </div>
    }

    @if (courseId) {
        <!-- Navigation bar for course management view -->
        <div class="build-queue-nav-bar">
            <div class="d-flex justify-content-end align-items-center gap-2">
                <span class="text-muted small" jhiTranslate="artemisApp.buildQueue.jumpTo"></span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" (click)="scrollToSection('build-queue-running-heading')">
                        <span jhiTranslate="artemisApp.buildQueue.running"></span>
                        <span class="badge bg-primary ms-1">{{ runningBuildJobs()?.length || 0 }}</span>
                    </button>
                    <button class="btn btn-outline-secondary" (click)="scrollToSection('build-queue-queued-heading')">
                        <span jhiTranslate="artemisApp.buildQueue.queued"></span>
                        <span class="badge bg-primary ms-1">{{ queuedBuildJobs()?.length || 0 }}</span>
                    </button>
                    <button class="btn btn-outline-secondary" (click)="scrollToSection('build-queue-finished-heading')">
                        <span jhiTranslate="artemisApp.buildQueue.finished"></span>
                    </button>
                </div>
                <span
                    class="text-muted small"
                    jhiTranslate="artemisApp.buildQueue.buildCapacityInfo"
                    [translateValues]="{ running: currentBuilds(), capacity: buildCapacity(), agents: onlineAgents() }"
                ></span>
            </div>
        </div>
    }

    <div class="build-queue-main-content">
        <jhi-build-job-statistics #statisticsComponent />

        <div class="mb-5">
            <div class="d-flex align-items-center gap-3 mb-3">
                <h5 id="build-queue-running-heading" class="mb-0">
                    <span jhiTranslate="artemisApp.buildAgents.runningBuildJobs"></span>
                    <span class="badge bg-primary ms-2">{{ runningBuildJobs()?.length ?? 0 }}</span>
                </h5>
                @if (runningBuildJobs()?.length) {
                    <button class="btn btn-danger btn-sm" (click)="cancelAllRunningBuildJobs()">
                        <fa-icon [icon]="faTimes" />
                        <span jhiTranslate="artemisApp.buildQueue.cancelAll"></span>
                    </button>
                }
            </div>
            <jhi-running-jobs-table
                [buildJobs]="runningBuildJobs()"
                [showCourseId]="isAdministrationView()"
                [isAdminView]="isAdministrationView()"
                (cancelJob)="cancelBuildJob($event)"
                (jobClick)="navigateToJobDetail($event)"
            />
        </div>
        <div class="mb-5">
            <div class="d-flex align-items-center gap-3 mb-3">
                <h5 id="build-queue-queued-heading" class="mb-0">
                    <span jhiTranslate="artemisApp.buildQueue.queuedBuildJobs"></span>
                    <span class="badge bg-secondary ms-2">{{ queuedBuildJobs()?.length ?? 0 }}</span>
                </h5>
                @if (queuedBuildJobs()?.length) {
                    <button class="btn btn-danger btn-sm" (click)="cancelAllQueuedBuildJobs()">
                        <fa-icon [icon]="faTimes" />
                        <span jhiTranslate="artemisApp.buildQueue.cancelAll"></span>
                    </button>
                }
            </div>
            <jhi-queued-jobs-table
                [buildJobs]="queuedBuildJobs()"
                [showCourseId]="isAdministrationView()"
                (cancelJob)="cancelBuildJob($event)"
                (jobClick)="navigateToJobDetail($event)"
            />
        </div>
        <div>
            <div class="d-flex justify-content-between">
                <div class="d-flex align-items-center">
                    <h5 id="build-queue-finished-heading" class="mb-0 me-2">
                        <span jhiTranslate="artemisApp.buildQueue.finishedBuildJobs"></span>
                        <span class="badge bg-info ms-2">{{ finishedBuildJobs()?.length ?? 0 }}</span>
                    </h5>
                    <div class="form-group form-inline my-0 mx-1">
                        <input class="form-control ms-3" type="text" name="searchTerm" id="field_searchTerm" [(ngModel)]="searchTerm" (focusout)="triggerLoadFinishedJobs()" />
                        <jhi-help-icon class="ps-1" text="artemisApp.buildQueue.filter.search.tooltip" />
                        <button class="btn btn-primary ms-3" (click)="triggerLoadFinishedJobs()">
                            <span jhiTranslate="artemisApp.buildQueue.filter.search.title"></span>
                        </button>
                    </div>
                    <button class="btn btn-primary" (click)="loadFinishedBuildJobs()">
                        <fa-icon [icon]="faSync" />
                        <span jhiTranslate="metrics.refresh.button"></span>
                    </button>
                    @if (isLoading()) {
                        <span class="ms-3" jhiTranslate="artemisApp.buildQueue.filter.search.loading"></span>
                    }
                </div>
                <div>
                    <button
                        class="btn"
                        (click)="this.openFilterModal()"
                        [ngClass]="{ 'btn-secondary': !finishedBuildJobFilter?.numberOfAppliedFilters, 'btn-success': !!finishedBuildJobFilter?.numberOfAppliedFilters }"
                    >
                        <fa-icon [icon]="faFilter" />
                        <span class="d-s-none d-md-inline">
                            <span jhiTranslate="artemisApp.buildQueue.filter.open" [translateValues]="{ num: finishedBuildJobFilter?.numberOfAppliedFilters ?? 0 }"></span>
                        </span>
                    </button>
                </div>
            </div>
            <jhi-finished-jobs-table
                [buildJobs]="finishedBuildJobs()"
                [showCourseId]="isAdministrationView()"
                [isAdminView]="isAdministrationView()"
                [(predicate)]="predicate"
                [(ascending)]="ascending"
                (sortChange)="loadFinishedBuildJobs()"
                (jobClick)="navigateToJobDetail($event)"
                (viewLogs)="viewBuildLogs(buildLogsModal, $event)"
            />
            @if (finishedBuildJobs()) {
                <div>
                    <div class="row justify-content-center">
                        <jhi-slice-navigator [config]="paginationConfig" [hasMoreItems]="hasMore()" [isLoading]="isLoading()" (pageChange)="onPageChange($event)" />
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Modal -->
    <ng-template #buildLogsModal let-modal>
        <div class="modal-header">
            <h5 class="modal-title">
                <span jhiTranslate="artemisApp.buildQueue.logs.title"></span>
                <span> {{ this.displayedBuildJobId }}</span>
            </h5>
            <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
        </div>
        <div class="modal-body">
            <table class="table table-borderless">
                <tbody>
                    @if (rawBuildLogsString) {
                        <pre>{{ rawBuildLogsString }}</pre>
                    } @else {
                        <span jhiTranslate="artemisApp.buildQueue.logs.noLogs"></span>
                    }
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modal.close()">
                <span jhiTranslate="artemisApp.buildQueue.filter.close"></span>
            </button>
            <button class="btn btn-primary" (click)="downloadBuildLogs()">
                <span jhiTranslate="artemisApp.buildQueue.logs.download"></span>
            </button>
        </div>
    </ng-template>
</div>

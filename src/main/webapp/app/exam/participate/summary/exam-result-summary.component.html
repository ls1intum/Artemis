<div>
    <h2>
        <ng-container>
            {{ 'artemisApp.exam.examSummary.examResults' | artemisTranslate }}
        </ng-container>
        <button id="exportToPDFButton" class="btn btn-primary float-end" (click)="printPDF()">
            <fa-icon [icon]="faPrint"></fa-icon>
            <span jhiTranslate="artemisApp.exam.examSummary.exportPDF">Export PDF</span>
        </button>
    </h2>
</div>
@if (studentExam?.exam) {
    <jhi-exam-general-information
        [exam]="studentExam.exam!"
        [studentExam]="studentExam"
        [reviewIsOpen]="studentExam?.exam && isBeforeStudentReviewEnd && isAfterStudentReviewStart && !isTestRun"
    />
}
@if (studentExam && studentExam.exercises && studentExam.exam?.course && studentExamGradeInfoDTO) {
    <div class="mb-4" id="exam-summary-result-overview">
        <jhi-exam-result-overview
            [studentExamWithGrade]="studentExamGradeInfoDTO!"
            [isGradingKeyCollapsed]="isGradingKeyCollapsed"
            [isBonusGradingKeyCollapsed]="isBonusGradingKeyCollapsed"
            [exerciseInfos]="exerciseInfos"
            [isTestRun]="isTestRun"
        />
    </div>
}
@if (!resultsArePublished) {
    <div class="mb-0">
        <fa-icon [icon]="faInfoCircle" class="info-icon"></fa-icon>
        {{ 'artemisApp.exam.resultInformation' | artemisTranslate }}
    </div>
}
<h3>
    {{ 'artemisApp.exam.exercises' | artemisTranslate }}
</h3>
@if (quizExam) {
    <div>
        <div class="question card">
            <jhi-result-summary-exercise-card-header
                [index]="0"
                [id]="0"
                [title]="quizExam!.title"
                [exerciseType]="ExerciseType.QUIZ"
                [maxPoints]="quizExam!.maxPoints"
                [submissionType]="MANUAL"
                [exerciseInfo]="quizExamInfo"
                [resultsPublished]="resultsArePublished"
            />
            <div class="card-body question-card-body" [ngbCollapse]="quizExamInfo.isCollapsed">
                <div class="clearfix"></div>
                <div>
                    <jhi-quiz-exam-summary
                        [quizConfiguration]="quizExam!"
                        [exam]="studentExam.exam!"
                        [submission]="quizExam!.submission"
                        [resultsPublished]="resultsArePublished"
                    />
                </div>
            </div>
        </div>
    </div>
}
@for (exercise of studentExam?.exercises; track exercise; let i = $index) {
    <div [id]="'exercise-' + exercise.id">
        <div class="question card">
            <jhi-result-summary-exercise-card-header
                [index]="i + (quizExam ? 1 : 0)"
                [id]="exercise.id"
                [title]="exercise.exerciseGroup?.title"
                [exerciseType]="exercise?.type"
                [maxPoints]="exercise.maxPoints"
                [submissionType]="exercise.studentParticipations?.[0]?.submissions?.[0]?.type"
                [exerciseInfo]="exerciseInfos[exercise.id!]"
                [resultsPublished]="resultsArePublished"
            />
            <div class="card-body question-card-body" [ngbCollapse]="exerciseInfos[exercise.id!].isCollapsed">
                <div class="clearfix">
                    <span class="exercise-buttons">
                        @if (plagiarismCaseInfos[exercise.id!]) {
                            <a
                                class="btn ms-2 float-end"
                                [ngClass]="plagiarismCaseInfos[exercise.id!]!.verdict === PlagiarismVerdict.NO_PLAGIARISM ? 'btn-info' : 'btn-danger'"
                                [routerLink]="['/courses', courseId, 'plagiarism-cases', plagiarismCaseInfos[exercise.id!]!.id]"
                            >
                                <span
                                    [jhiTranslate]="
                                        'artemisApp.plagiarism.plagiarismCases.' +
                                        (plagiarismCaseInfos[exercise.id!]!.verdict === PlagiarismVerdict.NO_PLAGIARISM ? 'resolvedPlagiarismCase' : 'plagiarismCase')
                                    "
                                >
                                    Plagiarism Case
                                </span>
                            </a>
                        }
                        @if (exampleSolutionPublished) {
                            @if (exerciseInfos[exercise.id!].displayExampleSolution) {
                                <span class="alert alert-info p-1" jhiTranslate="artemisApp.exam.examSummary.youAreViewingTheExampleSolution">
                                    You are viewing the example solution.
                                </span>
                            }
                            @if (exercise.type !== QUIZ && exercise.type !== PROGRAMMING) {
                                <button
                                    [id]="'show-sample-solution-button-' + exercise.id"
                                    class="btn float-end"
                                    [class]="exerciseInfos[exercise.id!].displayExampleSolution ? 'btn-primary' : 'btn-outline-primary'"
                                    (click)="toggleShowSampleSolution(exercise.id)"
                                >
                                    <fa-icon [icon]="!exerciseInfos[exercise.id!].displayExampleSolution ? faEye : faEyeSlash" class="info-icon"></fa-icon>
                                    @if (!exerciseInfos[exercise.id!].displayExampleSolution) {
                                        <span>&nbsp;{{ 'artemisApp.exam.examSummary.showExampleSolution' | artemisTranslate }}&nbsp;</span>
                                    } @else {
                                        {{ 'artemisApp.exam.examSummary.hideExampleSolution' | artemisTranslate }}
                                    }
                                </button>
                            }
                            @if (exercise.type === PROGRAMMING) {
                                <jhi-programming-exercise-example-solution-repo-download
                                    class="ms-2 float-end"
                                    [exerciseId]="exercise.id!"
                                    [title]="'artemisApp.programmingExercise.export.downloadExampleSolution'"
                                    [displayedOnExamSummary]="true"
                                />
                                @if (exerciseInfos[exercise.id!].releaseTestsWithExampleSolution) {
                                    <jhi-programming-exercise-example-solution-repo-download
                                        class="ms-2 float-end"
                                        [exerciseId]="exercise.id!"
                                        [includeTests]="true"
                                        [title]="'artemisApp.programmingExercise.export.downloadTestsWithExampleSolution'"
                                        [displayedOnExamSummary]="true"
                                        ngbTooltip="{{ 'artemisApp.programmingExercise.studentDownloadTestsTooltip' | artemisTranslate }}"
                                    />
                                }
                            }
                        }
                    </span>
                </div>
                @if (exercise.type !== PROGRAMMING) {
                    <ng-container class="pt-2">
                        @if (exerciseInfos[exercise.id!].displayExampleSolution) {
                            <div>
                                @if (exercise.id !== undefined) {
                                    <jhi-example-solution [exerciseId]="exercise.id" [displayHeader]="false" />
                                }
                            </div>
                        } @else {
                            @if (exerciseInfos[exercise.id!]?.participation && exerciseInfos[exercise.id!]?.submission?.submitted) {
                                @switch (exercise.type) {
                                    @case (TEXT) {
                                        <jhi-text-exam-summary
                                            [exercise]="exercise"
                                            [submission]="exerciseInfos[exercise.id!]!.submission!"
                                            [expandProblemStatement]="expandProblemStatement"
                                            [isAfterResultsArePublished]="resultsArePublished"
                                        />
                                    }
                                    @case (MODELING) {
                                        <jhi-modeling-exam-summary
                                            [exercise]="exercise"
                                            [submission]="exerciseInfos[exercise.id!]!.submission!"
                                            [isPrinting]="isPrinting"
                                            [expandProblemStatement]="expandProblemStatement"
                                            [isAfterResultsArePublished]="resultsArePublished"
                                        />
                                    }
                                    @case (QUIZ) {
                                        <jhi-quiz-exam-summary
                                            [quizConfiguration]="exercise"
                                            [exam]="studentExam.exam!"
                                            [submission]="exerciseInfos[exercise.id!]!.submission!"
                                            [resultsPublished]="resultsArePublished"
                                        />
                                    }
                                    @case (FILE_UPLOAD) {
                                        <jhi-file-upload-exam-summary
                                            [submission]="exerciseInfos[exercise.id!]!.submission!"
                                            [exercise]="exercise"
                                            [expandProblemStatement]="expandProblemStatement"
                                            [isAfterResultsArePublished]="resultsArePublished"
                                        />
                                    }
                                }
                                @if (exerciseInfos[exercise.id!]!.submission! && exercise.type !== QUIZ && isAfterStudentReviewStart) {
                                    <jhi-complaint-student-view
                                        class="mb-2 mt-2 ms-3"
                                        [exercise]="exercise"
                                        [participation]="exerciseInfos[exercise.id!]!.participation!"
                                        [result]="exerciseInfos[exercise.id!]!.participation!.results?.[0]"
                                        [exam]="examWithOnlyIdAndStudentReviewPeriod"
                                        [testRun]="isTestRun"
                                    >
                                    </jhi-complaint-student-view>
                                }
                            } @else {
                                {{ 'artemisApp.exam.examSummary.noSubmissionFound' | artemisTranslate }}
                            }
                        }
                        <!-- Show submission of student - if no submission found -> display that student did not participate -->
                    </ng-container>
                }
                @if (exercise.type === PROGRAMMING) {
                    <!--  relax condition for programming exercises for the case that we get a submissions from websockets, but last changes in exam were not submitted -->
                    @if (exerciseInfos[exercise.id!]?.participation && exerciseInfos[exercise.id!]?.submission!) {
                        <jhi-programming-exam-summary
                            [exercise]="exercise"
                            [participation]="exerciseInfos[exercise.id!]!.participation!"
                            [submission]="exerciseInfos[exercise.id!]!.submission!"
                            [isTestRun]="isTestRun"
                            [exam]="examWithOnlyIdAndStudentReviewPeriod"
                            [isAfterStudentReviewStart]="isAfterStudentReviewStart"
                            [resultsPublished]="resultsArePublished"
                            [isPrinting]="isPrinting"
                            [isAfterResultsArePublished]="resultsArePublished"
                        />
                    } @else {
                        {{ 'artemisApp.exam.examSummary.noSubmissionFound' | artemisTranslate }}
                    }
                }
            </div>
        </div>
    </div>
}
<button class="btn btn-light mx-auto d-block" (click)="scrollToOverviewOrTop()" id="back-to-overview-button">
    <fa-icon [icon]="faArrowUp"></fa-icon>
    <span>&nbsp; {{ 'artemisApp.exam.examSummary.backToOverview' | artemisTranslate }}&nbsp; </span>
</button>

<div>
    <div class="d-flex">
        <h2>
            <span>{{ exercise?.title }} - </span>{{ filteredParticipationsSize }} <span jhiTranslate="artemisApp.participation.home.title">Participations</span>
        </h2>
        <jhi-programming-exercise-instructor-submission-state
            class="ml-auto"
            *ngIf="exercise?.isAtLeastInstructor && exercise?.type === ExerciseType.PROGRAMMING"
            [exercise]="exercise"
        ></jhi-programming-exercise-instructor-submission-state>
    </div>
    <jhi-alert></jhi-alert>
    <div class="row"></div>
    <br />
    <jhi-data-table
        [isLoading]="isLoading"
        entityType="participation"
        [allEntities]="participations"
        entitiesPerPageTranslation="artemisApp.exercise.resultsPerPage"
        showAllEntitiesTranslation="artemisApp.exercise.showAllResults"
        searchPlaceholderTranslation="artemisApp.exercise.searchForStudents"
        [searchFields]="['student.login', 'student.name']"
        [searchTextFromEntity]="searchTextFromParticipation"
        [searchResultFormatter]="searchResultFormatter"
        (entitiesSizeChange)="handleParticipationsSizeChange($event)"
    >
        <ng-template let-settings="settings" let-controls="controls">
            <ngx-datatable
                class="bootstrap"
                [limit]="settings.limit"
                [sortType]="settings.sortType"
                [columnMode]="settings.columnMode"
                [headerHeight]="settings.headerHeight"
                [footerHeight]="settings.footerHeight"
                [rowHeight]="settings.rowHeight"
                [rows]="settings.rows"
                [rowClass]="settings.rowClass"
                [scrollbarH]="settings.scrollbarH"
            >
                <ngx-datatable-column prop="id" [minWidth]="60" [width]="80" [maxWidth]="100">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('id')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="global.field.id">
                                ID
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('id')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        <div *ngIf="exercise.isAtLeastInstructor; else displayId">
                            <a routerLink="/participation/{{ value }}/submissions">{{ value }}</a>
                        </div>
                        <ng-template #displayId>
                            {{ value }}
                        </ng-template>
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="repositoryUrl" *ngIf="exercise?.type === ExerciseType.PROGRAMMING" [minWidth]="120">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('repositoryUrl')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="artemisApp.participation.repositoryUrl">
                                Repository Url
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('repositoryUrl')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        <span *ngIf="value !== null">
                            <a href="{{ value }}" target="_blank">Repository Link</a>
                        </span>
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="buildPlanId" *ngIf="exercise?.type === ExerciseType.PROGRAMMING" [minWidth]="100">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('buildPlanId')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="artemisApp.participation.buildPlanId">
                                Build Plan Id
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('buildPlanId')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        <span *ngIf="value !== null">
                            <a href="https://bamboobruegge.in.tum.de/browse/{{ value }}" target="_blank" rel="noopener noreferrer">
                                {{ value }}
                            </a>
                        </span>
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="initializationState" [minWidth]="80">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('initializationState')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="artemisApp.participation.initializationState">
                                Initialization State
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('initializationState')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        {{ 'artemisApp.InitializationState.' + value | translate }}
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="initializationDate" [width]="180">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('initializationDate')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="artemisApp.participation.initializationDate">
                                Initialization Date
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('initializationDate')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        {{ value | date: 'medium' }}
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="student" [minWidth]="120">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('student.name')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="artemisApp.participation.student">
                                Student
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('student.name')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        <a routerLink="/admin/user-management/{{ value?.login }}/view"> {{ value?.name }} </a>
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="presentationScore" *ngIf="this.presentationScoreEnabled" [minWidth]="150">
                    <ng-template ngx-datatable-header-template>
                        <span class="datatable-header-cell-wrapper" (click)="controls.onSort('presentationScore')">
                            <span class="datatable-header-cell-label bold sortable" jhiTranslate="artemisApp.participation.presentationScore">
                                Presentation Score
                            </span>
                            <fa-icon [icon]="controls.iconForSortPropField('presentationScore')"></fa-icon>
                        </span>
                    </ng-template>
                    <ng-template ngx-datatable-cell-template let-value="value">
                        <span>{{ value ? value : 0 }}</span>
                    </ng-template>
                </ngx-datatable-column>

                <ngx-datatable-column prop="" [minWidth]="350">
                    <ng-template ngx-datatable-cell-template let-value="value">
                        <div class="text-right">
                            <div class="btn-group">
                                <ng-container *ngIf="exercise?.type === ExerciseType.PROGRAMMING && exercise.isAtLeastInstructor">
                                    <!-- TODO: In case the last result is manuel, we should warn the user that a manual result would be overridden when clicking the button -->
                                    <jhi-programming-exercise-instructor-trigger-build-button
                                        *ngIf="hasLoadedPendingSubmissions; else triggerLoading"
                                        [exercise]="exercise"
                                        [participation]="value"
                                        class="mr-1"
                                    >
                                    </jhi-programming-exercise-instructor-trigger-build-button>
                                    <ng-template #triggerLoading>
                                        <fa-icon [icon]="'circle-notch'" [spin]="true" class="text-secondary"></fa-icon>
                                    </ng-template>
                                </ng-container>
                                <button
                                    *ngIf="exercise.isAtLeastInstructor"
                                    [jhiFeatureToggle]="FeatureToggle.PROGRAMMING_EXERCISES"
                                    [skipFeatureToggle]="exercise.type !== ExerciseType.PROGRAMMING"
                                    jhiDeleteButton
                                    [entityTitle]="value.student.name"
                                    deleteQuestion="artemisApp.participation.delete.question"
                                    (delete)="deleteParticipation(value.id, $event)"
                                    [dialogError]="dialogError$"
                                    [additionalChecks]="
                                        exercise.type === ExerciseType.PROGRAMMING
                                            ? { deleteBuildPlan: 'artemisApp.participation.deleteBuildPlan', deleteRepository: 'artemisApp.participation.deleteRepository' }
                                            : null
                                    "
                                >
                                    <fa-icon [icon]="'times'"></fa-icon>
                                </button>
                                <button
                                    *ngIf="exercise?.type === ExerciseType.PROGRAMMING && value.buildPlanId !== null && exercise.isAtLeastInstructor"
                                    [jhiFeatureToggle]="FeatureToggle.PROGRAMMING_EXERCISES"
                                    jhiDeleteButton
                                    [actionType]="ActionType.Cleanup"
                                    deleteQuestion="artemisApp.participation.cleanupBuildPlan.question"
                                    (delete)="cleanupProgrammingExerciseParticipation(value)"
                                    [dialogError]="dialogError$"
                                    [entityTitle]="value.student.name"
                                >
                                    <fa-icon [icon]="'eraser'"></fa-icon>
                                </button>
                                <button *ngIf="this.presentationScoreEnabled && value.presentationScore !== 1" (click)="addPresentation(value)" class="btn btn-info btn-sm mr-1">
                                    <fa-icon [icon]="'file-powerpoint'"></fa-icon>
                                    <span class="d-none d-md-inline" jhiTranslate="artemisApp.participation.addPresentation.label">Add presentation</span>
                                </button>
                                <button
                                    *ngIf="this.presentationScoreEnabled && value.presentationScore === 1"
                                    (click)="removePresentation(value)"
                                    class="btn btn-danger btn-sm mr-1"
                                >
                                    <fa-icon [icon]="'file-powerpoint'"></fa-icon>
                                    <span class="d-none d-md-inline" jhiTranslate="artemisApp.participation.removePresentation.label">Remove presentation</span>
                                </button>
                            </div>
                        </div>
                    </ng-template>
                </ngx-datatable-column>
            </ngx-datatable>
        </ng-template>
    </jhi-data-table>
</div>

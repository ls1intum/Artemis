<div class="mb-1" [ngClass]="{ 'mx-0': !isThreadSidebar, 'pinned-message': isPinned() }">
    @if (!isConsecutive()) {
        <jhi-post-header
            [previewMode]="previewMode"
            [readOnlyMode]="readOnlyMode"
            [posting]="posting"
            [isDeleted]="isDeleted"
            [isCommunicationPage]="isCommunicationPage"
            [hasChannelModerationRights]="hasChannelModerationRights"
            (isModalOpen)="displayInlineInput = true"
            [lastReadDate]="lastReadDate"
        />
    }
    <div class="align-items-center post-content-margin">
        <div class="col">
            <div class="mb-1">
                @if (showAnnouncementIcon) {
                    <fa-icon
                        [icon]="faBullhorn"
                        iconSize="xs"
                        class="col-auto pe-0 announcement-icon"
                        [ngbTooltip]="'artemisApp.metis.post.postMarkedAsAnnouncementTooltip' | artemisTranslate"
                    />
                }
                <!-- in the course all-messages as well as in the preview mode during similarity check, the context (lecture, exercise, course-wide topic) is shown -->
                <!-- not shown in course messages page -->
                @if (showChannelReference && (pageType === PageType.OVERVIEW || previewMode)) {
                    <span class="col-auto">
                        @if (contextInformation.routerLinkComponents) {
                            <a
                                class="linked-context-information"
                                [routerLink]="contextInformation.routerLinkComponents"
                                [queryParams]="contextInformation.queryParams"
                                (click)="onNavigateToContext($event)"
                                routerLinkActive="active"
                                >{{ contextInformation.displayName }}</a
                            >
                        }
                        @if (!contextInformation.routerLinkComponents) {
                            <span class="context-information">{{ contextInformation.displayName }}:</span>
                        }
                    </span>
                }
                <!-- post title not shown for plagiarism cases -->
                @if (pageType !== PageType.PLAGIARISM_CASE_INSTRUCTOR && pageType !== PageType.PLAGIARISM_CASE_STUDENT) {
                    <span class="col-auto">
                        @if (posting.title?.length) {
                            <span class="post-title">{{ posting.title }}</span>
                        }
                    </span>
                }
            </div>
            @if (!displayInlineInput) {
                <div class="message-container" [class.force-hover]="showDropdown" (contextmenu)="onRightClick($event)">
                    <div class="message-content" [ngClass]="{ 'mx-0': !isThreadSidebar }">
                        @if (posting.content) {
                            <jhi-posting-content
                                [previewMode]="previewMode"
                                [content]="posting.content"
                                [author]="posting.author"
                                [isEdited]="!!posting.updatedDate"
                                [posting]="posting"
                                [isReply]="false"
                                [isDeleted]="isDeleted"
                                [deleteTimerInSeconds]="deleteTimerInSeconds"
                                (onUndoDeleteEvent)="onDeleteEvent(false)"
                                (userReferenceClicked)="onUserReferenceClicked($event)"
                                (channelReferenceClicked)="onChannelReferenceClicked($event)"
                            ></jhi-posting-content>
                        }
                        @if (originalPostDetails) {
                            <div *ngIf="originalPostDetails" class="forwarded-message-container">
                                <div class="left-border-line"></div>
                                <div class="forwarded-message-content">
                                    <div class="forwarded-message-header">
                                        <jhi-profile-picture
                                            imageSizeInRem="1.5"
                                            fontSizeInRem="0.6"
                                            imageId="user-profile-picture"
                                            defaultPictureId="user-default-profile-picture"
                                            [authorId]="originalPostDetails?.author?.id"
                                            [authorName]="originalPostDetails?.author?.name"
                                            [imageUrl]="originalPostDetails?.author?.imageUrl"
                                            style="margin-right: 0.2rem"
                                        >
                                        </jhi-profile-picture>
                                        <span class="forwarded-message-author">{{ originalPostDetails?.author?.name }}</span>
                                    </div>
                                    <div class="forwarded-message-body" [ngClass]="{ 'preserve-line-breaks': originalPostDetails?.content?.includes('\n') }">
                                        {{ originalPostDetails?.content }}
                                    </div>
                                    <div class="forwarded-message-footer">
                                        <span class="forwarded-message-channel fs-x-small">{{ sourceName }}</span>
                                        @if (postingIsOfToday) {
                                            <span [jhiTranslate]="todayFlag ?? ''" id="today-flag" class="fs-x-small"></span>,
                                        }
                                        <span
                                            class="fs-x-small"
                                            style="margin-right: 1rem"
                                            [disableTooltip]="postingIsOfToday"
                                            ngbTooltip="{{ posting.creationDate | artemisDate: 'time' }}"
                                        >
                                            {{ postingIsOfToday ? (posting.creationDate | artemisDate: 'time') : (posting.creationDate | artemisDate: 'short-date') }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="hover-actions post-content-margin" [ngClass]="{ 'mb-2': previewMode }">
                            @if (!previewMode) {
                                <jhi-post-reactions-bar
                                    [course]="course"
                                    [lastReadDate]="lastReadDate"
                                    [readOnlyMode]="readOnlyMode"
                                    [previewMode]="previewMode"
                                    [posting]="posting"
                                    [(showAnswers)]="showAnswers"
                                    [sortedAnswerPosts]="sortedAnswerPosts"
                                    [isCommunicationPage]="isCommunicationPage"
                                    [isThreadSidebar]="isThreadSidebar"
                                    (openPostingCreateEditModal)="openCreateAnswerPostModal()"
                                    (openThread)="openThread.emit()"
                                    (isModalOpen)="displayInlineInput = true"
                                    (mayEditOrDeleteOutput)="onMayEditOrDelete($event)"
                                    (canPinOutput)="onCanPin($event)"
                                    (isDeleteEvent)="onDeleteEvent(true)"
                                />
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    @if (!isDeleted && displayInlineInput && !readOnlyMode) {
        <div class="post-content-margin">
            <jhi-message-inline-input [posting]="posting" (isModalOpen)="displayInlineInput = false" />
        </div>
    }
    @if (!isDeleted) {
        <div class="post-content-margin justify-content-between" [ngClass]="{ 'mb-2': previewMode }">
            <!-- Post reactions -->
            @if (!previewMode) {
                <jhi-post-reactions-bar
                    [lastReadDate]="lastReadDate"
                    [readOnlyMode]="readOnlyMode"
                    [previewMode]="previewMode"
                    [posting]="posting"
                    [(showAnswers)]="showAnswers"
                    [sortedAnswerPosts]="sortedAnswerPosts"
                    [isCommunicationPage]="isCommunicationPage"
                    [isThreadSidebar]="isThreadSidebar"
                    (openPostingCreateEditModal)="openCreateAnswerPostModal()"
                    (openThread)="openThread.emit()"
                    (isModalOpen)="displayInlineInput = true"
                    [isEmojiCount]="true"
                    [hoverBar]="false"
                />
            }
        </div>
    }
</div>
<jhi-post-footer
    #postFooter
    [readOnlyMode]="readOnlyMode"
    [modalRef]="modalRef"
    [previewMode]="previewMode || pageType === PageType.PLAGIARISM_CASE_STUDENT"
    [posting]="posting"
    [showAnswers]="showAnswers"
    [isCommunicationPage]="isCommunicationPage"
    [isThreadSidebar]="isThreadSidebar"
    [sortedAnswerPosts]="sortedAnswerPosts"
    (openThread)="openThread.emit()"
    [lastReadDate]="lastReadDate"
    (userReferenceClicked)="onUserReferenceClicked($event)"
    (channelReferenceClicked)="onChannelReferenceClicked($event)"
    [hasChannelModerationRights]="hasChannelModerationRights"
/>

<!-- Right-Click Dropdown -->
<div *ngIf="showDropdown" [ngStyle]="{ position: 'fixed', 'top.px': dropdownPosition.y, 'left.px': dropdownPosition.x }" class="dropdown-menu show">
    <button class="dropdown-item d-flex" (click)="addReaction($event)">
        <fa-icon [icon]="faSmile" class="item-icon"></fa-icon>
        <span jhiTranslate="artemisApp.metis.post.addReaction"></span>
    </button>
    @if (canPin) {
        <button class="dropdown-item d-flex" (click)="togglePin()">
            <fa-icon [icon]="faThumbtack" class="item-icon"></fa-icon>
            <span [jhiTranslate]="checkIfPinned() === DisplayPriority.PINNED ? 'artemisApp.metis.post.unpinMessage' : 'artemisApp.metis.post.pinMessage'"></span>
        </button>
    }
    @if (mayEditOrDelete) {
        <button class="dropdown-item d-flex" (click)="editPosting()">
            <fa-icon [icon]="faPencilAlt" class="item-icon"></fa-icon>
            <span jhiTranslate="artemisApp.metis.post.editMessage"></span>
        </button>
        <button class="dropdown-item d-flex" (click)="deletePost()">
            <fa-icon [icon]="faTrash" class="item-icon"></fa-icon>
            <span jhiTranslate="artemisApp.metis.post.deleteMessage"></span>
        </button>
    }
    <button class="dropdown-item d-flex" (click)="openThread.emit()">
        <fa-icon [icon]="faComments" class="item-icon"></fa-icon>
        <span jhiTranslate="artemisApp.metis.post.replyMessage"></span>
    </button>
    <button class="dropdown-item d-flex" (click)="forwardMessage()">
        <fa-icon [icon]="faShare" class="item-icon"></fa-icon>
        <span jhiTranslate="artemisApp.metis.post.forwardMessage"></span>
    </button>
</div>

<div #emojiPickerTrigger="cdkOverlayOrigin" cdkOverlayOrigin [ngStyle]="{ position: 'fixed', 'top.px': clickPosition.y, 'left.px': clickPosition.x }"></div>

<ng-template
    cdkConnectedOverlay
    [cdkConnectedOverlayHasBackdrop]="true"
    [cdkConnectedOverlayBackdropClass]="'cdk-overlay-transparent-backdrop'"
    [cdkConnectedOverlayOrigin]="emojiPickerTrigger"
    [cdkConnectedOverlayOpen]="showReactionSelector"
    (backdropClick)="toggleEmojiSelect()"
>
    <jhi-emoji-picker *ngIf="!readOnlyMode" (emojiSelect)="selectReaction($event)"></jhi-emoji-picker>
</ng-template>

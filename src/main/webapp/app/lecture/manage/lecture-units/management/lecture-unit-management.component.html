@if (isLoading) {
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden" jhiTranslate="loading"></span>
        </div>
    </div>
}
@if (!isLoading && lecture) {
    <div>
        <!-- Lecture Unit Rows-->
        @if (showCreationCard) {
            <div class="w-100 d-flex justify-content-end mb-5" [class.justify-content-center]="!lectureUnits?.length">
                <jhi-unit-creation-card />
            </div>
        }
        <div class="component-container" cdkDropList (cdkDropListDropped)="drop($event)">
            @for (lectureUnit of lectureUnits; track identify(i, lectureUnit); let i = $index) {
                <div class="lecture-unit-container" [class.attachment]="lectureUnit.type === LectureUnitType.ATTACHMENT_VIDEO" cdkDrag>
                    <div class="custom-handle d-none d-sm-flex">
                        <svg viewBox="3 1 5 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="4.5" cy="2.5" r=".6" fill="currentColor" />
                            <circle cx="4.5" cy="4.5" r=".6" fill="currentColor" />
                            <circle cx="4.5" cy="6.499" r=".6" fill="currentColor" />
                            <circle cx="4.5" cy="8.499" r=".6" fill="currentColor" />
                            <circle cx="4.5" cy="10.498" r=".6" fill="currentColor" />
                            <circle cx="4.5" cy="12.498" r=".6" fill="currentColor" />
                            <circle cx="6.5" cy="2.5" r=".6" fill="currentColor" />
                            <circle cx="6.5" cy="4.5" r=".6" fill="currentColor" />
                            <circle cx="6.5" cy="6.499" r=".6" fill="currentColor" />
                            <circle cx="6.5" cy="8.499" r=".6" fill="currentColor" />
                            <circle cx="6.5" cy="10.498" r=".6" fill="currentColor" />
                            <circle cx="6.5" cy="12.498" r=".6" fill="currentColor" />
                        </svg>
                    </div>
                    <div class="lecture-unit-type-container">
                        <div class="unit-badges d-flex flex-column gap-1" [style.top]="getBadgeTopOffset(lectureUnit)">
                            <div class="badge bg-info">
                                {{
                                    getLectureUnitReleaseDate(lectureUnit)
                                        ? ('artemisApp.lectureUnit.details.releaseDateSet' | artemisTranslate) + (getLectureUnitReleaseDate(lectureUnit) | artemisDate)
                                        : ('artemisApp.lectureUnit.details.releaseDateNotSet' | artemisTranslate)
                                }}
                            </div>

                            @if (lectureUnit.type === LectureUnitType.ATTACHMENT_VIDEO) {
                                @if (isTranscriptionPending(lectureUnit)) {
                                    <div class="badge bg-info">
                                        <fa-icon [icon]="faSpinner" animation="spin" class="me-1" />
                                        <span jhiTranslate="artemisApp.attachmentVideoUnit.transcriptionProcessing"></span>
                                    </div>
                                } @else if (isTranscriptionFailed(lectureUnit)) {
                                    <div class="badge bg-danger">
                                        <fa-icon [icon]="faExclamationTriangle" class="me-1" />
                                        <span jhiTranslate="artemisApp.attachmentVideoUnit.transcriptionFailed"></span>
                                    </div>
                                } @else if (hasTranscription(lectureUnit)) {
                                    <div class="badge bg-success">
                                        <fa-icon [icon]="faFileLines" class="me-1" />
                                        <span jhiTranslate="artemisApp.attachmentVideoUnit.hasTranscription"></span>
                                    </div>
                                } @else if (canGenerateTranscription(lectureUnit)) {
                                    <div class="badge bg-info">
                                        <fa-icon [icon]="faFileLines" class="me-1" />
                                        <span jhiTranslate="artemisApp.attachmentVideoUnit.transcriptAvailable"></span>
                                    </div>
                                }
                            }
                        </div>
                        <div class="mt-2">
                            @switch (lectureUnit.type) {
                                @case (LectureUnitType.ATTACHMENT_VIDEO) {
                                    <jhi-attachment-video-unit [courseId]="lecture.course!.id!" [lectureUnit]="lectureUnit" [isPresentationMode]="true" />
                                }
                                @case (LectureUnitType.EXERCISE) {
                                    <jhi-exercise-unit [exerciseUnit]="lectureUnit" [isPresentationMode]="true" [course]="lecture.course!" />
                                }
                                @case (LectureUnitType.TEXT) {
                                    <jhi-text-unit [courseId]="lecture.course?.id!" [lectureUnit]="lectureUnit" [isPresentationMode]="true" />
                                }
                                @case (LectureUnitType.ONLINE) {
                                    <jhi-online-unit [courseId]="lecture.course?.id!" [lectureUnit]="lectureUnit" [isPresentationMode]="true" />
                                }
                            }
                        </div>
                    </div>

                    <div class="d-flex gap-1 flex-column justify-content-center action-buttons" role="group">
                        <!-- Row 1: Generate Transcription + Send to Iris (only for attachment/video units) -->
                        @if (lectureUnit.type === LectureUnitType.ATTACHMENT_VIDEO) {
                            <div class="d-flex gap-1 w-100">
                                <button
                                    type="button"
                                    class="btn btn-primary btn-sm flex-fill"
                                    [disabled]="!canGenerateTranscription(lectureUnit)"
                                    (click)="generateTranscription(lectureUnit)"
                                    [ngbTooltip]="'artemisApp.attachmentVideoUnit.generateTranscription' | artemisTranslate"
                                >
                                    @if (isTranscriptionLoading[lectureUnit.id!]) {
                                        <fa-icon [icon]="faSpinner" animation="spin" />
                                    } @else {
                                        <fa-icon [icon]="faFileAudio" />
                                    }
                                </button>
                                @if (!lecture.isTutorialLecture && irisEnabled) {
                                    <button
                                        type="button"
                                        class="btn btn-primary btn-sm flex-fill"
                                        [ngClass]="{
                                            error: getIcon(lectureUnit) === faRepeat,
                                            'btn-success': getIcon(lectureUnit) === faCheckCircle,
                                        }"
                                        (click)="onIngestButtonClicked(lectureUnit.id!)"
                                        [ngbTooltip]="'entity.action.sendToIris' | artemisTranslate"
                                    >
                                        <fa-icon [icon]="getIcon(lectureUnit)" />
                                    </button>
                                }
                            </div>
                        }
                        <!-- Row 2: View + Linked Competencies -->
                        <div class="d-flex gap-1 w-100">
                            @if (viewButtonAvailable[lectureUnit.id!]) {
                                <div class="flex-fill">
                                    <a
                                        type="button"
                                        class="btn btn-primary btn-sm w-100"
                                        [routerLink]="[
                                            '/course-management',
                                            lecture.course?.id,
                                            'lectures',
                                            lecture.id,
                                            'unit-management',
                                            'attachment-video-units',
                                            lectureUnit.id,
                                            'view',
                                        ]"
                                        [ngbTooltip]="'entity.action.view' | artemisTranslate"
                                    >
                                        <fa-icon [icon]="faEye" />
                                    </a>
                                </div>
                            }
                            @if (lecture.course?.id && showCompetencies) {
                                <div class="flex-fill">
                                    <jhi-competencies-popover
                                        [courseId]="lecture.course!.id!"
                                        [competencyLinks]="lectureUnit.competencyLinks || []"
                                        [navigateTo]="'competencyManagement'"
                                        [ngbTooltip]="'artemisApp.competency.competencyPopover.connectedCompetencies' | artemisTranslate"
                                    />
                                </div>
                            }
                        </div>
                        <!-- Row 3: Edit + Delete -->
                        <div class="d-flex gap-1 w-100">
                            @if (this.emitEditEvents) {
                                @if (editButtonAvailable(lectureUnit)) {
                                    <button
                                        type="button"
                                        class="btn btn-primary btn-sm edit flex-fill"
                                        (click)="onEditButtonClicked(lectureUnit)"
                                        [ngbTooltip]="'entity.action.edit' | artemisTranslate"
                                    >
                                        <fa-icon [icon]="faPencilAlt" />
                                    </button>
                                }
                            } @else {
                                @if (editButtonAvailable(lectureUnit)) {
                                    <a
                                        type="button"
                                        class="btn btn-primary btn-sm edit flex-fill"
                                        [routerLink]="['./', routerEditLinksBase[lectureUnit.type!], lectureUnit.id, 'edit']"
                                        [ngbTooltip]="'entity.action.edit' | artemisTranslate"
                                    >
                                        <fa-icon [icon]="faPencilAlt" />
                                    </a>
                                }
                            }
                            @if (lecture.isAtLeastInstructor) {
                                <button
                                    type="button"
                                    class="btn btn-danger btn-sm flex-fill"
                                    jhiDeleteButton
                                    [renderButtonStyle]="false"
                                    [renderButtonText]="false"
                                    [ngbTooltip]="'entity.action.' + getActionType(lectureUnit) | artemisTranslate"
                                    [actionType]="getActionType(lectureUnit)"
                                    [entityTitle]="lectureUnitService.getLectureUnitName(lectureUnit) || ''"
                                    [deleteQuestion]="getDeleteQuestionKey(lectureUnit)"
                                    [deleteConfirmationText]="getDeleteConfirmationTextKey(lectureUnit)"
                                    (delete)="deleteLectureUnit(lectureUnit.id!)"
                                    [dialogError]="dialogError$"
                                >
                                    <fa-icon [icon]="faTrash" />
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (showDropZone) {
            <div class="mt-4">
                <jhi-pdf-drop-zone (filesDropped)="onPdfFilesDropped($event)" />
            </div>
        }
    </div>
}

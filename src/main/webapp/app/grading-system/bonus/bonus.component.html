<ng-template #helpTextTemplate let-translationKey="translationKey">
    <ng-template #tipContent><span [innerHTML]="translationKey | artemisTranslate | safeHtml"></span></ng-template>
    <fa-icon *ngIf="bonus.id" [icon]="faQuestionCircle" class="text-secondary" placement="top" [ngbTooltip]="tipContent"></fa-icon>
    <label *ngIf="!bonus.id" [innerHTML]="translationKey | artemisTranslate | safeHtml" class="d-block py-1"></label>
</ng-template>
<h2>{{ 'artemisApp.bonus.title' | artemisTranslate }}</h2>
<div class="form-group">
    <span class="colon-suffix no-flex-shrink" jhiTranslate="artemisApp.bonus.bonusStrategy.title">Select a Bonus Strategy</span>
    <ng-container [ngTemplateOutlet]="helpTextTemplate" [ngTemplateOutletContext]="{ translationKey: 'artemisApp.bonus.bonusStrategy.helpText' }"></ng-container>
    <jhi-mode-picker [options]="bonusStrategyOptions" [(value)]="currentBonusStrategyOption" (valueChange)="onBonusStrategyInputChange()"></jhi-mode-picker>
</div>
<div *ngIf="currentBonusStrategyOption === BonusStrategyOptions.GRADES" class="form-group">
    <span class="colon-suffix no-flex-shrink" jhiTranslate="artemisApp.TODO: Ata">Mode</span>
    <jhi-mode-picker [options]="bonusStrategyDiscreteness" [(value)]="currentBonusStrategyDiscreteness" (valueChange)="onBonusStrategyInputChange()"></jhi-mode-picker>
</div>
<div class="form-group">
    <span class="colon-suffix no-flex-shrink" jhiTranslate="artemisApp.TODO: Ata">Mode</span>
    <jhi-mode-picker [options]="calculationSigns" [(value)]="bonus.weight" (valueChange)="generateExamples()"></jhi-mode-picker>
</div>
<div class="form-group">
    <span class="colon-suffix no-flex-shrink" jhiTranslate="artemisApp.gradingSystem.TODO: Ata">Select bonus source</span>
    <select class="form-select" [(ngModel)]="bonus.source" (ngModelChange)="onBonusSourceChange($event)" title="Select bonus source">
        <option *ngFor="let sourceGradingScale of sourceGradingScales" [ngValue]="sourceGradingScale">{{ getGradingScaleTitle(sourceGradingScale) }}</option>
    </select>
</div>
<h6>{{ 'artemisApp.gradingSystem.overview.info' | artemisTranslate }}</h6>
<div *ngIf="bonus.source?.gradeSteps" class="fs-5">
    <span class="colon-suffix no-flex-shrink" jhiTranslate="artemisApp.gradingSystem.inclusivity.title">Inclusivity</span>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>{{ 'artemisApp.exam.examSummary.bonus' | artemisTranslate }}</th>
                <th>{{ 'artemisApp.exam.examSummary.interval' | artemisTranslate }}</th>
                <th *ngIf="hasPointsSet()">{{ 'artemisApp.exam.examSummary.intervalPoints' | artemisTranslate }}</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let gradeStep of bonus.source?.gradeSteps; let i = index; let last = last">
                <td>{{ gradeStep.gradeName }}</td>
                <td>
                    <span [innerHTML]="gradeStep | gradeStepBounds: GradeEditMode.PERCENTAGE:last | safeHtml"></span>
                </td>
                <td *ngIf="hasPointsSet()">
                    <span [innerHTML]="gradeStep | gradeStepBounds: GradeEditMode.POINTS:last | safeHtml"></span>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<h6>{{ 'artemisApp.TODO: Ata Formula' | artemisTranslate }}</h6>
<div *ngIf="bonus.bonusStrategy && bonus.weight && examGradeStepsDTO" class="fs-4 pb-5">
    <div class="d-flex py-2 align-items-center">
        <div class="p-2">
            <strong>Exam<br />Grade</strong>
        </div>
        <div class="p-2">
            <strong class="fs-1">{{ getCalculationSign(bonus.weight) }}</strong>
        </div>
        <div class="p-2"><strong>Bonus</strong></div>
        <div class="p-2"><strong class="fs-1">=</strong></div>
        <div class="p-2">
            <strong>Final<br />Grade</strong>
        </div>
    </div>
    <div class="row fs-5">
        ({{ 'artemisApp.TODO: Ata You cannot get a final grade better than ' | artemisTranslate }}{{ maxPossibleGrade() }}
        )
    </div>
</div>
<div *ngIf="examples?.length" class="fs-5">
    <span class="colon-suffix no-flex-shrink" jhiTranslate="artemisApp.TODO: Ata">Examples</span>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>{{ 'artemisApp.TODO: Ata examStudentPoints' | artemisTranslate }}</th>
                <th>{{ 'artemisApp.TODO: Ata examGrade' | artemisTranslate }}</th>
                <th>{{ 'artemisApp.TODO: Ata bonusStudentPoints' | artemisTranslate }}</th>
                <th>{{ 'artemisApp.TODO: Ata bonusGrade' | artemisTranslate }}</th>
                <th *ngIf="currentBonusStrategyOption == BonusStrategyOptions.POINTS">{{ 'artemisApp.TODO: Ata finalPoints' | artemisTranslate }}</th>
                <th>{{ 'artemisApp.TODO: Ata finalGrade' | artemisTranslate }}</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let example of examples">
                <td>{{ example.examStudentPoints }}</td>
                <td>{{ example.examGrade }}</td>
                <td>{{ example.bonusStudentPoints }}</td>
                <td>{{ example.bonusGrade }}</td>
                <td *ngIf="bonus.bonusStrategy === BonusStrategy.POINTS">
                    {{ example.examStudentPoints }} {{ getCalculationSign(bonus.weight!) }} {{ example.bonusGrade }} = {{ example.finalPoints }}
                </td>
                <td>
                    <ng-container *ngIf="bonus.bonusStrategy === BonusStrategy.GRADES_CONTINUOUS"
                        >{{ example.examGrade }} {{ getCalculationSign(bonus.weight!) }} {{ example.bonusGrade }} = </ng-container
                    >{{ example.finalGrade }}
                </td>
            </tr>
            <tr>
                <td><input [(ngModel)]="dynamicExample.examStudentPoints" (change)="calculateDynamicExample()" type="number" step="0.5" min="0" /></td>
                <td>{{ dynamicExample.examGrade }}</td>
                <td><input [(ngModel)]="dynamicExample.bonusStudentPoints" (change)="calculateDynamicExample()" type="number" step="0.5" min="0" /></td>
                <td>{{ dynamicExample.bonusGrade }}</td>
                <td *ngIf="bonus.bonusStrategy === BonusStrategy.POINTS && dynamicExample.finalPoints">
                    {{ dynamicExample.examStudentPoints }} {{ getCalculationSign(bonus.weight!) }} {{ dynamicExample.bonusGrade }} = {{ dynamicExample.finalPoints }}
                </td>
                <td>
                    <ng-container *ngIf="bonus.bonusStrategy === BonusStrategy.GRADES_CONTINUOUS && dynamicExample.finalGrade"
                        >{{ dynamicExample.examGrade }} {{ getCalculationSign(bonus.weight!) }} {{ dynamicExample.bonusGrade }}= </ng-container
                    >{{ dynamicExample.finalGrade }}
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div>
    <button (click)="save()" [disabled]="isLoading || !isFormValid()" class="btn btn-primary mr-1 mb-1" type="button">
        <fa-icon [icon]="faSave"></fa-icon>&nbsp;<span jhiTranslate="entity.action.save">Save</span>
    </button>
    <button
        *ngIf="bonus.id"
        class="mb-1"
        jhiDeleteButton
        [entityTitle]="''"
        [buttonSize]="ButtonSize.MEDIUM"
        deleteQuestion="artemisApp.TODO: Ata.deleteQuestion"
        (delete)="delete()"
        [dialogError]="dialogError$"
        [disabled]="isLoading"
    >
        <fa-icon [icon]="faTimes"><span jhiTranslate="entity.action.delete">Delete</span></fa-icon>
    </button>
    <div *ngIf="invalidBonusMessage" class="alert alert-warning mt-3">
        <fa-icon [icon]="faExclamationTriangle"></fa-icon>
        <span>
            {{ invalidBonusMessage }}
        </span>
    </div>
</div>

<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- New config table with FK to exercise -->
    <changeSet id="20251019234730-1" author="undernagruzez">
        <createTable tableName="exercise_athena_config">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="exercise_id" type="bigint">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="preliminary_feedback_module" type="varchar(255)"/>
            <column name="feedback_suggestion_module" type="varchar(255)"/>
        </createTable>

        <addForeignKeyConstraint
            baseTableName="exercise_athena_config" baseColumnNames="exercise_id"
            referencedTableName="exercise" referencedColumnNames="id"
            constraintName="fk_exercise_athena_config"/>
    </changeSet>

    <!-- Data migration: copy old value; preliminary = feedback_suggestion -->
    <changeSet id="20251019234730-2" author="undernagruzez">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="exercise" columnName="feedback_suggestion_module"/>
        </preConditions>

        <sql>
            INSERT INTO exercise_athena_config (exercise_id, preliminary_feedback_module, feedback_suggestion_module)
            SELECT e.id, e.feedback_suggestion_module, e.feedback_suggestion_module
            FROM exercise e
            WHERE e.feedback_suggestion_module IS NOT NULL;
        </sql>
    </changeSet>

    <!-- Drop the legacy column from exercise -->
    <changeSet id="20251019234730-3" author="undernagruzez">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="exercise" columnName="feedback_suggestion_module"/>
        </preConditions>
        <dropColumn tableName="exercise" columnName="feedback_suggestion_module"/>
    </changeSet>

</databaseChangeLog>

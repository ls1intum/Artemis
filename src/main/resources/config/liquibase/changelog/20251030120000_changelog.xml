<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="20251030120000-course-iris-settings" author="bassner">
        <createTable tableName="course_iris_settings">
            <column name="course_id" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_course_iris_settings"/>
            </column>
            <column name="settings" type="json">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="course_iris_settings"
                                 baseColumnNames="course_id"
                                 referencedTableName="course"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"
                                 constraintName="fk_course_iris_settings_course"/>

        <sql dbms="postgresql">
            INSERT INTO course_iris_settings (course_id, settings)
            SELECT
                cs.course_id,
                jsonb_build_object(
                    'enabled', COALESCE(pes.enabled, TRUE),
                    'customInstructions', NULLIF(btrim(pes.custom_instructions), ''),
                    'variant', LOWER(COALESCE(NULLIF(pes.selected_variant, ''), 'default')),
                    'rateLimit', CASE
                        WHEN pes.rate_limit IS NULL AND pes.rate_limit_timeframe_hours IS NULL THEN NULL
                        ELSE jsonb_build_object(
                            'requests', pes.rate_limit,
                            'timeframeHours', pes.rate_limit_timeframe_hours
                        )
                    END
                )::json
            FROM iris_settings cs
                LEFT JOIN iris_sub_settings pes ON cs.iris_chat_settings_id = pes.id
            WHERE cs.discriminator = 'COURSE';
        </sql>

        <sql dbms="mysql">
            INSERT INTO course_iris_settings (course_id, settings)
            SELECT
                cs.course_id,
                JSON_OBJECT(
                    'enabled', COALESCE(pes.enabled, TRUE),
                    'customInstructions', NULLIF(TRIM(pes.custom_instructions), ''),
                    'variant', LOWER(COALESCE(NULLIF(pes.selected_variant, ''), 'default')),
                    'rateLimit', CASE
                        WHEN pes.rate_limit IS NULL AND pes.rate_limit_timeframe_hours IS NULL THEN NULL
                        ELSE JSON_OBJECT(
                            'requests', pes.rate_limit,
                            'timeframeHours', pes.rate_limit_timeframe_hours
                        )
                    END
                )
            FROM iris_settings cs
                LEFT JOIN iris_sub_settings pes ON cs.iris_chat_settings_id = pes.id
            WHERE cs.discriminator = 'COURSE';
        </sql>

        <sql>
            INSERT INTO course_iris_settings (course_id, settings)
            SELECT
                c.id,
                '{"enabled":true,"customInstructions":null,"variant":"default","rateLimit":null}'
            FROM course c
            WHERE NOT EXISTS (SELECT 1 FROM course_iris_settings cis WHERE cis.course_id = c.id);
        </sql>

        <dropTable tableName="iris_settings" cascadeConstraints="true"/>
        <dropTable tableName="iris_sub_settings" cascadeConstraints="true"/>

        <rollback>
            <createTable tableName="iris_sub_settings">
                <column name="id" type="BIGINT" autoIncrement="true">
                    <constraints nullable="false" primaryKey="true" primaryKeyName="pk_iris_sub_settings"/>
                </column>
                <column name="enabled" type="BOOLEAN"/>
                <column name="rate_limit" type="INT"/>
                <column name="rate_limit_timeframe_hours" type="INT"/>
                <column name="discriminator" type="VARCHAR(64)"/>
                <column name="auto_ingest_on_lecture_attachment_upload" type="BOOLEAN" defaultValueBoolean="false">
                    <constraints nullable="false"/>
                </column>
                <column name="allowed_variants" type="VARCHAR(2000)"/>
                <column name="selected_variant" type="VARCHAR(100)"/>
                <column name="enabled_for_categories" type="VARCHAR(500)"/>
                <column name="disabled_proactive_events" type="VARCHAR(2000)"/>
                <column name="auto_ingest_on_faq_creation" type="BOOLEAN" defaultValueBoolean="false">
                    <constraints nullable="false"/>
                </column>
                <column name="custom_instructions" type="VARCHAR(2048)"/>
            </createTable>

            <createTable tableName="iris_settings">
                <column name="id" type="BIGINT" autoIncrement="true">
                    <constraints nullable="false" primaryKey="true" primaryKeyName="pk_iris_settings"/>
                </column>
                <column name="iris_chat_settings_id" type="BIGINT"/>
                <column name="discriminator" type="VARCHAR(64)"/>
                <column name="exercise_id" type="BIGINT"/>
                <column name="course_id" type="BIGINT"/>
                <column name="iris_competency_generation_settings_id" type="BIGINT"/>
                <column name="iris_lecture_ingestion_settings_id" type="BIGINT"/>
                <column name="iris_text_exercise_chat_settings_id" type="BIGINT"/>
                <column name="iris_course_chat_settings_id" type="BIGINT"/>
                <column name="iris_faq_ingestion_settings_id" type="BIGINT"/>
                <column name="iris_lecture_chat_settings_id" type="BIGINT"/>
                <column name="iris_tutor_suggestion_settings_id" type="BIGINT"/>
            </createTable>

            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="course_id"
                                     referencedTableName="course" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_COURSE"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="exercise_id"
                                     referencedTableName="exercise" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_EXERCISE"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_CHAT_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_competency_generation_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_COMPETENCY_GENERATION_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_lecture_ingestion_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_LECTURE_INGESTION_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_text_exercise_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_TEXT_CHAT_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_course_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_COURSE_CHAT_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_faq_ingestion_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_FAQ_INGESTION_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_lecture_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_LECTURE_CHAT_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_tutor_suggestion_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_TUTOR_SUGGESTION_SETTINGS"/>

            <createIndex indexName="course_id" tableName="iris_settings" unique="true">
                <column name="course_id"/>
            </createIndex>
            <createIndex indexName="exercise_id" tableName="iris_settings" unique="true">
                <column name="exercise_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_CHAT_SETTINGS" tableName="iris_settings">
                <column name="iris_chat_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_COMPETENCY_GENERATION_SETTINGS" tableName="iris_settings">
                <column name="iris_competency_generation_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_FAQ_INGESTION_SETTINGS" tableName="iris_settings">
                <column name="iris_faq_ingestion_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_LECTURE_INGESTION_SETTINGS" tableName="iris_settings">
                <column name="iris_lecture_ingestion_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_LECTURE_CHAT_SETTINGS" tableName="iris_settings">
                <column name="iris_lecture_chat_settings_id"/>
            </createIndex>
            <createIndex indexName="fk_iris_settings_iris_course_chat_settings_id" tableName="iris_settings">
                <column name="iris_course_chat_settings_id"/>
            </createIndex>

            <!-- PostgreSQL: Restore course settings using CTE with RETURNING -->
            <sql dbms="postgresql">
                WITH inserted_sub AS (
                    INSERT INTO iris_sub_settings (enabled, rate_limit, rate_limit_timeframe_hours, selected_variant, custom_instructions, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT
                        (cis.settings->>'enabled')::boolean,
                        (cis.settings->'rateLimit'->>'requests')::int,
                        (cis.settings->'rateLimit'->>'timeframeHours')::int,
                        cis.settings->>'variant',
                        cis.settings->>'customInstructions',
                        'CHAT',
                        false,
                        false
                    FROM course_iris_settings cis
                    ORDER BY cis.course_id
                    RETURNING id
                ),
                numbered_sub AS (
                    SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_sub
                ),
                numbered_course AS (
                    SELECT course_id, ROW_NUMBER() OVER (ORDER BY course_id) as rn FROM course_iris_settings
                )
                INSERT INTO iris_settings (iris_chat_settings_id, discriminator, course_id)
                SELECT ns.id, 'COURSE', nc.course_id
                FROM numbered_sub ns
                JOIN numbered_course nc ON ns.rn = nc.rn;
            </sql>

            <!-- MySQL: Restore course settings - Step 1: Insert sub_settings with course_id as temp reference -->
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, rate_limit, rate_limit_timeframe_hours, selected_variant, custom_instructions, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT
                    JSON_EXTRACT(settings, '$.enabled') = true,
                    JSON_EXTRACT(settings, '$.rateLimit.requests'),
                    JSON_EXTRACT(settings, '$.rateLimit.timeframeHours'),
                    JSON_UNQUOTE(JSON_EXTRACT(settings, '$.variant')),
                    JSON_UNQUOTE(JSON_EXTRACT(settings, '$.customInstructions')),
                    'CHAT',
                    false,
                    false
                FROM course_iris_settings
                ORDER BY course_id;
            </sql>

            <!-- MySQL: Restore course settings - Step 2: Insert iris_settings by matching row numbers -->
            <sql dbms="mysql">
                INSERT INTO iris_settings (iris_chat_settings_id, discriminator, course_id)
                SELECT sub.id, 'COURSE', cis.course_id
                FROM (
                    SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn
                    FROM iris_sub_settings
                    WHERE discriminator = 'CHAT'
                ) sub
                JOIN (
                    SELECT course_id, ROW_NUMBER() OVER (ORDER BY course_id) as rn
                    FROM course_iris_settings
                ) cis ON sub.rn = cis.rn;
            </sql>

            <dropTable tableName="course_iris_settings"/>
        </rollback>
    </changeSet>

</databaseChangeLog>

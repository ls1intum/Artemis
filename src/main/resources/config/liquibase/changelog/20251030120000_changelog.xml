<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="20251030120000-course-iris-settings" author="bassner">
        <createTable tableName="course_iris_settings">
            <column name="course_id" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_course_iris_settings"/>
            </column>
            <column name="settings" type="json">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="course_iris_settings"
                                 baseColumnNames="course_id"
                                 referencedTableName="course"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"
                                 constraintName="fk_course_iris_settings_course"/>

        <sql dbms="postgresql">
            INSERT INTO course_iris_settings (course_id, settings)
            SELECT
                cs.course_id,
                jsonb_build_object(
                    'enabled', COALESCE(pes.enabled, TRUE),
                    'customInstructions', NULLIF(btrim(pes.custom_instructions), ''),
                    'variant', LOWER(COALESCE(NULLIF(pes.selected_variant, ''), 'default')),
                    'rateLimit', CASE
                        WHEN pes.rate_limit IS NOT NULL AND pes.rate_limit_timeframe_hours IS NOT NULL THEN
                            jsonb_build_object(
                                'requests', pes.rate_limit,
                                'timeframeHours', pes.rate_limit_timeframe_hours
                            )
                        ELSE NULL
                    END
                )::json
            FROM iris_settings cs
                LEFT JOIN iris_sub_settings pes ON cs.iris_chat_settings_id = pes.id
            WHERE cs.discriminator = 'COURSE';
        </sql>

        <sql dbms="mysql">
            INSERT INTO course_iris_settings (course_id, settings)
            SELECT
                cs.course_id,
                JSON_OBJECT(
                    'enabled', CAST(IF(COALESCE(pes.enabled, 1), 'true', 'false') AS JSON),
                    'customInstructions', NULLIF(TRIM(pes.custom_instructions), ''),
                    'variant', LOWER(COALESCE(NULLIF(pes.selected_variant, ''), 'default')),
                    'rateLimit', CASE
                        WHEN pes.rate_limit IS NOT NULL AND pes.rate_limit_timeframe_hours IS NOT NULL THEN
                            JSON_OBJECT(
                                'requests', pes.rate_limit,
                                'timeframeHours', pes.rate_limit_timeframe_hours
                            )
                        ELSE NULL
                    END
                )
            FROM iris_settings cs
                LEFT JOIN iris_sub_settings pes ON cs.iris_chat_settings_id = pes.id
            WHERE cs.discriminator = 'COURSE';
        </sql>

        <sql>
            INSERT INTO course_iris_settings (course_id, settings)
            SELECT
                c.id,
                '{"enabled":true,"customInstructions":null,"variant":"default","rateLimit":null}'
            FROM course c
            WHERE NOT EXISTS (SELECT 1 FROM course_iris_settings cis WHERE cis.course_id = c.id);
        </sql>

        <dropTable tableName="iris_settings" cascadeConstraints="true"/>
        <dropTable tableName="iris_sub_settings" cascadeConstraints="true"/>

        <rollback>
            <createTable tableName="iris_sub_settings">
                <column name="id" type="BIGINT" autoIncrement="true">
                    <constraints nullable="false" primaryKey="true" primaryKeyName="pk_iris_sub_settings"/>
                </column>
                <column name="enabled" type="BOOLEAN"/>
                <column name="rate_limit" type="INT"/>
                <column name="rate_limit_timeframe_hours" type="INT"/>
                <column name="discriminator" type="VARCHAR(64)"/>
                <column name="auto_ingest_on_lecture_attachment_upload" type="BOOLEAN" defaultValueBoolean="false">
                    <constraints nullable="false"/>
                </column>
                <column name="allowed_variants" type="VARCHAR(2000)"/>
                <column name="selected_variant" type="VARCHAR(100)"/>
                <column name="enabled_for_categories" type="VARCHAR(500)"/>
                <column name="disabled_proactive_events" type="VARCHAR(2000)"/>
                <column name="auto_ingest_on_faq_creation" type="BOOLEAN" defaultValueBoolean="false">
                    <constraints nullable="false"/>
                </column>
                <column name="custom_instructions" type="VARCHAR(2048)"/>
            </createTable>

            <createTable tableName="iris_settings">
                <column name="id" type="BIGINT" autoIncrement="true">
                    <constraints nullable="false" primaryKey="true" primaryKeyName="pk_iris_settings"/>
                </column>
                <column name="iris_chat_settings_id" type="BIGINT"/>
                <column name="discriminator" type="VARCHAR(64)"/>
                <column name="exercise_id" type="BIGINT"/>
                <column name="course_id" type="BIGINT"/>
                <column name="iris_competency_generation_settings_id" type="BIGINT"/>
                <column name="iris_lecture_ingestion_settings_id" type="BIGINT"/>
                <column name="iris_text_exercise_chat_settings_id" type="BIGINT"/>
                <column name="iris_course_chat_settings_id" type="BIGINT"/>
                <column name="iris_faq_ingestion_settings_id" type="BIGINT"/>
                <column name="iris_lecture_chat_settings_id" type="BIGINT"/>
                <column name="iris_tutor_suggestion_settings_id" type="BIGINT"/>
            </createTable>

            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="course_id"
                                     referencedTableName="course" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_COURSE"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="exercise_id"
                                     referencedTableName="exercise" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_EXERCISE"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_CHAT_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_competency_generation_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_COMPETENCY_GENERATION_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_lecture_ingestion_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_LECTURE_INGESTION_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_course_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     onDelete="SET NULL" onUpdate="CASCADE"
                                     constraintName="fk_iris_settings_iris_course_chat_settings_id"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_faq_ingestion_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_FAQ_INGESTION_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_lecture_chat_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_LECTURE_CHAT_SETTINGS"/>
            <addForeignKeyConstraint baseTableName="iris_settings" baseColumnNames="iris_tutor_suggestion_settings_id"
                                     referencedTableName="iris_sub_settings" referencedColumnNames="id"
                                     onDelete="CASCADE"
                                     constraintName="FK_IRIS_SETTINGS_ON_IRIS_TUTOR_SUGGESTION_SETTINGS"/>

            <createIndex indexName="course_id" tableName="iris_settings" unique="true">
                <column name="course_id"/>
            </createIndex>
            <createIndex indexName="exercise_id" tableName="iris_settings" unique="true">
                <column name="exercise_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_CHAT_SETTINGS" tableName="iris_settings">
                <column name="iris_chat_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_COMPETENCY_GENERATION_SETTINGS" tableName="iris_settings">
                <column name="iris_competency_generation_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_FAQ_INGESTION_SETTINGS" tableName="iris_settings">
                <column name="iris_faq_ingestion_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_IRIS_LECTURE_INGESTION_SETTINGS" tableName="iris_settings">
                <column name="iris_lecture_ingestion_settings_id"/>
            </createIndex>
            <createIndex indexName="FK_IRIS_SETTINGS_ON_LECTURE_CHAT_SETTINGS" tableName="iris_settings">
                <column name="iris_lecture_chat_settings_id"/>
            </createIndex>
            <createIndex indexName="fk_iris_settings_iris_course_chat_settings_id" tableName="iris_settings">
                <column name="iris_course_chat_settings_id"/>
            </createIndex>

            <!-- PostgreSQL: Restore course settings - insert all 8 sub_settings types and link them -->
            <sql dbms="postgresql">
                WITH course_data AS (
                    SELECT course_id, settings, ROW_NUMBER() OVER (ORDER BY course_id) as rn
                    FROM course_iris_settings
                ),
                -- 1. PROGRAMMING_EXERCISE_CHAT (with migrated data)
                inserted_prog_chat AS (
                    INSERT INTO iris_sub_settings (enabled, rate_limit, rate_limit_timeframe_hours, selected_variant, custom_instructions, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT
                        (cd.settings->>'enabled')::boolean,
                        (cd.settings->'rateLimit'->>'requests')::int,
                        (cd.settings->'rateLimit'->>'timeframeHours')::int,
                        cd.settings->>'variant',
                        cd.settings->>'customInstructions',
                        'PROGRAMMING_EXERCISE_CHAT', false, false
                    FROM course_data cd ORDER BY cd.course_id
                    RETURNING id
                ),
                -- 2. TEXT_EXERCISE_CHAT
                inserted_text_chat AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'TEXT_EXERCISE_CHAT', false, false
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- 3. COURSE_CHAT
                inserted_course_chat AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'COURSE_CHAT', false, false
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- 4. LECTURE_INGESTION
                inserted_lecture_ingestion AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'LECTURE_INGESTION', true, false
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- 5. LECTURE_CHAT
                inserted_lecture_chat AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'LECTURE_CHAT', false, false
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- 6. FAQ_INGESTION
                inserted_faq_ingestion AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'FAQ_INGESTION', false, true
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- 7. COMPETENCY_GENERATION
                inserted_competency AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'COMPETENCY_GENERATION', false, false
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- 8. TUTOR_SUGGESTION
                inserted_tutor AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    SELECT false, 'default', 'TUTOR_SUGGESTION', false, false
                    FROM course_iris_settings ORDER BY course_id
                    RETURNING id
                ),
                -- Number all inserted rows
                n_prog AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_prog_chat),
                n_text AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_text_chat),
                n_course AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_course_chat),
                n_lec_ing AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_lecture_ingestion),
                n_lec_chat AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_lecture_chat),
                n_faq AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_faq_ingestion),
                n_comp AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_competency),
                n_tutor AS (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM inserted_tutor)
                INSERT INTO iris_settings (
                    iris_chat_settings_id, iris_text_exercise_chat_settings_id, iris_course_chat_settings_id,
                    iris_lecture_ingestion_settings_id, iris_lecture_chat_settings_id, iris_faq_ingestion_settings_id,
                    iris_competency_generation_settings_id, iris_tutor_suggestion_settings_id,
                    discriminator, course_id
                )
                SELECT
                    n_prog.id, n_text.id, n_course.id, n_lec_ing.id, n_lec_chat.id, n_faq.id, n_comp.id, n_tutor.id,
                    'COURSE', cd.course_id
                FROM course_data cd
                JOIN n_prog ON n_prog.rn = cd.rn
                JOIN n_text ON n_text.rn = cd.rn
                JOIN n_course ON n_course.rn = cd.rn
                JOIN n_lec_ing ON n_lec_ing.rn = cd.rn
                JOIN n_lec_chat ON n_lec_chat.rn = cd.rn
                JOIN n_faq ON n_faq.rn = cd.rn
                JOIN n_comp ON n_comp.rn = cd.rn
                JOIN n_tutor ON n_tutor.rn = cd.rn;
            </sql>

            <!-- MySQL: Restore course settings - Insert all 8 sub_settings types -->
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, rate_limit, rate_limit_timeframe_hours, selected_variant, custom_instructions, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT JSON_EXTRACT(settings, '$.enabled') = true,
                       CAST(NULLIF(JSON_UNQUOTE(JSON_EXTRACT(settings, '$.rateLimit.requests')), 'null') AS SIGNED),
                       CAST(NULLIF(JSON_UNQUOTE(JSON_EXTRACT(settings, '$.rateLimit.timeframeHours')), 'null') AS SIGNED),
                       JSON_UNQUOTE(JSON_EXTRACT(settings, '$.variant')),
                       NULLIF(JSON_UNQUOTE(JSON_EXTRACT(settings, '$.customInstructions')), 'null'),
                       'PROGRAMMING_EXERCISE_CHAT', false, false
                FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'TEXT_EXERCISE_CHAT', false, false FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'COURSE_CHAT', false, false FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'LECTURE_INGESTION', true, false FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'LECTURE_CHAT', false, false FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'FAQ_INGESTION', false, true FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'COMPETENCY_GENERATION', false, false FROM course_iris_settings ORDER BY course_id;
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                SELECT false, 'default', 'TUTOR_SUGGESTION', false, false FROM course_iris_settings ORDER BY course_id;
            </sql>

            <!-- MySQL: Insert iris_settings linking all 8 sub_settings for COURSE -->
            <sql dbms="mysql">
                INSERT INTO iris_settings (
                    iris_chat_settings_id, iris_text_exercise_chat_settings_id, iris_course_chat_settings_id,
                    iris_lecture_ingestion_settings_id, iris_lecture_chat_settings_id, iris_faq_ingestion_settings_id,
                    iris_competency_generation_settings_id, iris_tutor_suggestion_settings_id,
                    discriminator, course_id
                )
                SELECT
                    prog.id, text_ex.id, course.id, lec_ing.id, lec_chat.id, faq.id, comp.id, tutor.id,
                    'COURSE', cis.course_id
                FROM (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'PROGRAMMING_EXERCISE_CHAT') prog
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'TEXT_EXERCISE_CHAT') text_ex ON text_ex.rn = prog.rn
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'COURSE_CHAT') course ON course.rn = prog.rn
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'LECTURE_INGESTION') lec_ing ON lec_ing.rn = prog.rn
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'LECTURE_CHAT') lec_chat ON lec_chat.rn = prog.rn
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'FAQ_INGESTION') faq ON faq.rn = prog.rn
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'COMPETENCY_GENERATION') comp ON comp.rn = prog.rn
                JOIN (SELECT id, ROW_NUMBER() OVER (ORDER BY id) as rn FROM iris_sub_settings WHERE discriminator = 'TUTOR_SUGGESTION') tutor ON tutor.rn = prog.rn
                JOIN (SELECT course_id, ROW_NUMBER() OVER (ORDER BY course_id) as rn FROM course_iris_settings) cis ON cis.rn = prog.rn;
            </sql>

            <!-- MySQL: Create default GLOBAL settings with everything enabled -->
            <sql dbms="mysql">
                INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                VALUES
                    (true, 'default', 'default', 'PROGRAMMING_EXERCISE_CHAT', false, false),
                    (true, 'default', 'default', 'TEXT_EXERCISE_CHAT', false, false),
                    (true, 'default', 'default', 'COURSE_CHAT', false, false),
                    (true, 'default', 'default', 'LECTURE_INGESTION', true, false),
                    (true, 'default', 'default', 'LECTURE_CHAT', false, false),
                    (true, 'default', 'default', 'FAQ_INGESTION', false, true),
                    (true, 'default', 'default', 'COMPETENCY_GENERATION', false, false),
                    (true, 'default', 'default', 'TUTOR_SUGGESTION', false, false);
            </sql>
            <sql dbms="mysql">
                INSERT INTO iris_settings (
                    iris_chat_settings_id, iris_text_exercise_chat_settings_id, iris_course_chat_settings_id,
                    iris_lecture_ingestion_settings_id, iris_lecture_chat_settings_id, iris_faq_ingestion_settings_id,
                    iris_competency_generation_settings_id, iris_tutor_suggestion_settings_id,
                    discriminator
                )
                SELECT
                    (SELECT MAX(id) - 7 FROM iris_sub_settings),
                    (SELECT MAX(id) - 6 FROM iris_sub_settings),
                    (SELECT MAX(id) - 5 FROM iris_sub_settings),
                    (SELECT MAX(id) - 4 FROM iris_sub_settings),
                    (SELECT MAX(id) - 3 FROM iris_sub_settings),
                    (SELECT MAX(id) - 2 FROM iris_sub_settings),
                    (SELECT MAX(id) - 1 FROM iris_sub_settings),
                    (SELECT MAX(id) FROM iris_sub_settings),
                    'GLOBAL';
            </sql>

            <!-- PostgreSQL: Create default GLOBAL settings with everything enabled -->
            <sql dbms="postgresql">
                WITH
                inserted_global_prog AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'PROGRAMMING_EXERCISE_CHAT', false, false)
                    RETURNING id
                ),
                inserted_global_text AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'TEXT_EXERCISE_CHAT', false, false)
                    RETURNING id
                ),
                inserted_global_course AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'COURSE_CHAT', false, false)
                    RETURNING id
                ),
                inserted_global_lec_ing AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'LECTURE_INGESTION', true, false)
                    RETURNING id
                ),
                inserted_global_lec_chat AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'LECTURE_CHAT', false, false)
                    RETURNING id
                ),
                inserted_global_faq AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'FAQ_INGESTION', false, true)
                    RETURNING id
                ),
                inserted_global_comp AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'COMPETENCY_GENERATION', false, false)
                    RETURNING id
                ),
                inserted_global_tutor AS (
                    INSERT INTO iris_sub_settings (enabled, selected_variant, allowed_variants, discriminator, auto_ingest_on_lecture_attachment_upload, auto_ingest_on_faq_creation)
                    VALUES (true, 'default', 'default', 'TUTOR_SUGGESTION', false, false)
                    RETURNING id
                )
                INSERT INTO iris_settings (
                    iris_chat_settings_id, iris_text_exercise_chat_settings_id, iris_course_chat_settings_id,
                    iris_lecture_ingestion_settings_id, iris_lecture_chat_settings_id, iris_faq_ingestion_settings_id,
                    iris_competency_generation_settings_id, iris_tutor_suggestion_settings_id,
                    discriminator
                )
                SELECT
                    (SELECT id FROM inserted_global_prog),
                    (SELECT id FROM inserted_global_text),
                    (SELECT id FROM inserted_global_course),
                    (SELECT id FROM inserted_global_lec_ing),
                    (SELECT id FROM inserted_global_lec_chat),
                    (SELECT id FROM inserted_global_faq),
                    (SELECT id FROM inserted_global_comp),
                    (SELECT id FROM inserted_global_tutor),
                    'GLOBAL';
            </sql>

            <dropTable tableName="course_iris_settings"/>
        </rollback>
    </changeSet>

</databaseChangeLog>

<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="20240122000000" author="anzinger">
        <!-- rename tables from learning goal to competency -->
        <renameTable oldTableName="learning_goal" newTableName="competency"/>
        <renameTable oldTableName="learning_goal_relation" newTableName="competency_relation"/>
        <renameTable oldTableName="learning_goal_course" newTableName="competency_course"/>
        <renameTable oldTableName="learning_goal_exercise" newTableName="competency_exercise"/>
        <renameTable oldTableName="learning_goal_lecture_unit" newTableName="competency_lecture_unit"/>
        <renameTable oldTableName="learning_goal_user" newTableName="competency_user"/>

        <!-- rename columns from learning goal to competency -->
        <renameColumn tableName="competency_relation" oldColumnName="tail_learning_goal_id" newColumnName="tail_competency_id" columnDataType="bigint" />
        <renameColumn tableName="competency_relation" oldColumnName="head_learning_goal_id" newColumnName="head_competency_id" columnDataType="bigint" />
        <renameColumn tableName="competency_course" oldColumnName="learning_goal_id" newColumnName="competency_id" columnDataType="bigint" />
        <renameColumn tableName="competency_exercise" oldColumnName="learning_goal_id" newColumnName="competency_id" columnDataType="bigint" />
        <renameColumn tableName="competency_lecture_unit" oldColumnName="learning_goal_id" newColumnName="competency_id" columnDataType="bigint" />

        <!-- migrate competency relation type-column -->
        <renameColumn tableName="competency_relation" oldColumnName="type" newColumnName="type_old" columnDataType="varchar(31)" />
        <addColumn tableName="competency_relation">
            <column name="type" type="tinyint">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>
            UPDATE competency_relation r
            SET type = CASE
                    WHEN r.type_old = 'A' THEN 1
                    WHEN r.type_old = 'E' THEN 2
                    WHEN r.type_old = 'M' THEN 3
                    ELSE 0
                END
        </sql>

        <dropColumn tableName="competency_relation" columnName="type_old"/>
    </changeSet>
</databaseChangeLog>

<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="krusche" id="1560945129025">
        <createView viewName="view_tutor_leaderboard_assessments">select uuid() AS uuid, count(*) as assessments, sum(e.`max_score`) as points, u.id as user_id, u.first_name, c.id as course_id, c.title from jhi_user u, user_groups g, course c, exercise e, participation p, result r
            where g.`user_id` = u.id and g.`groups` = c.`teaching_assistant_group_name` and c.id = e.course_id and p.`exercise_id` = e.id and e.`discriminator` in ('M', 'T') and r.`participation_id` = p.id and r.`assessor_id` = u.id and r.`completion_date` is not null group by u.id, c.id</createView>
        <createView viewName="view_tutor_leaderboard_complaints">select uuid() AS uuid, count(*) as complaints, sum(e.`max_score`) as points, u.id as user_id, u.first_name, c.id as course_id, c.title from jhi_user u, user_groups g, course c, exercise e, participation p, result r, complaint cp
            where g.`user_id` = u.id and g.`groups` = c.`teaching_assistant_group_name` and c.id = e.course_id and p.`exercise_id` = e.id and e.`discriminator` in ('M', 'T') and r.`participation_id` = p.id and r.`assessor_id` = u.id and cp.`result_id` = r.id and cp.`accepted` = 1 and r.`completion_date` is not null group by u.id, c.id</createView>
        <createView viewName="view_tutor_leaderboard_complaint_responses">select uuid() AS uuid, count(*) as complaint_responses, sum(e.`max_score`) as points, u.id as user_id, u.first_name, c.id as course_id, c.title from jhi_user u, user_groups g, course c, exercise e, participation p, result r, complaint cp, complaint_response cr
            where g.`user_id` = u.id and g.`groups` = c.`teaching_assistant_group_name` and c.id = e.course_id and p.`exercise_id` = e.id and e.`discriminator` in ('M', 'T') and r.`participation_id` = p.id and r.`assessor_id` = u.id and cp.`result_id` = r.id and cp.id = cr.`complaint_id` and cp.`accepted` is not null and r.`completion_date` is not null group by u.id, c.id</createView>
    </changeSet>
</databaseChangeLog>

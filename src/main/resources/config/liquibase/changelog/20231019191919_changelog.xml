<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet id="20231019191919" author="morrien">
        <!-- Add new stuff -->
        <addColumn tableName="iris_sub_settings">
            <column name="discriminator" type="VARCHAR(31)"/>
            <column name="allowed_models" type="VARCHAR(2000)"/>
            <column name="chat_template_id" type="BIGINT"/>
            <column name="problem_statement_generation_template_id" type="BIGINT"/>
            <column name="solution_repo_generation_template_id" type="BIGINT"/>
            <column name="template_repo_generation_template_id" type="BIGINT"/>
            <column name="test_repo_generation_template_id" type="BIGINT"/>
        </addColumn>

        <addColumn tableName="iris_settings">
            <column name="exercise_id" type="BIGINT"/>
            <column name="course_id" type="BIGINT"/>
            <column name="current_version" type="INT"/>
            <column name="discriminator" type="VARCHAR(31)"/>
            <column name="enable_auto_update_chat" type="BOOLEAN"/>
            <column name="enable_auto_update_code_editor" type="BOOLEAN"/>
            <column name="enable_auto_update_hestia" type="BOOLEAN"/>
            <column name="iris_code_editor_settings_id" type="BIGINT"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="course_id" baseTableName="iris_settings"
                                 constraintName="FK_IRIS_SETTINGS_ON_COURSE" referencedColumnNames="id"
                                 referencedTableName="course"/>
        <addForeignKeyConstraint baseColumnNames="exercise_id" baseTableName="iris_settings"
                                 constraintName="FK_IRIS_SETTINGS_ON_EXERCISE" referencedColumnNames="id"
                                 referencedTableName="exercise"/>
        <addForeignKeyConstraint baseColumnNames="iris_code_editor_settings_id" baseTableName="iris_settings"
                                 constraintName="FK_IRIS_SETTINGS_ON_IRIS_CODE_EDITOR_SETTINGS"
                                 referencedColumnNames="id" referencedTableName="iris_sub_settings"/>
        <addForeignKeyConstraint baseColumnNames="chat_template_id" baseTableName="iris_sub_settings"
                                 constraintName="FK_IRIS_SUB_SETTINGS_ON_CHATTEMPLATE" referencedColumnNames="id"
                                 referencedTableName="iris_template"/>
        <addForeignKeyConstraint baseColumnNames="problem_statement_generation_template_id"
                                 baseTableName="iris_sub_settings"
                                 constraintName="FK_IRIS_SUB_SETTINGS_ON_PROBLEMSTATEMENTGENERATIONTEMPLATE"
                                 referencedColumnNames="id" referencedTableName="iris_template"/>
        <addForeignKeyConstraint baseColumnNames="solution_repo_generation_template_id"
                                 baseTableName="iris_sub_settings"
                                 constraintName="FK_IRIS_SUB_SETTINGS_ON_SOLUTIONREPOGENERATIONTEMPLATE"
                                 referencedColumnNames="id" referencedTableName="iris_template"/>
        <addForeignKeyConstraint baseColumnNames="template_repo_generation_template_id"
                                 baseTableName="iris_sub_settings"
                                 constraintName="FK_IRIS_SUB_SETTINGS_ON_TEMPLATEREPOGENERATIONTEMPLATE"
                                 referencedColumnNames="id" referencedTableName="iris_template"/>
        <addForeignKeyConstraint baseColumnNames="test_repo_generation_template_id" baseTableName="iris_sub_settings"
                                 constraintName="FK_IRIS_SUB_SETTINGS_ON_TESTREPOGENERATIONTEMPLATE"
                                 referencedColumnNames="id" referencedTableName="iris_template"/>
        <!-- Set discriminators -->
        <sql>
            UPDATE iris_settings SET discriminator = 'GLOBAL' WHERE id IN (SELECT id FROM iris_settings WHERE is_global = TRUE);
            UPDATE iris_settings SET discriminator = 'COURSE' WHERE id IN (SELECT iris_settings_id FROM course WHERE iris_settings_id IS NOT NULL);
            UPDATE iris_settings SET discriminator = 'EXERCISE' WHERE id IN (SELECT iris_settings_id FROM programming_exercise_details WHERE iris_settings_id IS NOT NULL);

            UPDATE iris_sub_settings SET discriminator = 'CHAT' WHERE id IN (SELECT iris_chat_settings_id FROM iris_settings WHERE iris_chat_settings_id IS NOT NULL);
            UPDATE iris_sub_settings SET discriminator = 'HESTIA' WHERE id IN (SELECT iris_hestia_settings_id FROM iris_settings WHERE iris_hestia_settings_id IS NOT NULL);
        </sql>

        <!-- drop old stuff -->
        <dropForeignKeyConstraint baseTableName="course" constraintName="fk_course_on_iris_settings"/>
        <dropForeignKeyConstraint baseTableName="programming_exercise_details"
                                  constraintName="fk_programming_exercise_details_on_iris_settings"/>
        <dropColumn columnName="iris_settings_id" tableName="course"/>
        <dropColumn columnName="iris_settings_id" tableName="programming_exercise_details"/>
        <dropColumn columnName="is_global" tableName="iris_settings"/>
    </changeSet>
</databaseChangeLog>

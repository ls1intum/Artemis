<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.18.xsd">
    <changeSet author="baboci" id="20230504123000">
        <comment>Delete conversations, posts, answer posts, and reactions for deleted courses</comment>
        <sql>
            DELETE r2, r1
            FROM conversation c
            LEFT JOIN post p ON c.id = p.conversation_id
            LEFT JOIN reaction r2 ON p.id = r2.post_id
            LEFT JOIN answer_post ap ON p.id = ap.post_id
            LEFT JOIN reaction r1 ON ap.id = r1.answer_post_id
            WHERE c.course_id NOT IN (SELECT id FROM course);
        </sql>
        <sql>
            DELETE ap
            FROM conversation c
            LEFT JOIN post p ON p.conversation_id = c.id
            LEFT JOIN answer_post ap ON ap.post_id = p.id
            WHERE c.course_id NOT IN (SELECT id FROM course);
        </sql>
        <sql>
            DELETE p
            FROM conversation c
            LEFT JOIN post p ON p.conversation_id = c.id
            WHERE c.course_id NOT IN (SELECT id FROM course);
        </sql>
        <sql>
            DELETE cp
            FROM conversation c
            LEFT JOIN conversation_participant cp ON c.id = cp.conversation_id
            WHERE c.course_id NOT IN (SELECT id FROM course);
        </sql>
        <sql>
            DELETE FROM conversation
            WHERE course_id NOT IN (SELECT id FROM course);
        </sql>
        <addForeignKeyConstraint baseTableName="conversation" baseColumnNames="course_id" constraintName="FK_course_id" referencedTableName="course"
                                 referencedColumnNames="id" validate="true" deferrable="false" initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT" />
    </changeSet>
</databaseChangeLog>

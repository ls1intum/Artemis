<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.18.xsd">
    <changeSet author="baboci" id="20230504123000">
        <comment>Delete conversations, posts, answer posts, and reactions for deleted courses</comment>
        <sql>
            DELETE FROM reaction
            WHERE post_id IN (
                SELECT id FROM post
                WHERE conversation_id IN (
                    SELECT id FROM conversation
                    WHERE course_id NOT IN (
                        SELECT id FROM course
                    )
                )
            );
        </sql>
        <sql>
            DELETE FROM reaction
            WHERE answer_post_id IN (
                SELECT id FROM answer_post
                WHERE post_id IN (
                    SELECT id FROM post
                    WHERE conversation_id IN (
                        SELECT id FROM conversation
                        WHERE course_id NOT IN (
                            SELECT id FROM course
                        )
                    )
                )
            );
        </sql>
        <sql>
            DELETE FROM answer_post
            WHERE post_id IN (
                SELECT id FROM post
                WHERE conversation_id IN (
                    SELECT id FROM conversation
                    WHERE course_id NOT IN (
                        SELECT id FROM course
                    )
                )
            );
        </sql>
        <sql>
            DELETE FROM post
            WHERE conversation_id IN (
                SELECT id FROM conversation
                WHERE course_id NOT IN (
                    SELECT id FROM course
                )
            );
        </sql>
        <sql>
            DELETE from conversation_participant
            WHERE conversation_id IN (
                SELECT id FROM conversation
                WHERE course_id NOT IN (
                    SELECT id FROM course
                )
            );
        </sql>
        <sql>
            DELETE FROM conversation
            WHERE course_id NOT IN (
                SELECT id FROM course
            );
        </sql>

        <addForeignKeyConstraint baseTableName="conversation" baseColumnNames="course_id" constraintName="FK_course_id" referencedTableName="course"
                                 referencedColumnNames="id" validate="true" deferrable="false" initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT" />
    </changeSet>
</databaseChangeLog>

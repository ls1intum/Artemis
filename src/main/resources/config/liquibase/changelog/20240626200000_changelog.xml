<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet id="20240626200000_1" author="bbesrour">
        <!-- Create the new build_job_config table -->
        <createTable tableName="programming_exercise_build_config">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="sequential_test_runs" type="BOOLEAN"/>
            <column name="branch" type="VARCHAR(128)"/>
            <column name="build_plan_configuration" type="longtext"/>
            <column name="build_script" type="longtext"/>
            <column name="checkout_solution_repository" type="BOOLEAN"/>
            <column name="checkout_path" type="VARCHAR(128)"/>
            <column name="timeout_seconds" type="INT"/>
            <column name="docker_flags" type="VARCHAR(255)"/>
            <column name="common_key_id" type="BIGINT"/>
            <column name="static_code_analysis_enabled" type="BOOLEAN"/>
            <column name="max_static_code_analysis_penalty" type="INT"/>
            <column name="project_type" type="INT"/>
            <column name="testwise_coverage_enabled" type="BOOLEAN"/>
        </createTable>

        <!-- Add a new column to the programming_exercise table to reference the programming_exercise_build_config -->
        <addColumn tableName="programming_exercise_details">
            <column name="programming_exercise_build_config_id" type="BIGINT"/>
        </addColumn>


        <!-- Add foreign key constraint, on delete cascade -->
        <addForeignKeyConstraint baseTableName="programming_exercise_details"
                                 baseColumnNames="programming_exercise_build_config_id"
                                 referencedTableName="programming_exercise_build_config"
                                 referencedColumnNames="id"
                                 constraintName="fk_programming_exercise_build_config"
                                 onDelete="CASCADE"/>

        <rollback>
            <dropForeignKeyConstraint baseTableName="programming_exercise_details" constraintName="fk_programming_exercise_build_config"/>
            <dropColumn tableName="programming_exercise_details" columnName="programming_exercise_build_config_id"/>
            <dropTable tableName="programming_exercise_build_config"/>
        </rollback>

    </changeSet>
    <!-- Move data from programming_exercise to programming_exercise_build_config and remove the column from programming_exercise -->
    <changeSet id="20240626200000_2" author="bbesrour">
        <sql>
            INSERT INTO programming_exercise_build_config (sequential_test_runs, branch, build_plan_configuration, build_script, checkout_solution_repository, common_key_id, static_code_analysis_enabled, max_static_code_analysis_penalty, project_type, testwise_coverage_enabled)
            SELECT exercise.sequential_test_runs, programming_exercise_details.branch, programming_exercise_details.build_plan_configuration, programming_exercise_details.build_script, programming_exercise_details.checkout_solution_repository, exercise.id, programming_exercise_details.static_code_analysis_enabled, programming_exercise_details.max_static_code_analysis_penalty, programming_exercise_details.project_type, programming_exercise_details.testwise_coverage_enabled
            FROM exercise JOIN programming_exercise_details ON exercise.id = programming_exercise_details.id
            WHERE exercise.discriminator = 'P';

            UPDATE programming_exercise_details SET programming_exercise_build_config_id = (
                SELECT id
                FROM programming_exercise_build_config
                WHERE common_key_id = programming_exercise_details.id
            );

            ALTER TABLE exercise DROP COLUMN sequential_test_runs;
            ALTER TABLE programming_exercise_details DROP COLUMN branch;
            ALTER TABLE programming_exercise_details DROP COLUMN build_plan_configuration;
            ALTER TABLE programming_exercise_details DROP COLUMN build_script;
            ALTER TABLE programming_exercise_details DROP COLUMN checkout_solution_repository;
            ALTER TABLE programming_exercise_details DROP COLUMN static_code_analysis_enabled;
            ALTER TABLE programming_exercise_details DROP COLUMN max_static_code_analysis_penalty;
            ALTER TABLE programming_exercise_details DROP COLUMN project_type;
            ALTER TABLE programming_exercise_details DROP COLUMN testwise_coverage_enabled;
--            ALTER TABLE programming_exercise_build_config DROP COLUMN common_key_id;
        </sql>
    </changeSet>
</databaseChangeLog>

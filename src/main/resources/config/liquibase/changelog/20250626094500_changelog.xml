<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="20250626094500-1" author="Alphar">
        <createTable tableName="exercise_version">
            <!-- Common fields -->
            <column autoIncrement="true" name="id" type="bigint">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="author_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="exercise_id" type="bigint">
                <constraints nullable="false" />
            </column>
            
            <!-- Differential versioning fields -->
            <column name="version_type" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="previous_version_id" type="bigint">
                <constraints nullable="true" />
            </column>
            <column name="content_json" type="json">
                <constraints nullable="false" />
            </column>
            <column name="content_hash" type="varchar(64)">
                <constraints nullable="true" />
            </column>

            <!-- Auditing fields -->
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="created_date" type="datetime(3)">
                <constraints nullable="false" />
            </column>
            <column name="last_modified_by" type="varchar(50)" />
            <column name="last_modified_date" type="datetime(3)" />

        </createTable>

        <!-- Create indexes for performance -->
        <createIndex indexName="idx_exercise_versions"
            tableName="exercise_version">
            <column name="exercise_id" />
            <column name="created_date" descending="true" />
        </createIndex>
        
        <createIndex indexName="idx_version_chain"
            tableName="exercise_version">
            <column name="previous_version_id" />
        </createIndex>

        <!-- Add foreign key constraints -->
        <addForeignKeyConstraint baseColumnNames="author_id"
            baseTableName="exercise_version"
            constraintName="fk_exercise_version_author"
            referencedColumnNames="id"
            referencedTableName="jhi_user" />

        <addForeignKeyConstraint baseColumnNames="exercise_id"
            baseTableName="exercise_version"
            constraintName="fk_exercise_version_exercise"
            referencedColumnNames="id"
            referencedTableName="exercise"
            onDelete="CASCADE" />
            
        <addForeignKeyConstraint baseColumnNames="previous_version_id"
            baseTableName="exercise_version"
            constraintName="fk_exercise_version_previous"
            referencedColumnNames="id"
            referencedTableName="exercise_version" />
    </changeSet>


</databaseChangeLog>
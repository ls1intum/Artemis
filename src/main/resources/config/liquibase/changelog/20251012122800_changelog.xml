<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="20250818094500" author="Alphar">
        <createTable tableName="exercise_version">
            <!-- Common fields -->
            <column autoIncrement="true" name="id" type="bigint">
                <constraints primaryKey="true" nullable="false" />
            </column>
            <column name="author_id" type="bigint" >
                <constraints nullable="false"/>

            </column>
            <column name="exercise_id" type="bigint">
                <constraints nullable="false"/>

            </column>
            <column name="exercise_snapshot" type="json">
                <constraints nullable="false" />
            </column>
            <!-- Auditing fields -->
            <column name="created_by" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="created_date" type="datetime(3)">
                <constraints nullable="false" />
            </column>
            <column name="last_modified_by" type="varchar(50)" />
            <column name="last_modified_date" type="datetime(3)" />


        </createTable>

        <!-- Create indexes -->
        <!-- Composite index for efficient querying of latest version per exercise -->
        <createIndex indexName="idx_exercise_version_exercise_id_created_date"
            tableName="exercise_version">
            <column name="exercise_id" />
            <column name="created_date" descending="true" />
        </createIndex>

        <!-- Index on created_date for general chronological queries -->
        <createIndex indexName="idx_exercise_version_created_date"
            tableName="exercise_version">
            <column name="created_date" />
        </createIndex>

        <!-- Add foreign key constraints -->
        <addForeignKeyConstraint
            baseColumnNames="author_id"
            baseTableName="exercise_version"
            constraintName="fk_exercise_version_author_id"
            deferrable="false"
            initiallyDeferred="false"
            onDelete="RESTRICT"
            referencedColumnNames="id"
            referencedTableName="jhi_user"
            validate="true"
        />

        <addForeignKeyConstraint baseColumnNames="exercise_id"
            baseTableName="exercise_version"
            constraintName="fk_exercise_version_exercise_id"
            referencedColumnNames="id"
            referencedTableName="exercise"
            onDelete="CASCADE" />

    </changeSet>


</databaseChangeLog>

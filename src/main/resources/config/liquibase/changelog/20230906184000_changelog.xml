<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
    <changeSet author="erik" id="20230812135300">
        <comment>
            Create the table to store multiple paths with a file submission
            instead of only one and copy the old paths into the new table.
        </comment>
        <createTable tableName="file_submission_paths">
            <column name="submission_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="path" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="file_submission_paths" indexName="file_submission_paths_submission_id">
            <column name="submission_id" />
        </createIndex>
        <addForeignKeyConstraint baseColumnNames="submission_id" baseTableName="file_submission_paths" constraintName="fk_file_submission_paths_submission_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="id" referencedTableName="submission" validate="true"/>
        <comment>
            All file names in the new file_submission_paths table start with a hash that uniquely identifies their content.
            So {directory}/{nameAndExtension} becomes {directory}/{hash}_{nameAndExtension} and hash is 0000 in this case.
            nocheckin: old submissions will never be deleted
        </comment>
        <sql>
            INSERT INTO file_submission_paths (submission_id, path)
            SELECT id, CONCAT('0000_', file_path)
            FROM submission WHERE discriminator = 'F'
        </sql>
        <comment>
            Drop the old column only after the data has been migrated.
        </comment>
        <dropColumn tableName="submission" columnName="file_path"/>
    </changeSet>
</databaseChangeLog>

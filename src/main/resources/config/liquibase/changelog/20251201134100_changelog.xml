<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="20251201134100-multiple-docker-containers"
               author="erik stern">
        <!-- Add the ability to save multiple container configs. -->
        <createTable tableName="docker_container_config">
            <column autoIncrement="true" name="id" type="bigint">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="config_name" type="varchar(128)">
                <constraints nullable="false"/>
            </column>
            <column name="build_plan_configuration" type="longtext"/>
            <column name="build_script" type="longtext"/>
            <column name="docker_flags" type="longtext"/>
            <column name="build_config_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Ensure container names are unique within each exercise (build_config_id = exercise's build configuration) -->
        <addUniqueConstraint tableName="docker_container_config"
                             columnNames="build_config_id, config_name"
                             constraintName="uk_docker_container_config_name"/>

        <addForeignKeyConstraint baseTableName="docker_container_config"
                                 baseColumnNames="build_config_id"
                                 constraintName="fk_docker_container_build_config_id"
                                 referencedTableName="programming_exercise_build_config"
                                 referencedColumnNames="id" onDelete="CASCADE"/>

        <!-- Migrate existing per-exercise build config into the first container of each exercise -->
        <sql>
            INSERT INTO docker_container_config (config_name, build_plan_configuration, build_script, docker_flags, build_config_id)
            SELECT 'Container 1', bc.build_plan_configuration, bc.build_script, bc.docker_flags, bc.id
            FROM programming_exercise_build_config bc
        </sql>

        <!-- Remember container id in the build job. -->
        <addColumn tableName="build_job">
            <column name="container_id" type="bigint" />
        </addColumn>

        <!-- Add container name to build log entries to track which container produced which logs.
             We store the name instead of a foreign key to container_id to preserve the container name
             even if the container configuration is deleted after the log was created. -->
        <addColumn tableName="build_log_entry">
            <column name="container_name" type="varchar(128)" />
        </addColumn>

        <!-- Store expected container count to prevent mid-submission config changes from affecting aggregation -->
        <addColumn tableName="submission">
            <column name="expected_container_count" type="int" />
        </addColumn>

        <dropColumn tableName="programming_exercise_build_config"
                    columnName="build_plan_configuration"/>
        <dropColumn tableName="programming_exercise_build_config"
                    columnName="build_script"/>
        <dropColumn tableName="programming_exercise_build_config"
                    columnName="docker_flags"/>


        <rollback>
            <addColumn tableName="programming_exercise_build_config">
                <column name="build_plan_configuration" type="longtext"/>
                <column name="build_script" type="longtext"/>
                <column name="docker_flags" type="longtext"/>
            </addColumn>

            <!-- Copy back the first container's config per exercise. If multiple containers were added,
                 only the one with the lowest id is used; the rest are lost on rollback. -->
            <sql>
                UPDATE programming_exercise_build_config
                SET build_plan_configuration = (SELECT dcc.build_plan_configuration FROM docker_container_config dcc WHERE dcc.build_config_id = programming_exercise_build_config.id ORDER BY dcc.id LIMIT 1),
                    build_script = (SELECT dcc.build_script FROM docker_container_config dcc WHERE dcc.build_config_id = programming_exercise_build_config.id ORDER BY dcc.id LIMIT 1),
                    docker_flags = (SELECT dcc.docker_flags FROM docker_container_config dcc WHERE dcc.build_config_id = programming_exercise_build_config.id ORDER BY dcc.id LIMIT 1);
            </sql>

            <dropForeignKeyConstraint baseTableName="docker_container_config"
                                     constraintName="fk_docker_container_build_config_id"/>

            <dropTable tableName="docker_container_config"/>

            <dropColumn tableName="build_job" columnName="container_id" />
            <dropColumn tableName="build_log_entry" columnName="container_name" />
            <dropColumn tableName="submission" columnName="expected_container_count" />
        </rollback>
    </changeSet>

</databaseChangeLog>

api: v0.0.1
metadata:
  name: "Dart"
  id: dart
  description: "Default build configuration for Dart exercises with static code analysis"
actions:
  - name: install_student_dependencies
    script: |-
      cd "${studentParentWorkingDirectoryName}"
      dart pub get
  - name: install_dependencies
    script: |-
      cd "${testWorkingDirectory}"
      dart pub get
  - name: syntax_check
    script: |-
      # Check for compilation errors in the student code
      dart analyze --fatal-errors "${studentParentWorkingDirectoryName}"
      COMPILATION_EXIT_CODE=$?

      if [ $COMPILATION_EXIT_CODE -ne 0 ]; then
          exit 1
      fi
  - name: static_code_analysis
    script: dart analyze --format=json "${studentParentWorkingDirectoryName}" | analyze_sarif --srcroot "${studentParentWorkingDirectoryName}" --output 'dart_analyze.sarif'
    results:
      - name: dart analyze issues
        path: dart_analyze.sarif
        type: sca
  - name: test
    script: |-
      cd "${testWorkingDirectory}"
      # Run the tests
      dart test --reporter=json | tojunit | xmlstarlet ed -d '//failure/@message' -d '//error/@message' > report.xml || true
    results:
      - name: Minitest Test Results
        path: "${testWorkingDirectory}/report.xml"
        type: junit

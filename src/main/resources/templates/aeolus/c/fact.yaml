api: v0.0.1
metadata:
    name: c with fact
    id: c-windfile
    description: This is a windfile for c exercises using fact
    author: Andreas Resch
    docker:
        image: sharingcodeability/fact
        tag: latest
        volumes:
            - ${WORKDIR}:${WORKDIR}
            - ${TMPDIR}:${TMPDIR}
        parameters:
            - --cpus
            - '"2"'
            - --memory
            - '"2g"'
            - --memory-swap
            - '"2g"'
            - --pids-limit
            - '"1000"'
actions:
    - name: setup_the_build_environment
      script: |
        #!/usr/bin/env bash

        # ------------------------------
        # Task Description:
        # Build and run all tests
        # ------------------------------

        # Updating assignment and test-reports ownership...
        sudo chown artemis_user:artemis_user assignment/ -R
        sudo rm -rf test-reports
        sudo mkdir test-reports
        sudo chown artemis_user:artemis_user test-reports/ -R
      run_always: false
    - name: build_and_run_all_tests
      script: |
        #!/usr/bin/env bash
        # ------------------------------
        # Task Description:
        # Build and run all tests
        # ------------------------------

        rm -f assignment/GNUmakefile
        rm -f assignment/Makefile
        cp -f tests/Makefile assignment/Makefile || exit 2


        cd tests
        python3 Tests.py
        sudo rm Tests.py
        rm -rf ./tests
        exit 0
      run_always: false
    - name: junit
      parameters:
          ignore_time: false
          test_results: test-reports/*results.xml
      platform: bamboo
      kind: junit
      run_always: true
    - name: cleanup
      script: |
        sudo rm -rf tests/
        sudo rm -rf assignment/
        sudo rm -rf test-reports/'
      run_always: true

api: v0.0.1
metadata:
  name: "R Static"
  id: r_static
  description: "Default build configuration for R exercises with static code analysis"
actions:
  - name: syntax_check
    script: |-
      # Check for syntax errors in the student code
      Rscript -e 'files <- list.files("${studentParentWorkingDirectoryName}", pattern="\\.R$", recursive=TRUE, full.names=TRUE); for (f in files) { tryCatch(parse(f), error=function(e) { cat(conditionMessage(e), "\n"); quit(status=1) }) }'
      COMPILATION_EXIT_CODE=$?

      if [ $COMPILATION_EXIT_CODE -ne 0 ]; then
          exit 1
      fi
  - name: install
    script: Rscript -e 'remotes::install_local()'
  - name: static_code_analysis
    script: Rscript -e 'lints <- lintr::lint_package("./assignment"); lintr::sarif_output(lints, "lintr_results.sarif")'
    results:
      - name: lintr Results
        path: "lintr_results.sarif"
        type: sca
  - name: run_all_tests
    script: |-
      # Run the tests
      Rscript -e 'library("testthat"); options(testthat.output_file = "junit.xml"); test_local(".", reporter = "junit")' || true
    results:
      - name: junit
        path: tests/testthat/junit.xml
        type: junit

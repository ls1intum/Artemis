api: v0.0.1
metadata:
    name: swift regular runs
    id: swift-windfile
    description: Build Plan for Swift Exercises
    docker:
        image: ls1tum/artemis-swift-swiftlint-docker
        tag: latest
        volumes:
            - ${WORKDIR}:${WORKDIR}
            - ${TMPDIR}:${TMPDIR}
        parameters:
            - --cpus
            - '"2"'
            - --memory
            - '"2g"'
            - --memory-swap
            - '"2g"'
            - --pids-limit
            - '"1000"'
actions:
    - name: build_and_test_the_code
      script: |
          # Delete possible old Sources and replace with student's assignment Sources
          rm -rf Sources
          mv assignment/Sources .
          # Delete and create the assignment directory from scratch
          rm -rf assignment
          mkdir assignment
          cp -R Sources assignment
          # copy test files
          cp -R Tests assignment
          cp Package.swift assignment

          # In order to get the correct console output we need to execute the command within the assignment directory
          # swift build
          cd assignment
          swift build || error=true

          if [ ! $error ]
          then
              # swift test
              swift test || true
          fi

          # The used docker container is calling 'swift build' which creates files as root (e.g. tests.xml),
          # so we need to allow bamboo to access these files
          chmod -R 777 ${WORKDIR}
      runAlways: false
    - name: junit
      parameters:
          ignore_time: false
          test_results: '**/tests.xml'
      platform: bamboo
      kind: junit
      runAlways: true

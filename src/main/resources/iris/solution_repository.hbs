{{#system~}}The following is a work-in-progress programming exercise.{{~/system}}

{{#system~}}The problem statement:{{~/system}}
{{#user~}}{{problemStatement}}{{~/user}}
{{#system~}}End of problem statement.{{~/system}}

{{#system~}}The template repository:{{~/system}}
{{#each templateRepository}}
    {{#system~}}"{{@key}}":{{~/system}}
    {{#user~}}{{this}}{{~/user}}
{{/each}}
{{#system~}}End of template repository.{{~/system}}

{{set 'softExclude' ["AttributeTest.java", "ClassTest.java", "MethodTest.java", "ConstructorTest.java"]}}
{{#system~}}The test repository:{{~/system}}
{{#each testRepository}}
    {{#system~}}"{{@key}}":{{~/system}}
    {{set 'shouldshow' True}}
    {{set 'tempfile' @key}}
    {{#each softExclude}}
        {{#if (contains tempfile this)}}
            {{set 'shouldshow' False}}
        {{/if}}
    {{/each}}
    {{#user~}}{{#if shouldshow}}{{this}}{{else}}Content omitted for brevity{{/if}}{{~/user}}
{{/each}}
{{#system~}}End of test repository.{{~/system}}

{{#system~}}
    The solution repository serves as a sample correct implementation of the exercise.
    It is the natural continuation of the template repository following the problem statement, and should pass all the tests.
    It is not visible to the students.
{{~/system}}

{{#system~}}The solution repository:{{~/system}}
{{#each solutionRepository}}
    {{#system~}}"{{@key}}":{{~/system}}
    {{#user~}}{{this}}{{~/user}}
{{/each}}
{{#system~}}End of solution repository.{{~/system}}

{{#system~}}You have told the instructor that you will do the following:{{~/system}}
{{#assistant~}}{{instructions}}{{~/assistant}}

{{#geneach 'changes' num_iterations=10 hidden=True}}
    {{#system~}}
        You are now editing the solution repository.
        {{#if (not @first)}}
            So far, you have made the following changes:
            {{#each changes}}
                {{#if (equal this.type 'create')}}
                    Created '{{this.path}}':
                    {{this.content}}
                {{/if}}
                {{#if (equal this.type 'rename')}}
                    Renamed '{{this.path}}' to '{{this.updated}}'
                {{/if}}
                {{#if (equal this.type 'delete')}}
                    Deleted '{{this.path}}'
                {{/if}}
                {{#if (equal this.type 'modify')}}
                    In {{this.path}}: Replaced '{{this.original}}' with '{{this.updated}}'
                {{/if}}
                {{#if (equal this.type 'overwrite')}}
                    In '{{this.path}}': Replaced all content with {{this.updated}}
                {{/if}}
            {{/each}}
        {{/if}}
        Would you like to create a new file, or modify, rename, or delete an existing file?
        Respond with either "create", "modify", "rename", or "delete".
        {{#if (not @first)}}
            Alternatively, if you have no other changes you would like to make, respond with the special response "!done!".
        {{/if}}
    {{~/system}}
    {{#assistant~}}{{gen 'this.type' temperature=0.0 max_tokens=4}}{{~/assistant}}

    {{#if (contains this.type "!done!")}}
        {{break}}
    {{/if}}

    {{#system~}}
        What file would you like to {{this.type}}?
        State the full path of the file, without quotation marks, justification, or any other text.
        For example, for the hypothetical file "path/to/file/File.txt", you would respond:
    {{~/system}}
    {{#assistant~}}path/to/file/File.txt{{~/assistant}}
    {{#system~}}Exactly. So, what file would you like to {{this.type}}?{{~/system}}
    {{#assistant~}}{{gen 'this.path' temperature=0.0 max_tokens=50}}{{~/assistant}}

    {{#if (not (equal this.type 'create'))}}
        {{#if (not (contains solutionRepository this.path))}}
            {{set 'this.retry' True}}
            {{#system~}}
                The file you specified does not exist in the solution repository.
                As a refresher, here are the paths of all files in the solution repository:
            {{~/system}}
            {{#user~}}
                {{#each solutionRepository}}
                    {{@key}}
                {{/each}}
            {{~/user}}
            {{#system~}}
                Now respond with the actual full path of the file you would like to change.
            {{~/system}}
            {{#assistant~}}{{gen 'this.path' temperature=0.0 max_tokens=50}}{{~/assistant}}
        {{/if}}
        {{#if (not (contains solutionRepository this.path))}}
            {{set 'this.failed' True}}
            {{break}}
        {{/if}}
    {{/if}}

    {{#if (equal this.type 'create')}}
        {{#system~}}
            Now respond with the raw content of the new file {{this.path}}.
            Do not surround your response with quotation marks, backticks, or any other formatting characters.
        {{~/system}}
        {{#assistant~}}{{gen 'this.content' temperature=0.5 max_tokens=1000}}{{~/assistant}}
    {{/if}}
    {{#if (equal this.type 'rename')}}
        {{#system~}}Now respond with the new full path of the file {{this.path}}.{{~/system}}
        {{#assistant~}}{{gen 'this.updated' temperature=0.5 max_tokens=50}}{{~/assistant}}
    {{/if}}
    {{#if (equal this.type 'modify')}}
        {{#system~}}
            You will now identify a part of the file '{{this.path}}' to replace.
            It is very important that you respond with an exact quote from the file, without quotation marks, and say nothing else.
            If you want to replace the entire content, respond with the special response "!all!".
            Do not select the same part of the file twice.
            Here is the current state of the file from which you may select a part to replace:
        {{~/system}}
        {{#user~}}
            {{#each solutionRepository}}
                {{#if (equal @key this.path)}}
                    {{this}}
                {{/if}}
            {{/each}}
        {{~/user}}
        {{#assistant~}}{{gen 'this.original' temperature=0.0 max_tokens=1000}}{{~/assistant}}
        {{#if (equal this.original '!all!')}}
            {{set 'this.type' 'overwrite'}}
        {{/if}}
        {{#system~}}
            Now respond with the updated content.
            Do not surround your response with quotation marks, backticks, or any other formatting characters.
        {{~/system}}
        {{#assistant~}}{{gen 'this.updated' temperature=0.5 max_tokens=1000}}{{~/assistant}}
    {{/if}}
{{/geneach}}
